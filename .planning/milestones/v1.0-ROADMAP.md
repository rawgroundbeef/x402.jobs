# Roadmap: Prompt Template Resources

**Created:** 2026-01-19
**Pivoted:** 2026-01-19 (server-side execution)
**Depth:** Comprehensive (5 phases)
**Coverage:** 33/33 v1 requirements mapped

## Overview

This roadmap delivers the Prompt Template Resources feature in 5 phases, following the natural build order: database foundation, creator UI (with API key), server-side execution, caller UI, and payment integration. Each phase delivers a coherent, verifiable capability that unblocks the next.

> **Architecture:** Server-side execution with creator's encrypted API key. Follows existing `prompt` resource type pattern. Callers pay via x402, server executes Claude call, caller receives streamed response.

## Phases

### Phase 1: Database Schema + Resource Type

**Goal:** Prompt templates can be stored and retrieved as a new resource type.

**Dependencies:** None (foundation phase)

**Plans:** 2 plans

Plans:

- [x] 01-01-PLAN.md — TypeScript types and Zod schemas for prompt templates
- [x] 01-02-PLAN.md — SQL migration and documentation for database schema

**Requirements:**

- DATA-01: New resource type `prompt_template` added to resource types
- DATA-02: Prompt template stores system_prompt (creator's IP, never exposed to callers)
- DATA-03: Prompt template stores parameters array with name, description, required, default
- DATA-04: Prompt template stores model (hardcoded to claude-sonnet-4-20250514 for v1)
- DATA-05: Prompt template stores max_tokens setting
- DATA-06: Prompt template stores allows_user_message flag for system+user mode

**Success Criteria:**

1. `prompt_templates` table exists with all required columns (system_prompt, parameters, model, max_tokens, allows_user_message)
2. Resources can be created with `resource_type: 'prompt_template'` and linked to a prompt_templates row
3. RLS policies prevent non-owners from reading system_prompt content
4. TypeScript types exist for PromptTemplate matching the database schema

**Notes:**

- User runs migrations manually
- Model hardcoded to claude-sonnet-4-20250514 for v1

---

### Phase 2: Creator Template Definition UI + API Key

**Goal:** Creators can define, configure, and publish prompt template resources with their Claude API key.

**Dependencies:** Phase 1 (database schema must exist)

**Status:** Complete (2026-01-19)

**Plans:** 4 plans

Plans:

- [x] 02-01-PLAN.md — Extend CreateResourceModal with prompt template type selection and basic form fields
- [x] 02-02-PLAN.md — System prompt editor with tag awareness and parameter management
- [x] 02-03-PLAN.md — Edit mode support for prompt templates
- [x] 02-04-PLAN.md — Claude API key integration (user-level, Dashboard > Integrations)

**Requirements:**

- CRTR-01: Creator can select "Prompt Template" when creating a new resource
- CRTR-02: Creator can enter template name, description, and image
- CRTR-03: Creator can write system prompt in a dedicated editor
- CRTR-04: Editor highlights `{param}{/param}` syntax with distinct styling
- CRTR-05: Creator can define parameters with name, description, required flag, and default value
- CRTR-06: Creator can set price markup per run (in USDC)
- CRTR-07: Creator can toggle allows_user_message for system+user mode
- CRTR-08: Creator can enter their Claude API key (user-level integration)
- DATA-07: Creator's API key stored at user level (encrypted, Dashboard > Integrations)
- CRTR-10: Creator can edit published template (updates in place)

**Success Criteria:**

1. Creator can select "Prompt Template" in Create Resource modal and complete the creation flow
2. System prompt editor shows `{param}{/param}` tags with distinct visual styling
3. Creator can add/edit/remove parameters with validation
4. API key configured in Dashboard > Integrations (user-level, better UX than per-template)
5. Published templates appear in creator's dashboard with edit capability

**Notes:**

- Follows existing CreateResourceModal patterns
- API key storage changed from per-template to user-level integrations (follows TelegramCard pattern)

---

### Phase 3: Server-Side Execution Engine

**Goal:** Server can execute prompt templates using creator's API key and stream responses.

**Dependencies:** Phase 2 (templates with API keys must exist)

**Status:** Complete (2026-01-19)

**Plans:** 2 plans

Plans:

- [x] 03-01-PLAN.md — Claude integration backend (database + API endpoints for API key storage)
- [x] 03-02-PLAN.md — Execution engine with parameter substitution, streaming, and error handling

**Requirements:**

- EXEC-01: Parameter substitution replaces `{param}{/param}` with provided values
- EXEC-02: Missing required parameters throw validation error before payment
- EXEC-03: Server decrypts creator's API key for execution
- EXEC-04: Server calls Claude API using @anthropic-ai/sdk
- EXEC-05: Streaming response proxied to caller in real-time
- EXEC-06: Execution errors mapped to user-friendly messages
- CRTR-09: Creator can test template execution before publishing

**Success Criteria:**

1. POST /api/prompt-templates/{id}/execute accepts parameters and returns streamed response
2. Parameter substitution correctly replaces all `{paramName}{/paramName}` tags
3. Validation rejects requests with missing required parameters
4. Creator can test their own template (bypasses payment for self-test)
5. Errors (invalid key, rate limit, network) return appropriate error messages

**Notes:**

- This is the core execution logic, payment integration comes in Phase 5
- Creator testing endpoint allows pre-publish verification

---

### Phase 4: Caller Detail Page + Parameter Form

**Goal:** Callers can view template details and prepare parameters for execution.

**Dependencies:** Phase 2 (templates must be publishable)

**Status:** Complete (2026-01-19)

**Plans:** 1 plan

Plans:

- [x] 04-01-PLAN.md — Template detail page with parameter form and response display

**Requirements:**

- CALL-01: Caller can view template detail page with name, description, params, price, usage count
- CALL-02: Caller never sees the actual system prompt content
- CALL-03: Caller can fill parameter values via auto-generated form
- CALL-04: Required parameters are enforced, defaults are pre-filled
- CALL-05: Caller can provide optional user message when allows_user_message is true
- CALL-07: Response streams to UI in real-time
- CALL-08: Caller can copy output to clipboard

**Success Criteria:**

1. Template detail page shows name, description, parameter list, price, and usage count but NOT the system prompt
2. Parameter form is auto-generated from template's parameter definitions with validation
3. User message input appears only when allows_user_message is true
4. Response displays when execution completes (complete response, not streaming per CONTEXT.md)
5. Copy button appears after execution completes

**Notes:**

- Execution without payment for development/testing
- Payment integration added in Phase 5
- Per CONTEXT.md: No streaming display - show complete response

---

### Phase 5: x402 Payment + Usage Logging

**Goal:** Callers pay via x402 before execution and usage is tracked.

**Dependencies:** Phase 3 (execution engine), Phase 4 (caller UI)

**Status:** Complete (2026-01-20)

**Plans:** 2 plans

Plans:

- [x] 05-01-PLAN.md — x402 payment integration for template execution
- [x] 05-02-PLAN.md — Usage logging and caller history

**Requirements:**

- CALL-06: Caller pays creator's markup via x402 before execution
- EXEC-07: Usage is logged (template_id, caller, success/fail, token counts)
- CALL-09: Caller can view their execution history for this template

**Success Criteria:**

1. Clicking "Run" initiates x402 payment flow with creator as recipient
2. Payment amount matches the creator's configured price markup
3. After successful payment, execution proceeds automatically
4. Each execution creates a usage log entry (success or failure)
5. Caller can view their past executions with timestamps and status

**Notes:**

- Uses existing x402 integration via @openfacilitator/sdk
- CALL-09 (caller history UI) deferred — backend complete, UI can be added when needed

---

## Progress

| Phase                    | Status   | Requirements | Completed |
| ------------------------ | -------- | ------------ | --------- |
| 1 - Database Schema      | Complete | 6            | 6         |
| 2 - Creator UI + API Key | Complete | 10           | 10        |
| 3 - Server Execution     | Complete | 7            | 7         |
| 4 - Caller Detail Page   | Complete | 7            | 7         |
| 5 - Payment + Logging    | Complete | 3            | 3         |

**Total:** 33/33 requirements complete (100%) ✓

---

## Dependency Graph

```
Phase 1 (Database)
    |
    v
Phase 2 (Creator UI + API Key)
    |
    v
Phase 3 (Server Execution)
    |
    +----> Phase 4 (Caller UI)
    |           |
    |           v
    +----> Phase 5 (Payment + Logging)
```

---

_Roadmap created: 2026-01-19_
_Pivoted to server-side execution: 2026-01-19_
_Phase 3 completed: 2026-01-19_
_Phase 4 completed: 2026-01-19_
_Phase 5 completed: 2026-01-20_
_Workflow Integration phase removed: 2026-01-20 — existing workflow builder handles all resource types uniformly_
_Discovery Integration phase removed: 2026-01-20 — existing resource discovery handles all resource types uniformly_
_**Project complete: 2026-01-20**_
