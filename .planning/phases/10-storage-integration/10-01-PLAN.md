---
phase: 10-storage-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/pages/JobCanvas/lib/useRunTracking.ts
  - src/lib/x402-storage.ts
  - src/types/runs.ts
autonomous: true

must_haves:
  truths:
    - "Job with x402storage enabled uploads output to x402.storage API after completion"
    - "Storage upload happens only when run completes successfully"
    - "Storage failure does not fail the job (graceful degradation)"
    - "Storage result (URL or error) is captured in output node data"
  artifacts:
    - path: "src/lib/x402-storage.ts"
      provides: "x402.storage API client with retry logic"
      exports: ["uploadToStorage", "X402StorageResult"]
    - path: "src/components/pages/JobCanvas/lib/useRunTracking.ts"
      provides: "Storage upload integration in run:completed handler"
      contains: "x402storage"
    - path: "src/types/runs.ts"
      provides: "x402storageUrls field in Run type"
      contains: "x402storageUrls"
  key_links:
    - from: "src/components/pages/JobCanvas/lib/useRunTracking.ts"
      to: "src/lib/x402-storage.ts"
      via: "uploadToStorage function call"
      pattern: "uploadToStorage"
    - from: "run:completed handler"
      to: "OutputNode data update"
      via: "setNodes with x402storageUrls"
      pattern: "x402storageUrls"
---

<objective>
Integrate x402.storage API into the job completion flow. When a job with x402storage destination enabled completes successfully, POST the output content to the x402.storage API and capture the returned CID/URL.

Purpose: Enable permanent IPFS storage of job outputs via x402.storage service.
Output: Storage client utility, updated run tracking hook with storage integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-storage-integration/10-CONTEXT.md
@.planning/phases/10-storage-integration/10-RESEARCH.md
@.planning/phases/09-output-config-ui/09-01-SUMMARY.md

@src/components/pages/JobCanvas/lib/useRunTracking.ts
@src/types/output-config.ts
@src/types/runs.ts
@src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create x402.storage API client</name>
  <files>
    src/lib/x402-storage.ts
    src/types/runs.ts
  </files>
  <action>
Create a new `src/lib/x402-storage.ts` utility with:

1. **Type definitions:**

   ```typescript
   export interface X402StorageResult {
     success: boolean;
     url?: string; // Full URL: https://x402.storage/{cid}
     cid?: string; // IPFS CID (bafybei...)
     filename?: string; // Optional filename for display
     error?: string; // Error message if failed
   }
   ```

2. **Upload function:**

   ```typescript
   export async function uploadToStorage(
     content: string | object,
     filename?: string,
   ): Promise<X402StorageResult>;
   ```

   Implementation details:
   - Endpoint: POST https://api.x402.storage/store
   - Content-Type: application/json
   - Body: `{ content: contentString, filename?: string }`
   - For now, use a placeholder PAYMENT-SIGNATURE header (e.g., "pending-integration")
     - Add TODO comment: "Payment signature integration needed - requires wallet signing"
   - Implement retry with exponential backoff (2 attempts max, 1s then 2s delay)
   - Return X402StorageResult with success=false and error message on failure
   - Serialize object content to JSON string if not already a string

3. **Update `src/types/runs.ts`:**
   Add `x402storageUrls?: X402StorageResult[]` field to the Run interface for persisting storage results.
   </action>
   <verify>

- TypeScript compiles without errors: `npx tsc --noEmit`
- File exists: `ls src/lib/x402-storage.ts`
- Export check: `grep -E "export (async function|interface)" src/lib/x402-storage.ts`
  </verify>
  <done>
- x402-storage.ts exports uploadToStorage function and X402StorageResult type
- Run type includes optional x402storageUrls array field
- Retry logic implemented with exponential backoff
  </done>
  </task>

<task type="auto">
  <name>Task 2: Integrate storage upload into run:completed handler</name>
  <files>src/components/pages/JobCanvas/lib/useRunTracking.ts</files>
  <action>
Modify `useRunTracking.ts` to upload to x402.storage when a run completes:

1. **Add import:**

   ```typescript
   import { uploadToStorage, X402StorageResult } from "@/lib/x402-storage";
   ```

2. **Add helper function** to check if x402storage is enabled:

   ```typescript
   const hasX402StorageEnabled = useCallback((nds: Node[]) => {
     return nds
       .filter((n) => n.type === "output")
       .some((n) => {
         const config = (
           n.data as {
             outputConfig?: {
               destinations?: Array<{ type: string; enabled: boolean }>;
             };
           }
         )?.outputConfig;
         return config?.destinations?.some(
           (d) => d.type === "x402storage" && d.enabled,
         );
       });
   }, []);
   ```

3. **Modify the run:completed handler** (inside the useEffect where subscribe is called):
   - After the success case check (after `if (event.status === "failed")` block)
   - Before the setTimeout that resets to idle
   - Add this logic:

   ```typescript
   // Upload to x402.storage if enabled
   if (event.status === "completed") {
     // Get current nodes to check config
     setNodes((currentNodes) => {
       if (hasX402StorageEnabled(currentNodes)) {
         // Find output node and its result
         const outputNode = currentNodes.find((n) => n.type === "output");
         const outputResult = outputNode?.data?.result;

         if (outputResult) {
           // Fire-and-forget storage upload (don't block completion)
           uploadToStorage(outputResult)
             .then((storageResult) => {
               // Update output node with storage result
               setNodes((nds) =>
                 nds.map((node) => {
                   if (node.type === "output") {
                     return {
                       ...node,
                       data: {
                         ...node.data,
                         x402storageUrls: [storageResult],
                         x402storageError: storageResult.success
                           ? undefined
                           : storageResult.error,
                       },
                     };
                   }
                   return node;
                 }),
               );
             })
             .catch((err) => {
               console.error("[RunTracking] Storage upload failed:", err);
               // Update with error state
               setNodes((nds) =>
                 nds.map((node) => {
                   if (node.type === "output") {
                     return {
                       ...node,
                       data: {
                         ...node.data,
                         x402storageUrls: [],
                         x402storageError:
                           err.message || "Storage upload failed",
                       },
                     };
                   }
                   return node;
                 }),
               );
             });
         }
       }
       return currentNodes; // Return unchanged for this setNodes call
     });
   }
   ```

4. **Add hasX402StorageEnabled to useEffect dependency array.**

Key points:

- Storage upload is fire-and-forget (async, doesn't block)
- Uses setNodes callback pattern to get current node state
- Graceful degradation: catches errors, sets x402storageError for UI display
- Result stored in output node's data.x402storageUrls array
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Import present: `grep "uploadToStorage" src/components/pages/JobCanvas/lib/useRunTracking.ts`
- x402storage check: `grep "x402storage" src/components/pages/JobCanvas/lib/useRunTracking.ts`
  </verify>
  <done>
- useRunTracking imports and calls uploadToStorage on run:completed
- Storage upload only triggers when x402storage destination is enabled
- Storage result or error captured in output node data
- No blocking of job completion on storage failure
  </done>
  </task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **TypeScript:** `npx tsc --noEmit` (no errors)
2. **Lint:** `npm run lint` (no new errors beyond pre-existing)
3. **Files exist:**
   - `ls src/lib/x402-storage.ts`
4. **Integration points:**
   - `grep -c "uploadToStorage" src/components/pages/JobCanvas/lib/useRunTracking.ts` (should be >= 2: import + call)
   - `grep -c "x402storageUrls" src/types/runs.ts` (should be >= 1)
     </verification>

<success_criteria>
Requirements coverage:

- JCOMP-01: Job completion detects when x402storage destination is enabled
- JCOMP-02: Output content POST'd to x402.storage API (with placeholder payment header)
- JCOMP-03: Returned CID/URL stored in job result metadata (x402storageUrls array)
- JCOMP-04: Storage failure does not fail the job (graceful degradation via try-catch)
- DATA-02: Job result schema includes x402storageUrls array field (in Run type)

Deferred to 10-02:

- JCOMP-05: Storage failure shows error message with retry option (UI)
- JCOMP-06: Multiple output files each stored separately (complex, v2)
- RSLT-01 through RSLT-04: Results display
- PRCE-03 and PRCE-04: Receipt pricing
- DATA-03: Storage URLs persisted with job history (backend)
  </success_criteria>

<output>
After completion, create `.planning/phases/10-storage-integration/10-01-SUMMARY.md`
</output>
