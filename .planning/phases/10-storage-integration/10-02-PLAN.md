---
phase: 10-storage-integration
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/components/workflow/nodes/OutputNode.tsx
  - src/components/panels/RunDetailsPanel.tsx
autonomous: true

must_haves:
  truths:
    - "OutputNode displays x402.storage URLs below output content when present"
    - "Each URL has a working copy button"
    - "Storage error displays error message (not crash)"
    - "Job receipt shows storage cost as separate line item"
  artifacts:
    - path: "src/components/workflow/nodes/OutputNode.tsx"
      provides: "Storage URLs display section with copy buttons"
      contains: "x402storageUrls"
    - path: "src/components/panels/RunDetailsPanel.tsx"
      provides: "Storage cost line item in Overview section"
      contains: "x402.storage"
  key_links:
    - from: "OutputNode"
      to: "data.x402storageUrls"
      via: "conditional rendering"
      pattern: "x402storageUrls.*map"
    - from: "RunDetailsPanel"
      to: "storageCost display"
      via: "formatCost"
      pattern: "storage.*formatCost"
---

<objective>
Display x402.storage URLs in OutputNode with copy buttons and show storage cost line item in job receipt. Complete the user-facing UI for the storage feature.

Purpose: Users can access permanent IPFS URLs and see transparent pricing breakdown.
Output: Updated OutputNode with URL display, updated RunDetailsPanel with storage cost line item.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-storage-integration/10-CONTEXT.md
@.planning/phases/10-storage-integration/10-01-SUMMARY.md

@src/components/workflow/nodes/OutputNode.tsx
@src/components/panels/RunDetailsPanel.tsx
@src/lib/x402-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add storage URLs display to OutputNode</name>
  <files>src/components/workflow/nodes/OutputNode.tsx</files>
  <action>
Add a "Stored permanently" section below output content in OutputNode.tsx:

1. **Update OutputNodeData type** (around line 25):

   ```typescript
   import type { X402StorageResult } from "@/lib/x402-storage";

   type OutputNodeData = {
     result?: string | null;
     isLoading?: boolean;
     outputConfig?: OutputConfig;
     x402storageUrls?: X402StorageResult[]; // Add this
     x402storageError?: string; // Add this
     onDelete?: (nodeId: string) => void;
     onViewOutput?: (result: string | null | undefined) => void;
     onConfigure?: (nodeId: string) => void;
   };
   ```

2. **Add URL truncation helper** (after existing helper functions, around line 60):

   ```typescript
   // Truncate URL in the middle for display
   function truncateMiddle(str: string, maxLength: number): string {
     if (str.length <= maxLength) return str;
     const start = Math.ceil((maxLength - 3) / 2);
     const end = Math.floor((maxLength - 3) / 2);
     return str.slice(0, start) + "..." + str.slice(-end);
   }
   ```

3. **Add copy state** at top of OutputNode component (after hasResult declaration):

   ```typescript
   const [copiedUrl, setCopiedUrl] = useState<string | null>(null);

   const handleCopyUrl = async (url: string) => {
     try {
       await navigator.clipboard.writeText(url);
       setCopiedUrl(url);
       setTimeout(() => setCopiedUrl(null), 1500);
     } catch (err) {
       console.error("Copy failed:", err);
     }
   };
   ```

4. **Import useState** if not already imported, and import Copy/Check icons:

   ```typescript
   import { Copy, Check } from "lucide-react";
   ```

5. **Add storage URLs section** after the output content display (after the closing `</div>` of the clickable result area, before the final closing `</div>` of the component, around line 363):

   ```tsx
   {
     /* Storage URLs section */
   }
   {
     data.x402storageUrls && data.x402storageUrls.length > 0 && (
       <div className="mt-3 pt-3 border-t border-border/50">
         <div className="flex items-center gap-1.5 mb-2 text-xs text-muted-foreground">
           <Globe className="w-3 h-3 text-emerald-500" />
           <span>Stored permanently</span>
         </div>
         <div className="space-y-1.5">
           {data.x402storageUrls.map((item, idx) =>
             item.success && item.url ? (
               <div key={idx} className="flex items-center gap-2 text-xs">
                 {item.filename && (
                   <span className="text-muted-foreground truncate max-w-[60px]">
                     {item.filename}
                   </span>
                 )}
                 <span
                   className="font-mono text-emerald-600 dark:text-emerald-400 truncate flex-1"
                   title={item.url}
                 >
                   {truncateMiddle(item.url, 32)}
                 </span>
                 <button
                   onClick={(e) => {
                     e.stopPropagation();
                     handleCopyUrl(item.url!);
                   }}
                   className="p-1 rounded hover:bg-accent text-muted-foreground shrink-0"
                   title="Copy URL"
                 >
                   {copiedUrl === item.url ? (
                     <Check className="w-3 h-3 text-emerald-500" />
                   ) : (
                     <Copy className="w-3 h-3" />
                   )}
                 </button>
               </div>
             ) : null,
           )}
         </div>
       </div>
     );
   }

   {
     /* Storage error */
   }
   {
     data.x402storageError && (
       <div className="mt-3 pt-3 border-t border-border/50">
         <div className="flex items-center gap-1.5 text-xs text-amber-600 dark:text-amber-400">
           <AlertCircle className="w-3 h-3" />
           <span>Storage failed: {data.x402storageError}</span>
         </div>
       </div>
     );
   }
   ```

Key design choices per CONTEXT.md:

- URLs appear below output content
- Section labeled "Stored permanently" with Globe icon (emerald)
- Full URL with middle truncation
- Copy button as primary action
- Error state shows amber warning, doesn't crash
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Storage section: `grep "Stored permanently" src/components/workflow/nodes/OutputNode.tsx`
- Copy handler: `grep "handleCopyUrl" src/components/workflow/nodes/OutputNode.tsx`
  </verify>
  <done>
- OutputNode displays x402.storage URLs when x402storageUrls array has successful items
- Each URL has copy button with visual feedback (Check icon on copy)
- Error state displays amber warning message
- URL truncation preserves start/end for readability
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add storage cost to job receipt</name>
  <files>src/components/panels/RunDetailsPanel.tsx</files>
  <action>
Add storage cost as a separate line item in the RunDetailsPanel Overview section:

1. **Update the Total Cost card** in the Overview grid (around lines 275-293):

   Replace the existing "Total Cost" card with an expanded version that shows breakdown when storage was used.

   First, detect if storage was used by checking run data. Add this logic before the return statement (around line 190):

   ```typescript
   // Check if this run used x402.storage (look for storage URLs in events or metadata)
   // For now, estimate based on output config presence - backend will provide actual cost
   const hasStorageCost =
     runData?.storage_cost != null && runData.storage_cost > 0;
   const storageCost = runData?.storage_cost || 0;
   ```

   **Note:** The backend doesn't currently return `storage_cost`. For now, this will gracefully handle the absence. Add a TODO comment for backend integration.

2. **Update the cost display card** (around line 275):

   ```tsx
   <div className="p-3 rounded-lg bg-muted/50 space-y-1">
     <div className="flex items-center gap-2 text-muted-foreground">
       <DollarSign className="h-3.5 w-3.5" />
       <span className="text-xs">
         {runData?.total_payment ? "Total Payment" : "Total Cost"}
       </span>
     </div>
     <div className="text-sm font-mono">
       {formatCost(runData?.total_payment || runData?.total_cost)}
     </div>
     {/* Fee breakdown for x402 payments */}
     {runData?.total_payment && runData?.creator_markup_earned != null && (
       <div className="text-xs text-muted-foreground pt-1 border-t border-border/50 mt-1 space-y-0.5">
         <div className="flex justify-between">
           <span>Base fee</span>
           <span>{formatCost(runData.total_cost)}</span>
         </div>
         {/* Storage line item - show when storage was used */}
         {hasStorageCost && (
           <div className="flex justify-between">
             <span>x402.storage</span>
             <span>{formatCost(storageCost)}</span>
           </div>
         )}
         <div className="flex justify-between">
           <span>Creator markup</span>
           <span>{formatCost(runData.creator_markup_earned)}</span>
         </div>
       </div>
     )}
   </div>
   ```

3. **Add Run interface extension** for storage_cost. Since backend doesn't have this yet, add a TODO comment at the top of the file:
   ```typescript
   // TODO: Backend needs to return storage_cost in run data for receipt display
   // For now, storage cost line item will only show if backend provides it
   ```

This implementation:

- Shows "x402.storage" as label (service name per CONTEXT.md)
- Gracefully handles missing backend support
- Integrates into existing fee breakdown pattern
  </action>
  <verify>
- TypeScript compiles: `npx tsc --noEmit`
- Storage line item: `grep "x402.storage" src/components/panels/RunDetailsPanel.tsx`
- TODO comment: `grep "storage_cost" src/components/panels/RunDetailsPanel.tsx`
  </verify>
  <done>
- RunDetailsPanel shows storage cost line item when present
- Label is "x402.storage" (service name)
- Graceful handling when storage_cost not provided by backend
- Integrates cleanly into existing fee breakdown UI
  </done>
  </task>

</tasks>

<verification>
Run these checks after all tasks complete:

1. **TypeScript:** `npx tsc --noEmit` (no errors)
2. **Lint:** `npm run lint` (no new errors beyond pre-existing)
3. **UI elements present:**
   - `grep "Stored permanently" src/components/workflow/nodes/OutputNode.tsx`
   - `grep "x402.storage" src/components/panels/RunDetailsPanel.tsx`
4. **Copy functionality:**
   - `grep "handleCopyUrl" src/components/workflow/nodes/OutputNode.tsx`
   - `grep "navigator.clipboard" src/components/workflow/nodes/OutputNode.tsx`
     </verification>

<success_criteria>
Requirements coverage:

- RSLT-01: OutputNode displays x402.storage URLs when present
- RSLT-02: Each URL has copy button
- RSLT-03: Multiple stored outputs listed with individual links (array mapping)
- RSLT-04: Storage section labeled "Stored permanently:" with Globe icon
- PRCE-03: Job receipt includes storage line item (when backend provides)

Partially addressed (pending backend):

- PRCE-04: Multiple outputs show actual total (needs backend storage_cost tracking)
- DATA-03: Storage URLs persisted with job history (backend responsibility)

Note: JCOMP-05 (retry option) and JCOMP-06 (multi-file separate upload) deferred to future iteration.
</success_criteria>

<output>
After completion, create `.planning/phases/10-storage-integration/10-02-SUMMARY.md`
</output>
