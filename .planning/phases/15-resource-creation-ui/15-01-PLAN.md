---
phase: 15-resource-creation-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/x402-jobs/src/types/openrouter-resource.ts
  - apps/x402-jobs-api/src/routes/resources.ts
  - apps/x402-jobs-api/src/routes/integrations.ts
autonomous: true

must_haves:
  truths:
    - "openrouter_instant resource type has a Zod schema for form validation"
    - "Backend POST /resources/instant accepts openrouter_instant resource type"
    - "Backend stores openrouter_model_id and openrouter_config in database"
    - "Backend validates OpenRouter API key exists before creating resource"
  artifacts:
    - path: "apps/x402-jobs/src/types/openrouter-resource.ts"
      provides: "OpenRouter resource types and Zod schema"
      exports:
        [
          "CreateOpenRouterResourceInput",
          "createOpenRouterResourceSchema",
          "OpenRouterConfig",
        ]
    - path: "apps/x402-jobs-api/src/routes/resources.ts"
      provides: "Extended POST handler for openrouter_instant"
      contains: "openrouter_instant"
    - path: "apps/x402-jobs-api/src/routes/integrations.ts"
      provides: "getCreatorOpenRouterApiKey helper function"
      exports: ["getCreatorOpenRouterApiKey"]
  key_links:
    - from: "apps/x402-jobs/src/types/openrouter-resource.ts"
      to: "apps/x402-jobs/src/components/modals/CreateResourceModal.tsx"
      via: "Schema import for form validation"
      pattern: "createOpenRouterResourceSchema"
    - from: "apps/x402-jobs-api/src/routes/resources.ts"
      to: "x402_resources table"
      via: "Supabase insert with openrouter_model_id"
      pattern: "openrouter_model_id"
    - from: "apps/x402-jobs-api/src/routes/resources.ts"
      to: "apps/x402-jobs-api/src/routes/integrations.ts"
      via: "Import getCreatorOpenRouterApiKey for validation"
      pattern: "getCreatorOpenRouterApiKey"
---

<objective>
Create TypeScript types and backend support for OpenRouter resource creation.

Purpose: Establish the data layer foundation that the UI will build upon - types for form validation and backend to persist resources.

Output: TypeScript types with Zod schema, backend POST handler extended for openrouter_instant type.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-model-browser-ui/14-01-SUMMARY.md
@apps/x402-jobs/src/types/prompt-template.ts
@apps/x402-jobs-api/src/routes/resources.ts
@apps/x402-jobs-api/src/routes/integrations.ts
@apps/x402-jobs/migrations/005_add_openrouter_integration.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenRouter resource types and Zod schema</name>
  <files>apps/x402-jobs/src/types/openrouter-resource.ts</files>
  <action>
Create a new TypeScript file with types for OpenRouter resources, following the pattern from prompt-template.ts.

Include:

1. `OpenRouterConfig` interface for the JSONB config:

   ```typescript
   interface OpenRouterConfig {
     systemPrompt: string;
     temperature?: number; // 0-2, default 1
     maxTokens?: number; // model-specific, default 4096
     topP?: number; // 0-1
     frequencyPenalty?: number; // -2 to 2
     presencePenalty?: number; // -2 to 2
   }
   ```

2. `OpenRouterParameter` schema (reuse pattern from prompt-template.ts):
   - name: string (required, min 1)
   - description: string (default "")
   - required: boolean (default true)
   - default: string (optional)

3. `createOpenRouterResourceSchema` Zod schema for form validation:
   - name: string, min 1, max 100
   - slug: string, regex for URL-safe
   - description: string, max 500, optional
   - category: string, min 1 (required)
   - avatar_url: string URL, optional
   - price_usdc: string, min $0.001
   - network: enum ["base", "solana"]
   - model_id: string (UUID from ai_models table)
   - system_prompt: string, min 1
   - parameters: array of OpenRouterParameter
   - temperature: number, 0-2, optional
   - max_tokens: number, 1-128000, optional
   - allows_user_message: boolean, default false

4. Export `CreateOpenRouterResourceInput` type inferred from schema.

5. Export `OpenRouterResourcePublicView` interface for caller-facing data (excludes system_prompt).

Follow exact naming patterns from prompt-template.ts. Use Zod for validation.
</action>
<verify>
Run: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npx tsc --noEmit src/types/openrouter-resource.ts`
Should compile without errors.
</verify>
<done>
OpenRouter resource types and Zod schema exported, TypeScript compiles successfully.
</done>
</task>

<task type="auto">
  <name>Task 2: Add getCreatorOpenRouterApiKey helper and extend POST /resources/instant</name>
  <files>apps/x402-jobs-api/src/routes/integrations.ts, apps/x402-jobs-api/src/routes/resources.ts</files>
  <action>
**Part A: Add helper function in integrations.ts**

Add `getCreatorOpenRouterApiKey` helper function following the exact pattern from `getCreatorClaudeApiKey` (around line 520):

```typescript
/**
 * Get creator's OpenRouter API key for resource execution.
 * Used by openrouter_instant executor in instant.ts.
 *
 * @param userId - The user ID (resource owner)
 * @returns Decrypted API key or null if not configured/disabled
 */
export async function getCreatorOpenRouterApiKey(
  userId: string,
): Promise<string | null> {
  const { data, error } = await getSupabase()
    .from("user_openrouter_integrations")
    .select("encrypted_api_key, is_enabled")
    .eq("user_id", userId)
    .single();

  if (error || !data?.encrypted_api_key || !data.is_enabled) {
    return null;
  }

  return decryptSecret(data.encrypted_api_key);
}
```

Also add a non-decrypting version for validation (checking key exists without retrieving it):

```typescript
/**
 * Check if user has OpenRouter API key configured.
 * Returns { hasApiKey: boolean } - does NOT return the actual key.
 */
export async function hasCreatorOpenRouterApiKey(
  userId: string,
): Promise<{ hasApiKey: boolean }> {
  const { data, error } = await getSupabase()
    .from("user_openrouter_integrations")
    .select("encrypted_api_key, is_enabled")
    .eq("user_id", userId)
    .single();

  return {
    hasApiKey: Boolean(data?.encrypted_api_key && data?.is_enabled),
  };
}
```

**Part B: Extend POST /resources/instant in resources.ts**

1. Import the helper at top of resources.ts (around line 12 with other imports from integrations):

   ```typescript
   import {
     getCreatorClaudeApiKey,
     hasCreatorOpenRouterApiKey,
   } from "./integrations";
   ```

2. Add "openrouter_instant" to validTypes array (around line 2042):

   ```typescript
   const validTypes = [
     "proxy",
     "prompt",
     "static",
     "prompt_template",
     "openrouter_instant",
   ];
   ```

3. Add validation for openrouter_instant (after prompt_template validation, around line 2079):

   ```typescript
   if (resourceType === "openrouter_instant") {
     if (!req.body.modelId) {
       return res.status(400).json({
         error: "OpenRouter resources require modelId",
       });
     }
     if (!systemPrompt) {
       return res.status(400).json({
         error: "OpenRouter resources require systemPrompt",
       });
     }
     // Check user has OpenRouter API key configured
     const { hasApiKey } = await hasCreatorOpenRouterApiKey(userId);
     if (!hasApiKey) {
       return res.status(400).json({
         error:
           "OpenRouter API key required. Configure in Settings > Integrations.",
       });
     }
   }
   ```

4. Add openrouter_instant insert data (after prompt_template section, around line 2280):
   ```typescript
   if (resourceType === "openrouter_instant") {
     insertData.openrouter_model_id = req.body.modelId;
     insertData.openrouter_config = {
       systemPrompt: systemPrompt,
       temperature: req.body.temperature ?? 1,
       maxTokens: req.body.maxTokens ?? 4096,
       topP: req.body.topP,
       frequencyPenalty: req.body.frequencyPenalty,
       presencePenalty: req.body.presencePenalty,
     };
     // Also store in pt_ fields for compatibility with prompt template execution
     insertData.pt_system_prompt = systemPrompt;
     insertData.pt_parameters = parameters || [];
     insertData.pt_max_tokens = req.body.maxTokens || 4096;
     insertData.pt_allows_user_message = allowsUserMessage || false;
   }
   ```

Follow existing patterns in the file for error handling and response format.
</action>
<verify>
Run: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api && npm run build`
Should build without TypeScript errors.
</verify>
<done>
Backend accepts openrouter_instant resource type, validates API key exists via hasCreatorOpenRouterApiKey, stores in database with openrouter_model_id and openrouter_config columns.
</done>
</task>

</tasks>

<verification>
1. TypeScript types compile: `cd apps/x402-jobs && npx tsc --noEmit`
2. Backend builds: `cd apps/x402-jobs-api && npm run build`
3. Types are exported correctly from openrouter-resource.ts
4. POST handler includes openrouter_instant case with API key check
5. Helper functions exported from integrations.ts
</verification>

<success_criteria>

1. OpenRouter resource Zod schema exists with all required fields
2. CreateOpenRouterResourceInput type is exported and usable in forms
3. Backend POST /resources/instant accepts openrouter_instant type
4. Backend validates OpenRouter API key exists before creating resource
5. Backend stores openrouter_model_id and openrouter_config correctly
6. getCreatorOpenRouterApiKey and hasCreatorOpenRouterApiKey exported from integrations.ts
   </success_criteria>

<output>
After completion, create `.planning/phases/15-resource-creation-ui/15-01-SUMMARY.md`
</output>
