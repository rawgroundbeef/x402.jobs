---
phase: 02-creator-template-ui
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/modals/CreateResourceModal.tsx
  - src/lib/prompt-template-utils.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Creator can write system prompt in a monospace textarea"
    - "Creator sees parameter tags extracted and displayed below editor with visual indicators (CRTR-04 interpretation: tag awareness via extraction/display rather than in-editor syntax highlighting, per CONTEXT.md decision)"
    - "Creator sees warnings when tag names don't match defined parameters"
    - "Creator can add, edit, and remove parameters with name, description, required, and default fields"
    - "Creator can set max_tokens and allows_user_message settings"
  artifacts:
    - path: "src/components/modals/CreateResourceModal.tsx"
      provides: "System prompt editor, parameter management, and settings"
      contains: "useFieldArray"
    - path: "src/lib/prompt-template-utils.ts"
      provides: "Tag extraction utility"
      exports: ["extractParameterTags"]
  key_links:
    - from: "CreateResourceModal.tsx"
      to: "prompt-template-utils.ts"
      via: "import extractParameterTags"
      pattern: "extractParameterTags"
    - from: "CreateResourceModal.tsx"
      to: "promptTemplateForm.control"
      via: "useFieldArray name='parameters'"
      pattern: "useFieldArray.*parameters"
---

<objective>
Build the system prompt editor with tag awareness and parameter management UI for prompt templates.

Purpose: CRTR-03 (system prompt editor), CRTR-04 (tag highlighting/warnings), CRTR-05 (parameters), and CRTR-07 (allows_user_message) complete the prompt template creation form. This is the core functionality that makes prompt templates useful.

**CRTR-04 interpretation:** Per CONTEXT.md, the goal is "user awareness that tags exist - not fancy IDE features." This plan implements tag awareness by extracting tags from the system prompt and displaying them below the editor with visual indicators (purple badges for defined, yellow for undefined). This provides the distinct styling required by CRTR-04 without the complexity of in-editor syntax highlighting.

Output: Creator can write system prompts with `{param}{/param}` syntax, see extracted tags below editor with status indicators, see tag warnings, and manage parameters dynamically. Full creation flow works end-to-end.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-creator-template-ui/02-CONTEXT.md
@.planning/phases/02-creator-template-ui/02-RESEARCH.md
@.planning/phases/02-creator-template-ui/02-01-SUMMARY.md (after Plan 01 completes)
@src/components/modals/CreateResourceModal.tsx
@src/components/panels/JobPanel.tsx (for useFieldArray pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag extraction utility and system prompt editor</name>
  <files>src/lib/prompt-template-utils.ts, src/components/modals/CreateResourceModal.tsx</files>
  <action>
1. Create new utility file `src/lib/prompt-template-utils.ts`:
   ```typescript
   /**
    * Extract parameter tag names from a system prompt.
    * Tags use the {paramName}{/paramName} syntax.
    *
    * @param systemPrompt - The system prompt text to parse
    * @returns Array of unique parameter names found in the prompt
    */
   export function extractParameterTags(systemPrompt: string): string[] {
     if (!systemPrompt) return [];

     // Match {name}{/name} pattern - capture the name
     const tagRegex = /\{([a-zA-Z_][a-zA-Z0-9_]*)\}\{\/\1\}/g;
     const matches = new Set<string>();
     let match;

     while ((match = tagRegex.exec(systemPrompt)) !== null) {
       matches.add(match[1]);
     }

     return Array.from(matches);

}

/\*\*
_ Find tags in the system prompt that don't have a matching parameter definition.
_
_ @param systemPrompt - The system prompt text
_ @param definedParams - Array of defined parameter names
_ @returns Array of tag names that are undefined
_/
export function findUndefinedTags(
systemPrompt: string,
definedParams: string[]
): string[] {
const usedTags = extractParameterTags(systemPrompt);
const definedSet = new Set(definedParams);
return usedTags.filter((tag) => !definedSet.has(tag));
}

/\*\*
_ Find defined parameters that aren't used in the system prompt.
_
_ @param systemPrompt - The system prompt text
_ @param definedParams - Array of defined parameter names
_ @returns Array of parameter names that are unused
_/
export function findUnusedParameters(
systemPrompt: string,
definedParams: string[]
): string[] {
const usedTags = new Set(extractParameterTags(systemPrompt));
return definedParams.filter((param) => !usedTags.has(param));
}

````

2. In CreateResourceModal.tsx, import the utility:
```typescript
import { extractParameterTags, findUndefinedTags, findUnusedParameters } from "@/lib/prompt-template-utils";
````

3. Add system prompt editor section in the prompt template form (replace the placeholder comment from Plan 01):

   ```tsx
   {
     /* System Prompt Editor */
   }
   <div className="space-y-2">
     <Label htmlFor="system-prompt">System Prompt *</Label>
     <p className="text-xs text-muted-foreground">
       Use{" "}
       <code className="px-1 py-0.5 bg-muted rounded">
         {"{paramName}{/paramName}"}
       </code>{" "}
       to mark parameter placeholders
     </p>
     <Textarea
       id="system-prompt"
       {...promptTemplateForm.register("system_prompt")}
       className="font-mono text-sm min-h-[200px] resize-y"
       placeholder="You are a helpful assistant that specializes in {topic}{/topic}..."
     />

     {/* Tag status indicators - displays extracted tags below editor with visual styling */}
     <div className="flex justify-between items-start gap-4 text-xs">
       {/* Tags used */}
       <div className="flex-1">
         {(() => {
           const systemPrompt = promptTemplateForm.watch("system_prompt") || "";
           const tags = extractParameterTags(systemPrompt);
           const params = promptTemplateForm.watch("parameters") || [];
           const paramNames = params.map((p) => p.name).filter(Boolean);
           const undefinedTags = findUndefinedTags(systemPrompt, paramNames);
           const unusedParams = findUnusedParameters(systemPrompt, paramNames);

           return (
             <>
               {tags.length > 0 ? (
                 <span className="text-muted-foreground">
                   Tags:{" "}
                   {tags.map((tag, i) => (
                     <span
                       key={tag}
                       className={`mx-0.5 px-1.5 py-0.5 rounded ${
                         undefinedTags.includes(tag)
                           ? "bg-yellow-500/20 text-yellow-600 dark:text-yellow-400"
                           : "bg-purple-500/10 text-purple-600 dark:text-purple-400"
                       }`}
                     >
                       {tag}
                     </span>
                   ))}
                 </span>
               ) : (
                 <span className="text-muted-foreground">
                   No parameter tags found
                 </span>
               )}

               {undefinedTags.length > 0 && (
                 <p className="text-yellow-600 dark:text-yellow-400 mt-1">
                   Warning: Tags without parameters: {undefinedTags.join(", ")}
                 </p>
               )}

               {unusedParams.length > 0 && (
                 <p className="text-yellow-600 dark:text-yellow-400 mt-1">
                   Warning: Unused parameters: {unusedParams.join(", ")}
                 </p>
               )}
             </>
           );
         })()}
       </div>

       {/* Character count */}
       <span className="text-muted-foreground">
         {(promptTemplateForm.watch("system_prompt") || "").length} characters
       </span>
     </div>
   </div>;
   ```

4. Add form validation error display for system_prompt:
   ```tsx
   <FieldError
     message={promptTemplateForm.formState.errors.system_prompt?.message}
   />
   ```
   </action>
   <verify>

- Type in the system prompt textarea
- Verify monospace font is applied
- Type `{topic}{/topic}` and see "topic" appear in the tags list below the editor with purple styling
- See character count update as you type
- Tag appears yellow when no parameter named "topic" is defined
  </verify>
  <done>System prompt editor shows extracted tags below editor with distinct visual indicators and validation warnings</done>
  </task>

<task type="auto">
  <name>Task 2: Build parameter management with useFieldArray</name>
  <files>src/components/modals/CreateResourceModal.tsx</files>
  <action>
1. Check existing lucide-react imports at the top of the file. If Plus and Trash2 are NOT already imported, add them:
   ```typescript
   // Only add icons that aren't already imported
   import { Plus, Trash2, /* ...existing icons... */ } from "lucide-react";
   ```

2. Import useFieldArray from react-hook-form (check if useForm is already imported, add useFieldArray to the same import):

   ```typescript
   import { useForm, useFieldArray } from "react-hook-form";
   ```

3. Add useFieldArray hook after the promptTemplateForm definition:

   ```typescript
   const {
     fields: parameterFields,
     append: appendParameter,
     remove: removeParameter,
   } = useFieldArray({
     control: promptTemplateForm.control,
     name: "parameters",
   });
   ```

4. Add parameter management section after the system prompt editor:

   ```tsx
   {
     /* Parameters Section */
   }
   <div className="border-t border-border pt-4 space-y-3">
     <div className="flex items-center justify-between">
       <div>
         <Label>Parameters</Label>
         <p className="text-xs text-muted-foreground">
           Define input fields that callers will fill in
         </p>
       </div>
       <Button
         type="button"
         variant="outline"
         size="sm"
         onClick={() =>
           appendParameter({
             name: "",
             description: "",
             required: true,
             default: "",
           })
         }
       >
         <Plus className="h-4 w-4 mr-1" />
         Add Parameter
       </Button>
     </div>

     {parameterFields.length === 0 ? (
       <p className="text-sm text-muted-foreground py-4 text-center border border-dashed border-border rounded-lg">
         No parameters defined. Add parameters to let callers customize the
         prompt.
       </p>
     ) : (
       <div className="space-y-3">
         {parameterFields.map((field, index) => (
           <div
             key={field.id}
             className="p-3 border border-border rounded-lg space-y-3 bg-muted/30"
           >
             <div className="flex items-start gap-3">
               {/* Name and Description */}
               <div className="flex-1 space-y-2">
                 <Input
                   placeholder="Parameter name (e.g., topic)"
                   {...promptTemplateForm.register(`parameters.${index}.name`)}
                   className={
                     promptTemplateForm.formState.errors.parameters?.[index]
                       ?.name
                       ? "border-destructive"
                       : ""
                   }
                 />
                 <Input
                   placeholder="Description (optional)"
                   {...promptTemplateForm.register(
                     `parameters.${index}.description`,
                   )}
                 />
               </div>

               {/* Remove button */}
               <Button
                 type="button"
                 variant="ghost"
                 size="sm"
                 onClick={() => removeParameter(index)}
                 className="text-muted-foreground hover:text-destructive"
               >
                 <Trash2 className="h-4 w-4" />
               </Button>
             </div>

             {/* Required toggle and Default value */}
             <div className="flex items-center gap-4">
               <div className="flex items-center gap-2">
                 <Switch
                   checked={promptTemplateForm.watch(
                     `parameters.${index}.required`,
                   )}
                   onCheckedChange={(checked) =>
                     promptTemplateForm.setValue(
                       `parameters.${index}.required`,
                       checked,
                     )
                   }
                 />
                 <span className="text-sm text-muted-foreground">Required</span>
               </div>

               <div className="flex-1">
                 <Input
                   placeholder="Default value (optional)"
                   {...promptTemplateForm.register(
                     `parameters.${index}.default`,
                   )}
                   disabled={promptTemplateForm.watch(
                     `parameters.${index}.required`,
                   )}
                   className={
                     promptTemplateForm.watch(`parameters.${index}.required`)
                       ? "opacity-50"
                       : ""
                   }
                 />
               </div>
             </div>
           </div>
         ))}
       </div>
     )}
   </div>;
   ```

5. Import Switch component (check if not already imported):
   ```typescript
   import { Switch } from "@repo/ui/switch";
   ```
   </action>
   <verify>

- Click "Add Parameter" button
- Verify parameter card appears with name, description, required toggle, default value fields
- Add multiple parameters and verify each has unique ID (no key warnings)
- Toggle required off and verify default value input becomes enabled
- Click trash icon to remove a parameter
- Add parameter named "topic", then check the system prompt warnings clear when {topic}{/topic} is used
  </verify>
  <done>Parameter management allows add/edit/remove with validation feedback</done>
  </task>

<task type="auto">
  <name>Task 3: Add max_tokens and allows_user_message settings</name>
  <files>src/components/modals/CreateResourceModal.tsx</files>
  <action>
1. Add settings section after parameters:
   ```tsx
   {/* Template Settings */}
   <div className="border-t border-border pt-4 space-y-4">
     <Label>Template Settings</Label>

     {/* Max Tokens */}
     <div>
       <Label htmlFor="max-tokens" className="text-sm font-normal">
         Max Tokens
       </Label>
       <Input
         id="max-tokens"
         type="number"
         min={1}
         max={8192}
         {...promptTemplateForm.register("max_tokens", { valueAsNumber: true })}
         className="mt-1.5 w-32"
       />
       <p className="text-xs text-muted-foreground mt-1">
         Maximum response length (1-8192)
       </p>
       <FieldError message={promptTemplateForm.formState.errors.max_tokens?.message} />
     </div>

     {/* Allows User Message */}
     <div className="flex items-center justify-between py-2">
       <div>
         <Label className="text-sm font-normal">Allow User Message</Label>
         <p className="text-xs text-muted-foreground">
           Enable system + user message mode (callers can add their own message)
         </p>
       </div>
       <Switch
         checked={promptTemplateForm.watch("allows_user_message")}
         onCheckedChange={(checked) =>
           promptTemplateForm.setValue("allows_user_message", checked)
         }
       />
     </div>

   </div>
   ```

2. Update handleClose to also reset the useFieldArray state (this should happen automatically with form reset, but verify).

3. Update the type definition in prompt-template.ts if needed to ensure max_tokens accepts valueAsNumber:
   - The schema already has `.number()` so valueAsNumber should work correctly

4. Ensure the form submit handler includes all fields:
   - Verify handleCreatePromptTemplate already sends maxTokens and allowsUserMessage (added in Plan 01)
     </action>
     <verify>

- Verify max_tokens input shows with default 4096
- Change max_tokens and verify it accepts numbers only
- Try values outside 1-8192 range and verify validation
- Toggle allows_user_message and verify switch state persists
- Submit form and check Network tab to verify all fields are in the payload
  </verify>
  <done>Template settings (max_tokens, allows_user_message) complete the form</done>
  </task>

</tasks>

<verification>
1. Type checking: `npm run typecheck` passes
2. Build: `npm run build` succeeds
3. Manual test flow:
   - Create a new prompt template
   - Write system prompt: "You are an expert in {topic}{/topic}. Explain {concept}{/concept} simply."
   - See tags extracted and displayed below editor with visual indicators (purple for defined, yellow for undefined)
   - Add parameter "topic" - see warning for "topic" clear, tag turns purple
   - Add parameter "concept" with required=false and default="this topic"
   - Set max_tokens to 2048
   - Enable allows_user_message
   - Submit form and verify payload in Network tab contains all fields
</verification>

<success_criteria>

- [ ] extractParameterTags utility correctly parses {name}{/name} syntax
- [ ] System prompt textarea has monospace font and auto-resize
- [ ] Character count displays and updates in real-time
- [ ] Tag names extracted and displayed below editor with distinct visual indicators (purple/yellow badges)
- [ ] Undefined tags (not in parameters) show yellow styling and warning text
- [ ] Unused parameters (not in prompt) show yellow warning
- [ ] Parameters can be added, edited, and removed
- [ ] Required toggle enables/disables default value input
- [ ] max_tokens input validates 1-8192 range
- [ ] allows_user_message toggle works
- [ ] Form submits with all fields in correct format
- [ ] TypeScript compiles without errors
      </success_criteria>

<output>
After completion, create `.planning/phases/02-creator-template-ui/02-02-SUMMARY.md`
</output>
