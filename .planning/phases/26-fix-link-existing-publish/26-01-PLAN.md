---
phase: 26-fix-link-existing-publish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/dashboard/resources/new/link/page.tsx
  - apps/web/src/app/dashboard/resources/new/review/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can complete the full Link Existing flow: enter URL, validate, fill details, review, and publish"
    - "Published Link Existing resource appears on the creator's dashboard"
    - "Published Link Existing resource has a working detail page at its slug URL"
    - "Proxy, Claude Prompt, and OpenRouter publish flows continue to work unchanged"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      provides: "Saves full verification data to linkConfig for publish step"
      contains: "payTo"
    - path: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      provides: "Routes Link Existing to POST /resources and instant types to POST /resources/instant"
      contains: "authenticatedFetch(\"/resources\""
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      to: "linkConfig in session storage"
      via: "saveDraft({ linkConfig: { ...fullVerificationData } })"
      pattern: "linkConfig.*payTo"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "POST /resources"
      via: "authenticatedFetch for link type"
      pattern: "authenticatedFetch.*\"/resources\""
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "POST /resources/instant"
      via: "authenticatedFetch for proxy/claude/openrouter types"
      pattern: "authenticatedFetch.*\"/resources/instant\""
---

<objective>
Route Link Existing publish to the correct backend endpoint (POST /resources) while keeping instant resource types on their existing endpoint (POST /resources/instant).

Purpose: Link Existing publish currently sends to /resources/instant which rejects "external" as an invalid resourceType, causing a 400 error. This is the last broken flow in the v2.0 wizard.

Output: Both files updated so the full Link Existing E2E flow works, and all other resource types remain unaffected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-fix-link-existing-publish/26-RESEARCH.md

@apps/web/src/app/dashboard/resources/new/link/page.tsx
@apps/web/src/app/dashboard/resources/new/review/page.tsx
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/lib/x402-verify.ts
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Save full verification data to linkConfig on link validation page</name>
  <files>apps/web/src/app/dashboard/resources/new/link/page.tsx</files>
  <action>
In the `handleContinue` function (around line 108-138), expand the `saveDraft` call to store the full verification data needed by the POST /resources endpoint.

Currently `linkConfig` only saves `{ url, method }`. Update it to include all fields the backend needs:

```typescript
linkConfig: {
  url: verifyResponse.normalizedUrl || url,
  method: method,
  // Fields needed for POST /resources (external registration)
  payTo: verifyResponse.resource.payTo,
  maxAmountRequired: verifyResponse.resource.maxAmountRequired,
  asset: verifyResponse.resource.asset,
  mimeType: verifyResponse.resource.mimeType,
  maxTimeoutSeconds: verifyResponse.resource.maxTimeoutSeconds,
  outputSchema: verifyResponse.resource.outputSchema,
  isA2A: verifyResponse.resource.isA2A,
  supportsRefunds: false, // x402check does not extract this; default to false
  description: verifyResponse.resource.description,
  avatarUrl: verifyResponse.resource.avatarUrl,
},
```

The `verifyResponse.resource` object (type `VerifiedResource` from `@/lib/x402-verify`) already contains all these fields, populated by `processVerifyResponse()`. The `summary[0]` data feeds into `resource` during processing, so we read from `verifyResponse.resource` which has the normalized values.

Keep the existing top-level draft fields (`resourceUrl`, `network`, `price`, `preFilled`) unchanged -- those feed the details step. The new linkConfig fields feed the review/publish step.

Do NOT change the form, validation logic, URL clearing behavior, or any UI elements. Only expand what gets saved to `linkConfig` in `handleContinue`.
  </action>
  <verify>
Run `npx tsc --noEmit` from the apps/web directory to confirm no type errors. Verify the saveDraft call includes all required POST /resources fields (resourceUrl, network, name, payTo are the 4 required backend fields -- resourceUrl and network come from other draft fields, name from details step, payTo now from linkConfig).
  </verify>
  <done>
The link validation page saves payTo, maxAmountRequired, asset, mimeType, maxTimeoutSeconds, outputSchema, isA2A, supportsRefunds, description, and avatarUrl to linkConfig alongside the existing url and method fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Route Link Existing publish to POST /resources with correct body</name>
  <files>apps/web/src/app/dashboard/resources/new/review/page.tsx</files>
  <action>
Modify the `handlePublish` function to split into two paths based on `draft.type`:

**For Link Existing (`draft.type === "link"`):**

Build the body for POST /resources (external registration):

```typescript
if (draft.type === "link") {
  const lc = draft.linkConfig as Record<string, unknown>;

  const body: Record<string, unknown> = {
    resourceUrl: lc.url as string,
    network: draft.network,
    name: draft.name!.trim(),
    payTo: lc.payTo as string,
    description: draft.description?.trim() || (lc.description as string) || null,
    category: draft.category,
    avatarUrl: draft.imageUrl?.trim() || (lc.avatarUrl as string) || null,
    maxAmountRequired: lc.maxAmountRequired as string,
    asset: lc.asset as string | undefined,
    mimeType: lc.mimeType as string | undefined,
    maxTimeoutSeconds: lc.maxTimeoutSeconds as number | undefined,
    outputSchema: lc.outputSchema as object | undefined,
    isA2A: lc.isA2A as boolean | undefined,
    supportsRefunds: lc.supportsRefunds as boolean | undefined,
  };

  const res = await authenticatedFetch("/resources", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });

  if (!res.ok) {
    const errorData = await res.json();
    throw new Error(errorData.error || "Failed to create resource");
  }

  // External endpoint returns { resource, server, updated }
  // Use resource.slug for redirect (API generates the slug, we don't send one)
  const data = await res.json();
  clearDraft();
  router.push(`/${username}/${data.resource.slug}`);
  return;
}
```

**For Instant types (proxy, claude, openrouter):**

Keep the existing body construction and `/resources/instant` endpoint call exactly as-is. The existing code on lines 60-109 handles these types correctly. Just wrap it in an `else` block or move the link block above so it returns early.

Key differences between the two paths:
1. **Endpoint:** `/resources` vs `/resources/instant`
2. **No `resourceType` field** for link (backend infers external)
3. **No `slug` field** for link (backend generates it from name+network)
4. **No `priceUsdc` field** for link (uses `maxAmountRequired` in lamports/wei instead)
5. **`payTo` required** for link (from verification data)
6. **Response redirect:** Use `data.resource.slug` for link (vs `draft.slug` for instant)

Do NOT change:
- The TYPE_TO_API or TYPE_DISPLAY maps (still used for display in instant path)
- The review page UI/rendering (no visual changes)
- Any imports except adding what's needed
- The existing instant publish path (proxy, claude, openrouter must work exactly as before)
  </action>
  <verify>
1. Run `npx tsc --noEmit` from the apps/web directory to confirm no type errors.
2. Visually inspect the handlePublish function to confirm:
   - Link type calls `authenticatedFetch("/resources", ...)` with body containing `resourceUrl`, `network`, `name`, `payTo`, `maxAmountRequired`
   - Link type does NOT send `resourceType`, `slug`, or `priceUsdc`
   - Link type redirects using `data.resource.slug` from the API response
   - Proxy/claude/openrouter still call `authenticatedFetch("/resources/instant", ...)` with the original body format
   - Proxy/claude/openrouter still redirect using `draft.slug`
  </verify>
  <done>
Link Existing type publishes to POST /resources with the correct external registration body format. Instant types (proxy, claude, openrouter) continue to publish to POST /resources/instant unchanged. The review page handles both response formats for redirect navigation.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes from apps/web directory
2. Code inspection: link/page.tsx `saveDraft` call includes payTo, maxAmountRequired, asset fields in linkConfig
3. Code inspection: review/page.tsx has separate publish paths -- link goes to `/resources`, instant types go to `/resources/instant`
4. Code inspection: No changes to proxy/claude/openrouter publish logic
</verification>

<success_criteria>
1. Link Existing publish routes to POST /resources with resourceUrl, network, name, payTo, maxAmountRequired, and optional fields from verification
2. Instant types (proxy, claude, openrouter) continue routing to POST /resources/instant with unchanged body format
3. Link Existing redirect uses the API-generated slug from the response (data.resource.slug)
4. TypeScript compilation passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-fix-link-existing-publish/26-01-SUMMARY.md`
</output>
