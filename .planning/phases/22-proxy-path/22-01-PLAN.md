---
phase: 22-proxy-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/dashboard/resources/new/proxy/page.tsx
  - apps/web/src/app/dashboard/resources/new/details/page.tsx
  - apps/web/src/app/dashboard/resources/new/review/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter an origin URL on the proxy config page"
    - "User can select an HTTP method from GET, POST, PUT, DELETE, PASS"
    - "User can optionally add an auth header in a collapsible section"
    - "Continue button is enabled when a valid URL is provided"
    - "Continue button is disabled when URL is empty or invalid"
    - "Proxy config persists through details and appears on review page"
    - "User can publish a proxy resource end-to-end"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/proxy/page.tsx"
      provides: "Proxy configuration wizard step with URL, method, auth header"
      min_lines: 80
    - path: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      provides: "Details page that preserves proxyConfig on submit"
      contains: "proxyConfig"
    - path: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      provides: "Review page displaying proxy origin URL, method, and auth header presence"
      contains: "proxyConfig"
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/proxy/page.tsx"
      to: "wizard-draft.ts"
      via: "saveDraft({ proxyConfig: { originUrl, method, authHeader } })"
      pattern: "saveDraft.*proxyConfig"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "wizard-draft.ts"
      via: "preserves proxyConfig from draft on submit"
      pattern: "proxyConfig"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "API /resources/instant"
      via: "maps proxyConfig to proxyOriginUrl, proxyMethod, proxyAuthHeader"
      pattern: "proxyOriginUrl.*proxyMethod"
---

<objective>
Implement the Proxy Path wizard step -- replace the stub proxy/page.tsx with a working form that lets users configure an origin URL, HTTP method, and optional auth header for wrapping a non-x402 endpoint with x402 payment protection. Also wire the details page to preserve proxyConfig and enhance the review page to display the full proxy configuration.

Purpose: This is the second of four resource type paths (after Link Existing). Once complete, users can create proxy resources end-to-end through the new wizard.

Output: Working proxy config page, updated details page, enhanced review page -- full proxy creation flow functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/app/dashboard/resources/new/proxy/page.tsx
@apps/web/src/app/dashboard/resources/new/link/page.tsx
@apps/web/src/app/dashboard/resources/new/details/page.tsx
@apps/web/src/app/dashboard/resources/new/review/page.tsx
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/components/ui/CollapsibleSection.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build proxy config page</name>
  <files>apps/web/src/app/dashboard/resources/new/proxy/page.tsx</files>
  <action>
Replace the entire stub proxy/page.tsx with a working proxy configuration form. Follow the link/page.tsx pattern closely for structure and conventions.

**Zod schema (proxySchema):**
- `originUrl`: z.string().min(1, "Origin URL is required").url("Must be a valid URL")
- `method`: z.enum(["GET", "POST", "PUT", "DELETE", "PASS"]) -- include PASS (forwards original request method, exists in codebase)
- `authHeader`: z.string().optional()

**Form setup:**
- react-hook-form with zodResolver(proxySchema)
- Default values: originUrl = "", method = "POST" (matches old modal default), authHeader = ""
- "use client" directive, double quotes, semicolons (Prettier formatting)

**Deep link protection:**
- Same pattern as link/page.tsx: check draft.type === "proxy", redirect if not

**Draft restoration:**
- On load, if draft.proxyConfig exists, restore form values from it (originUrl, method, authHeader). This lets users go back and edit.
- Use form.reset() with values from draft.proxyConfig after isLoaded is set

**Layout (inside WizardShell):**
- WizardShell with step={2}, totalSteps={4}, title="Configure Proxy", description="Set up your proxy endpoint", backHref="/dashboard/resources/new"
- Origin URL: label "Origin URL" with required asterisk, Input component from @x402jobs/ui/input, placeholder "https://api.example.com/endpoint"
- HTTP Method: label "HTTP Method" with required asterisk, render as button group (NOT dropdown). Five buttons for GET, POST, PUT, DELETE, PASS in a flex row. Active button gets "border-primary bg-primary/5 text-foreground", inactive gets "border-border hover:bg-accent". Use onClick to setValue("method", ...). Below buttons, helper text: "PASS forwards the original request method" in text-xs text-muted-foreground.
- Auth Header: Wrap in CollapsibleSection component (import from @/components/ui/CollapsibleSection). Title: "Authentication", defaultExpanded: false. Inside: label "Auth Header (optional)", Input with type="password", placeholder="Authorization: Bearer sk-...", register("authHeader"). Helper text below: "This header will be forwarded with every proxied request. Stored encrypted."

**Footer:**
- Single Continue button. Disabled when form is not valid (originUrl empty or invalid). Enabled when originUrl passes validation.
- On click: validate form, then saveDraft({ proxyConfig: { originUrl: data.originUrl, method: data.method, authHeader: data.authHeader || undefined } }), then router.push("/dashboard/resources/new/details")
- Wire as: footer prop renders Button with type="submit" form="proxy-form". The form's onSubmit calls handleContinue.

**Imports to use:**
- Input from "@x402jobs/ui/input"
- Button from "@x402jobs/ui/button"
- WizardShell from "@/components/wizard/WizardShell"
- getDraft, saveDraft from "@/lib/wizard-draft"
- CollapsibleSection from "@/components/ui/CollapsibleSection"
- useForm from "react-hook-form"
- zodResolver from "@hookform/resolvers/zod"
- z from "zod"
- useRouter from "next/navigation"
- useEffect, useState from "react"

**What NOT to do:**
- Do NOT use a dropdown/select for HTTP method (button group is better UX for 5 options)
- Do NOT implement dynamic key-value header pairs. The backend only supports a single proxyAuthHeader field. The CollapsibleSection with a single auth header input satisfies the "optional headers section" requirement while being compatible with the API.
- Do NOT add name/slug/price/description fields -- those are in the shared details page
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/web to confirm no TypeScript errors. Verify the file is no longer a stub (no "Coming in Phase 22" text). Check that all imports resolve.
  </verify>
  <done>
Proxy config page renders with origin URL input, 5-button HTTP method selector (GET/POST/PUT/DELETE/PASS with POST default), collapsible auth header section, and Continue button that saves proxyConfig to draft and navigates to /details. Form restores values from draft.proxyConfig when returning to edit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire details preservation and review display</name>
  <files>
    apps/web/src/app/dashboard/resources/new/details/page.tsx
    apps/web/src/app/dashboard/resources/new/review/page.tsx
  </files>
  <action>
**details/page.tsx -- Preserve proxyConfig on submit:**

In the onSubmit function (around line 169), the saveDraft call currently only preserves link-specific fields. Add proxyConfig preservation alongside the existing linkConfig line:

```
...(draft?.proxyConfig && { proxyConfig: draft.proxyConfig }),
```

Add this line right after the linkConfig preservation line (line 180). The full block should preserve all type-specific configs:
```typescript
// Preserve type-specific fields from config step
...(draft?.resourceUrl && { resourceUrl: draft.resourceUrl }),
...(draft?.preFilled && { preFilled: draft.preFilled }),
...(draft?.linkConfig && { linkConfig: draft.linkConfig }),
...(draft?.proxyConfig && { proxyConfig: draft.proxyConfig }),
```

**review/page.tsx -- Enhanced proxy config display:**

Replace the existing proxy originUrl IIFE block (lines 240-250, the one with `draft.proxyConfig?.originUrl`) with a proper proxy config display section. Add it right after the link config display block (after line 272), following the same pattern:

```typescript
{draft.type === "proxy" && draft.proxyConfig && (() => {
  const proxyConfig = draft.proxyConfig as {
    originUrl?: string;
    method?: string;
    authHeader?: string;
  };
  return (
    <div className="mt-3 space-y-2">
      <div>
        <dt className="text-sm text-muted-foreground">Origin URL</dt>
        <dd className="text-sm font-mono text-foreground break-all">
          {proxyConfig.originUrl || ""}
        </dd>
      </div>
      {proxyConfig.method && (
        <div>
          <dt className="text-sm text-muted-foreground">HTTP Method</dt>
          <dd className="text-sm font-medium text-foreground">
            {proxyConfig.method}
          </dd>
        </div>
      )}
      {proxyConfig.authHeader && (
        <div>
          <dt className="text-sm text-muted-foreground">Auth Header</dt>
          <dd className="text-sm text-foreground">Configured (encrypted on publish)</dd>
        </div>
      )}
    </div>
  );
})()}
```

IMPORTANT: Remove the old proxy originUrl IIFE (lines 240-250) that was a placeholder. The new proxy config block replaces it entirely. Do not leave both.

Also verify the handlePublish body mapping for proxy (lines 80-86) is correct. It already maps:
- proxyOriginUrl from proxyConfig.originUrl
- proxyMethod from proxyConfig.method
- proxyAuthHeader from proxyConfig.authHeader

This matches the backend API expectations. No changes needed to the publish handler.
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/web. Grep details/page.tsx for "proxyConfig" to confirm preservation is present. Grep review/page.tsx for "proxyConfig" and confirm both the display section and the publish mapping exist.
  </verify>
  <done>
Details page preserves proxyConfig when saving draft (so proxy config survives the details step). Review page shows origin URL, HTTP method, and auth header presence in the Configuration section. Publish handler correctly maps proxyConfig fields to API body.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end build and flow</name>
  <files></files>
  <action>
Run the full build to ensure everything compiles:

1. Run `pnpm build` from the workspace root (or `npx next build` from apps/web) to confirm the proxy page, details page, and review page all compile without errors.

2. Verify no regressions by checking:
   - link/page.tsx still works (grep for "linkConfig" in details/page.tsx)
   - No duplicate proxy display code in review/page.tsx
   - The old stub text "Coming in Phase 22" does not appear anywhere

3. If there are any build errors, fix them before marking complete.

4. Run `pnpm lint` from apps/web to catch any lint issues.
  </action>
  <verify>
`pnpm build` exits 0. No TypeScript errors. No lint errors. Grep for "Coming in Phase 22" returns zero results in the codebase.
  </verify>
  <done>
Full project builds cleanly. All three modified files compile without errors. No regressions to existing link path. No stale stub content remains.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors in apps/web
2. `pnpm build` completes successfully
3. proxy/page.tsx contains: origin URL input, method button group (5 buttons), CollapsibleSection with auth header, saveDraft with proxyConfig
4. details/page.tsx onSubmit preserves both linkConfig AND proxyConfig
5. review/page.tsx displays proxy origin URL, method, and auth header status
6. review/page.tsx publish handler maps proxyConfig to proxyOriginUrl, proxyMethod, proxyAuthHeader
7. No "Coming in Phase 22" text remains in codebase
</verification>

<success_criteria>
- PRXY-01: Origin URL input field present with URL validation
- PRXY-02: HTTP method selector with GET, POST, PUT, DELETE, PASS as button group
- PRXY-03: Auth header in collapsible "Authentication" section with add/remove (single field, matches backend capability)
- PRXY-04: Continue button enabled when valid URL provided, disabled when empty/invalid
- Full flow works: select Proxy type -> configure proxy -> fill details -> review shows proxy config -> publish sends correct API body
</success_criteria>

<output>
After completion, create `.planning/phases/22-proxy-path/22-01-SUMMARY.md`
</output>
