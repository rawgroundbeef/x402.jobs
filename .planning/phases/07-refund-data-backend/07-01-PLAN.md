---
phase: 07-refund-data-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/004_add_supports_refunds.sql
  - src/components/modals/RegisterResourceModal.tsx
  - src/components/modals/CreateResourceModal.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Apply migration to database"
    dashboard_config:
      - task: "Run migration 004_add_supports_refunds.sql"
        location: "Supabase Dashboard -> SQL Editor"
  - service: external-api
    why: "Backend API at API_URL must be updated to accept and store supportsRefunds field"
    note: "This plan creates the database schema and frontend pass-through. The external backend API (at API_URL) must be separately updated to: (1) accept supportsRefunds in POST /api/v1/resources body, (2) store it in the x402_resources table."

must_haves:
  truths:
    - "Database schema includes supports_refunds BOOLEAN column on x402_resources table"
    - "Frontend passes supportsRefunds from x402 response to registration API call"
    - "Migration file is ready for manual application via Supabase Dashboard"
  artifacts:
    - path: "migrations/004_add_supports_refunds.sql"
      provides: "Database column and view update"
      contains: "supports_refunds BOOLEAN"
    - path: "src/components/modals/RegisterResourceModal.tsx"
      provides: "Pass supportsRefunds to API"
      pattern: "supportsRefunds.*extra"
    - path: "src/components/modals/CreateResourceModal.tsx"
      provides: "Pass supportsRefunds to API"
      pattern: "supportsRefunds"
  key_links:
    - from: "RegisterResourceModal.tsx"
      to: "authenticatedFetch (external API at API_URL)"
      via: "POST body includes supportsRefunds field extracted from acceptOption.extra"
      pattern: "supportsRefunds.*acceptOption\\.extra"
      note: "API_URL points to external backend service - this plan sends the field, backend must be updated separately to receive it"
---

<objective>
Add database schema and frontend pass-through for supportsRefunds field.

Purpose: Enable the refund badge (Phase 6) to display actual data by storing supports_refunds extracted from x402 responses.
Output: Migration file for database schema, updated registration modals to pass supportsRefunds through to API.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-refund-data-backend/07-RESEARCH.md
@.planning/phases/06-refund-badge/06-01-SUMMARY.md

# Key source files

@migrations/001_add_prompt_template_fields.sql
@src/components/modals/RegisterResourceModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for supports_refunds</name>
  <files>migrations/004_add_supports_refunds.sql</files>
  <action>
Create migration file that:
1. Adds `supports_refunds BOOLEAN DEFAULT false` column to `x402_resources` table
2. Updates `public_x402_resources` view to include both `is_a2a` and `supports_refunds` columns

Follow the pattern from `001_add_prompt_template_fields.sql`:

- Use `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`
- Use `CREATE OR REPLACE VIEW`
- Include `GRANT SELECT` for authenticated and anon roles
- Add `COMMENT ON COLUMN` for documentation

The view SELECT should include all existing columns from the current view PLUS:

- is_a2a (was missing from the view, exists on table)
- supports_refunds (new column)

Note: The migration will be applied manually by the user via Supabase Dashboard.
</action>
<verify>
File exists at migrations/004_add_supports_refunds.sql with:

- ALTER TABLE statement for supports_refunds column
- CREATE OR REPLACE VIEW statement including supports_refunds
- GRANT statements for both roles
  </verify>
  <done>Migration file ready for manual application</done>
  </task>

<task type="auto">
  <name>Task 2: Update registration modals to pass supportsRefunds</name>
  <files>
    src/components/modals/RegisterResourceModal.tsx
    src/components/modals/CreateResourceModal.tsx
  </files>
  <action>
Update both registration modals to extract and pass `supportsRefunds` from the x402 response:

**RegisterResourceModal.tsx:**
In the `handleRegister` function, when building the POST body (around line 240-256), add:

```typescript
supportsRefunds: acceptOption.extra?.supportsRefunds === true,
```

Add it after the `isA2A` line to follow the same pattern.

**CreateResourceModal.tsx:**
Find the equivalent registration POST body and add the same field. The modal handles "external" type resources which also go through x402 verification.

Look for where `isA2A` is being passed in the request body and add `supportsRefunds` in the same location.

Important:

- Use strict equality check `=== true` to handle undefined/null cases
- The field should default to `false` if not present in extra
- Do NOT change the VerifiedResource or AcceptOption interfaces (extra is already Record<string, unknown>)
  </action>
  <verify>
  Build passes: `npm run build`
  Grep confirms supportsRefunds added:
- `grep -n "supportsRefunds" src/components/modals/RegisterResourceModal.tsx`
- `grep -n "supportsRefunds" src/components/modals/CreateResourceModal.tsx`
  </verify>
  <done>Both modals pass supportsRefunds field to registration API</done>
  </task>

</tasks>

<verification>
1. Migration file exists and contains correct SQL syntax
2. Build passes without TypeScript errors
3. supportsRefunds is passed in both modal registration flows
</verification>

<success_criteria>

- migrations/004_add_supports_refunds.sql exists with column addition and view update
- RegisterResourceModal passes supportsRefunds from acceptOption.extra
- CreateResourceModal passes supportsRefunds from verification response
- Build succeeds with no TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/07-refund-data-backend/07-01-SUMMARY.md`
</output>
