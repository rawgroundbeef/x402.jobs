---
phase: 05-payment-logging
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/003_add_usage_logs.sql
  - migrations/README.md
  - x402-jobs-api/src/routes/instant.ts
  - x402-jobs-api/src/routes/usage-history.ts
  - x402-jobs-api/src/index.ts
  - src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Each execution creates a usage log entry (success or failure)"
    - "Usage logs capture template_id, caller, status, token counts"
    - "Caller can view their execution history for this template"
  artifacts:
    - path: "migrations/003_add_usage_logs.sql"
      provides: "x402_prompt_template_usage_logs table"
      contains: "CREATE TABLE x402_prompt_template_usage_logs"
    - path: "x402-jobs-api/src/routes/instant.ts"
      provides: "Usage logging after execution"
      contains: "logPromptTemplateUsage"
    - path: "x402-jobs-api/src/routes/usage-history.ts"
      provides: "Caller history endpoint"
      exports: ["usageHistoryRouter"]
    - path: "src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx"
      provides: "History display UI"
      contains: "execution history"
  key_links:
    - from: "x402-jobs-api/src/routes/instant.ts"
      to: "x402_prompt_template_usage_logs"
      via: "logPromptTemplateUsage function"
      pattern: "x402_prompt_template_usage_logs"
    - from: "x402-jobs-api/src/routes/usage-history.ts"
      to: "x402_prompt_template_usage_logs"
      via: "SELECT query with caller filter"
      pattern: "from.*x402_prompt_template_usage_logs.*where"
    - from: "src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx"
      to: "/api/v1/resources/:id/usage-history"
      via: "SWR fetch"
      pattern: "useSWR.*usage-history"
---

<objective>
Add usage logging for prompt template executions and display caller's execution history.

Purpose: Enable analytics (EXEC-07) and give callers visibility into their past executions (CALL-09).
Output: Database table for logs, backend logging after execution, history endpoint, and UI display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payment-logging/05-RESEARCH.md

# Key existing files to reference

@x402-jobs-api/src/routes/instant.ts
@migrations/002_add_claude_integration.sql
@migrations/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usage logs migration</name>
  <files>migrations/003_add_usage_logs.sql, migrations/README.md</files>
  <action>
Create SQL migration for the usage logs table:

```sql
-- Migration: 003_add_usage_logs.sql
-- Purpose: Add usage logging for prompt template executions

-- Create usage logs table
CREATE TABLE IF NOT EXISTS x402_prompt_template_usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID NOT NULL,
  caller_id UUID NOT NULL,

  -- Execution details
  status TEXT NOT NULL CHECK (status IN ('success', 'failed')),
  error_message TEXT,

  -- Token usage (from Claude response)
  input_tokens INTEGER,
  output_tokens INTEGER,

  -- Payment details
  amount_paid NUMERIC(10, 6),
  payment_signature TEXT,
  network TEXT,

  -- Timing
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  execution_time_ms INTEGER,

  -- Foreign keys
  CONSTRAINT fk_template FOREIGN KEY (template_id)
    REFERENCES x402_resources(id) ON DELETE CASCADE,
  CONSTRAINT fk_caller FOREIGN KEY (caller_id)
    REFERENCES auth.users(id) ON DELETE CASCADE
);

-- Indexes for common queries
CREATE INDEX idx_ptul_template_id ON x402_prompt_template_usage_logs(template_id);
CREATE INDEX idx_ptul_caller_id ON x402_prompt_template_usage_logs(caller_id);
CREATE INDEX idx_ptul_created_at ON x402_prompt_template_usage_logs(created_at DESC);
CREATE INDEX idx_ptul_template_caller ON x402_prompt_template_usage_logs(template_id, caller_id);

-- RLS: Users can only read their own usage logs
ALTER TABLE x402_prompt_template_usage_logs ENABLE ROW LEVEL SECURITY;

-- Policy: Users can read their own logs
CREATE POLICY "Users can read own usage logs"
  ON x402_prompt_template_usage_logs
  FOR SELECT
  TO authenticated
  USING (auth.uid() = caller_id);

-- Policy: Service role can insert (backend writes logs)
CREATE POLICY "Service role can insert usage logs"
  ON x402_prompt_template_usage_logs
  FOR INSERT
  TO service_role
  WITH CHECK (true);

-- Policy: Template owners can read all logs for their templates
CREATE POLICY "Owners can read template usage logs"
  ON x402_prompt_template_usage_logs
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM x402_resources r
      JOIN x402_servers s ON r.server_id = s.id
      WHERE r.id = template_id
      AND (s.registered_by = auth.uid() OR s.verified_owner_id = auth.uid())
    )
  );
```

Update migrations/README.md to include migration 003 instructions.
</action>
<verify>

1. SQL syntax is valid (check with a linter or visual inspection)
2. README updated with new migration entry
   </verify>
   <done>

- Migration file exists at migrations/003_add_usage_logs.sql
- Table has all required columns: template_id, caller_id, status, tokens, payment, timing
- RLS policies allow users to read their own logs
- README includes migration 003
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add logging to execution flow</name>
  <files>x402-jobs-api/src/routes/instant.ts</files>
  <action>
Add a logging function and integrate it into executePromptTemplate:

1. Create logPromptTemplateUsage function:

```typescript
async function logPromptTemplateUsage(params: {
  templateId: string;
  callerId: string;
  status: "success" | "failed";
  errorMessage?: string;
  inputTokens?: number;
  outputTokens?: number;
  amountPaid?: number;
  paymentSignature?: string;
  network?: string;
  executionTimeMs?: number;
}): Promise<void> {
  const supabase = getSupabase();

  try {
    await supabase.from("x402_prompt_template_usage_logs").insert({
      template_id: params.templateId,
      caller_id: params.callerId,
      status: params.status,
      error_message: params.errorMessage,
      input_tokens: params.inputTokens,
      output_tokens: params.outputTokens,
      amount_paid: params.amountPaid,
      payment_signature: params.paymentSignature,
      network: params.network,
      execution_time_ms: params.executionTimeMs,
      created_at: new Date().toISOString(),
    });
  } catch (err) {
    // Log but don't fail execution if logging fails
    console.error("[Instant] Failed to log usage:", err);
  }
}
```

2. Update executePromptTemplateStreaming to return usage info:
   - After streaming completes, the finalMessage already has usage
   - Return { inputTokens, outputTokens } alongside the streamed flag

3. Update executePromptTemplate to:
   - Record startTime before execution
   - Receive usage data from streaming
   - Call logPromptTemplateUsage with all available data
   - Handle both success and failure cases

4. In the main handler (instantRouter.all):
   - Pass callerId (req.user?.id) to executePromptTemplate
   - Pass payment info (txHash, priceUsdc, network) to executePromptTemplate
   - For owner test mode, log with amountPaid: 0

Important: The caller_id may be null for unauthenticated requests. Handle this by:

- Only logging if req.user?.id exists
- For anonymous callers, skip logging (they can't view history anyway)
  </action>
  <verify>

1. TypeScript compiles: `cd x402-jobs-api && npm run build`
2. Manual test: Execute a template, check database for log entry
   </verify>
   <done>

- logPromptTemplateUsage function exists and handles all fields
- Successful executions create log with status='success' and token counts
- Failed executions create log with status='failed' and error message
- Logging failures don't break execution
  </done>
  </task>

<task type="auto">
  <name>Task 3: Create usage history endpoint and UI</name>
  <files>x402-jobs-api/src/routes/usage-history.ts, x402-jobs-api/src/index.ts, src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx</files>
  <action>
Create backend endpoint:

1. Create x402-jobs-api/src/routes/usage-history.ts:

```typescript
import { Router } from "express";
import type { Router as RouterType } from "express";
import { getSupabase } from "../lib/supabase";

export const usageHistoryRouter: RouterType = Router();

// GET /api/v1/resources/:templateId/usage-history
usageHistoryRouter.get(
  "/resources/:templateId/usage-history",
  async (req, res) => {
    const userId = req.user?.id;
    if (!userId) {
      return res.status(401).json({ error: "Authentication required" });
    }

    const templateId = req.params.templateId;
    const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);
    const offset = parseInt(req.query.offset as string) || 0;

    const supabase = getSupabase();

    // Get user's executions for this template
    const {
      data: logs,
      error,
      count,
    } = await supabase
      .from("x402_prompt_template_usage_logs")
      .select(
        "id, status, created_at, amount_paid, input_tokens, output_tokens, execution_time_ms, error_message",
        { count: "exact" },
      )
      .eq("template_id", templateId)
      .eq("caller_id", userId)
      .order("created_at", { ascending: false })
      .range(offset, offset + limit - 1);

    if (error) {
      console.error("[UsageHistory] Error:", error);
      return res.status(500).json({ error: "Failed to fetch history" });
    }

    return res.json({
      executions: logs || [],
      pagination: {
        total: count || 0,
        offset,
        limit,
      },
    });
  },
);
```

2. Register router in x402-jobs-api/src/index.ts:
   - Import usageHistoryRouter
   - Add: `app.use("/api/v1", authMiddleware, usageHistoryRouter);`
   - Place after resources router registration

3. Update PromptTemplateDetailPage.tsx:
   - Add useSWR hook to fetch history: `/api/v1/resources/${resource.id}/usage-history`
   - Only fetch when user is authenticated
   - Create collapsible "Your Executions" section below the main form
   - Show: timestamp, status (success/failed badge), tokens used, amount paid
   - Empty state: "No executions yet. Run this template to see your history."
   - Limit to 5 most recent, with "View all" link if more exist

UI styling:

- Muted section header "Your Executions"
- Small text, compact list
- Success = green dot, Failed = red dot
- Format timestamps as relative (e.g., "2 minutes ago")
  </action>
  <verify>

1. Backend: `cd x402-jobs-api && npm run build`
2. Frontend: `cd apps/x402-jobs && npm run build`
3. Manual test: Execute template, refresh page, verify history appears
   </verify>
   <done>

- GET /api/v1/resources/:templateId/usage-history returns user's executions
- PromptTemplateDetailPage shows execution history section
- History displays status, timestamp, tokens, and amount paid
- Empty state shown when no history exists
  </done>
  </task>

</tasks>

<verification>
- [ ] Migration file syntax is valid SQL
- [ ] Backend compiles: `cd x402-jobs-api && npm run build`
- [ ] Frontend compiles: `npm run build` in x402-jobs
- [ ] Usage log entry created after execution
- [ ] History endpoint returns user's executions
- [ ] UI displays execution history
</verification>

<success_criteria>

1. Each execution (success or failure) creates a usage log entry
2. Logs capture template_id, caller_id, status, input/output tokens, amount paid
3. Caller can view their execution history on the template detail page
4. History shows timestamp, status, tokens used, and amount paid
5. RLS ensures users only see their own logs
   </success_criteria>

<output>
After completion, create `.planning/phases/05-payment-logging/05-02-SUMMARY.md`
</output>
