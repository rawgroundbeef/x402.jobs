---
phase: 05-payment-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Run initiates x402 payment flow with creator as recipient"
    - "Payment amount matches the creator's configured price markup"
    - "After successful payment, execution proceeds automatically"
    - "Non-owners must pay to execute (owners still free via X-OWNER-TEST)"
  artifacts:
    - path: "src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx"
      provides: "Payment-integrated execution flow"
      contains: "/api/execute"
  key_links:
    - from: "src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx"
      to: "/api/execute"
      via: "authenticatedFetch POST"
      pattern: "authenticatedFetch.*api/execute"
    - from: "/api/execute"
      to: "/instant/@username/slug"
      via: "resourceUrl parameter"
      pattern: "resourceUrl"
---

<objective>
Integrate x402 payment flow into the prompt template detail page so non-owners must pay before execution.

Purpose: Complete the monetization loop - callers pay creators via x402, which is the core value proposition.
Output: Updated PromptTemplateDetailPage that routes execution through /api/execute endpoint for payment handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payment-logging/05-RESEARCH.md

# Key existing files to reference

@src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx
@x402-jobs-api/src/routes/execute.ts
@x402-jobs-api/src/routes/instant.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate /api/execute for payment flow</name>
  <files>src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx</files>
  <action>
Update handleSubmit to use the /api/execute endpoint for non-owner executions:

1. Keep the existing owner test flow (direct /instant call with X-OWNER-TEST header) for free testing
2. For non-owners, call `/api/execute` with:
   - resourceUrl: Full URL to instant endpoint (e.g., "https://api.x402.jobs/instant/@username/slug")
   - method: "POST"
   - body: { ...formData, user_message: userMessage (if present) }

3. Parse the /api/execute response:
   - If response.paid is true, extract result from response.data.response
   - Show payment confirmation with amount paid
   - Extract response.data.response for the Claude output

4. Handle 402 errors specifically:
   - Check for response.status === 402
   - Show "Insufficient USDC balance" with required amount from error details
   - Include link to deposit funds

5. Add state for payment info:
   - paymentInfo: { amount: number, signature: string } | null
   - Show payment receipt after successful execution (amount paid, tx link if available)

Use API_URL from config.ts for the instant endpoint base URL. The /api/execute endpoint is at `/api/execute` (relative to the Next.js app, not the API server).

Important: The /api/execute endpoint expects the full resourceUrl including protocol, so use:
`${API_URL}/instant/@${serverSlug.replace('@', '')}/${resourceSlug}`

Note: API_URL points to the x402-jobs-api server (e.g., https://api.x402.jobs).
</action>
<verify>

1. Build passes: `npm run build` in x402-jobs directory
2. TypeScript: No type errors
3. Manual test: Open a prompt template detail page as non-owner, verify Run button triggers payment flow
   </verify>
   <done>

- Non-owner clicks Run and sees payment confirmation after execution
- Payment amount displayed matches resource price
- Owner clicks Run (Free) and execution works without payment
- Insufficient balance shows helpful error with deposit suggestion
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add payment confirmation UI</name>
  <files>src/components/pages/PromptTemplateDetailPage/PromptTemplateDetailPage.tsx</files>
  <action>
Add a payment confirmation section that displays after successful paid execution:

1. Create PaymentReceipt component (inline in the file) that shows:
   - Amount paid in USDC (e.g., "$0.05 USDC")
   - Transaction signature (truncated, with copy button)
   - Network badge (Base or Solana icon)
   - Optional: Link to block explorer for the transaction

2. Display the receipt below the result output when paymentInfo is set

3. Add visual styling:
   - Green check icon for successful payment
   - Subtle background (bg-emerald-50/50 dark:bg-emerald-950/20)
   - Compact layout that doesn't distract from the output

4. Import DollarSign from lucide-react for the payment icon

The receipt should be informative but not overwhelming - the output is the main attraction.
</action>
<verify>

1. Manual test: Execute as non-owner, verify payment receipt appears
2. Check receipt shows correct amount
3. Verify transaction signature displays (truncated)
   </verify>
   <done>

- Payment receipt displays after successful paid execution
- Shows amount, transaction signature, network
- Styling is subtle and professional
  </done>
  </task>

</tasks>

<verification>
- [ ] `npm run build` passes in x402-jobs directory
- [ ] Non-owner execution triggers payment flow via /api/execute
- [ ] Owner execution still works free (X-OWNER-TEST header preserved)
- [ ] Payment receipt displays after successful paid execution
- [ ] Insufficient balance error is user-friendly
</verification>

<success_criteria>

1. Clicking "Run" as non-owner initiates x402 payment flow
2. Payment amount matches creator's configured price
3. After successful payment, execution proceeds and result displays
4. Payment receipt shows amount paid and transaction details
5. Owner testing still works without payment
   </success_criteria>

<output>
After completion, create `.planning/phases/05-payment-logging/05-01-SUMMARY.md`
</output>
