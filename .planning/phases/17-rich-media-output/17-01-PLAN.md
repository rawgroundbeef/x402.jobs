---
phase: 17-rich-media-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/x402-jobs-api/src/routes/instant.ts
autonomous: true

must_haves:
  truths:
    - "Image model requests include modalities parameter"
    - "Image model responses extract images from message.images array"
    - "Response includes modality field indicating output type"
    - "Text models continue working unchanged"
    - "Unsupported modalities return graceful error"
  artifacts:
    - path: "apps/x402-jobs-api/src/routes/instant.ts"
      provides: "Modality-aware executeOpenRouterInstant function"
      contains: "modalities.*image.*text"
  key_links:
    - from: "executeOpenRouterInstant"
      to: "ai_models.modality"
      via: "Supabase query for model modality"
      pattern: "select.*modality.*from.*ai_models"
    - from: "executeOpenRouterInstant"
      to: "OpenRouter API"
      via: "modalities parameter in request"
      pattern: "modalities.*\\[.*image.*\\]"
---

<objective>
Add modality-aware request/response handling to executeOpenRouterInstant for image model support.

Purpose: Enable OpenRouter image models (like DALL-E, Stable Diffusion) to generate and return images to callers. Per research, video/audio outputs are not widely supported on OpenRouter - focus on image models with graceful fallback for unsupported modalities.

Output: Extended executeOpenRouterInstant that detects model modality, adds appropriate request parameters, and extracts images from responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-rich-media-output/17-RESEARCH.md
@.planning/phases/16-execution-backend/16-01-SUMMARY.md

# Key source files

@apps/x402-jobs-api/src/routes/instant.ts
@apps/x402-jobs-api/src/inngest/functions/sync-openrouter-models.ts

# Database context

The `ai_models.modality` column is provided by the Phase 12 migration:
`apps/x402-jobs/migrations/006_add_ai_models_curation.sql`

This migration adds the modality column (text, image, audio, video) to ai_models.
It is documented in STATE.md as a manual migration task. The column already exists
in the database and can be queried directly.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add modality lookup and request building</name>
  <files>apps/x402-jobs-api/src/routes/instant.ts</files>
  <action>
Extend the executeOpenRouterInstant function to:

1. **Modify the ai_models query to include modality:**
   Change the existing query from:

   ```typescript
   const { data: model } = await getSupabase()
     .from("ai_models")
     .select("name")
     .eq("id", resource.openrouter_model_id)
     .single();
   ```

   To:

   ```typescript
   const { data: model } = await getSupabase()
     .from("ai_models")
     .select("name, modality")
     .eq("id", resource.openrouter_model_id)
     .single();
   ```

2. **Build request with modality awareness:**
   After creating the base request object, add modalities parameter for image models:

   ```typescript
   // Build base request
   const requestBody: Record<string, unknown> = {
     model: modelId,
     messages,
     temperature: config.temperature ?? 1.0,
     max_tokens: config.maxTokens ?? 4096,
     top_p: config.topP ?? 1.0,
     frequency_penalty: config.frequencyPenalty,
     presence_penalty: config.presencePenalty,
     stream: false,
   };

   // Enable image generation for image models (required by OpenRouter)
   if (model.modality === "image") {
     requestBody.modalities = ["image", "text"];
   }
   ```

3. **Update the API call to use the new request body:**
   Change from inline parameters to using the requestBody object:
   ```typescript
   const response = await client.chat.completions.create(requestBody as any);
   ```

Note: The `as any` cast is needed because OpenAI SDK types don't include `modalities` parameter, but OpenRouter accepts it.
</action>
<verify>

1. TypeScript compiles without errors:

```bash
cd apps/x402-jobs-api && npx tsc --noEmit
```

2. Verify modality field added to query:

```bash
grep -n "modality" apps/x402-jobs-api/src/routes/instant.ts | grep -i "select"
```

  </verify>
  <done>
- ai_models query includes modality field
- Image models get `modalities: ["image", "text"]` in request
- Text models continue working unchanged (no modalities parameter)
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract images from response and return structured output</name>
  <files>apps/x402-jobs-api/src/routes/instant.ts</files>
  <action>
Extend the executeOpenRouterInstant function to extract images and return structured response:

1. **Define response type at module level (after InstantResource interface):**

   ```typescript
   interface OpenRouterInstantResult {
     response: string;
     modality: "text" | "image" | "audio" | "video";
     usage: {
       input_tokens?: number;
       output_tokens?: number;
     };
     images?: Array<{
       url: string; // Base64 data URL (data:image/png;base64,...)
     }>;
   }
   ```

2. **Add helper function to extract media from response (before executeOpenRouterInstant):**

   ```typescript
   /**
    * Extract media content from OpenRouter response.
    * OpenRouter returns images in message.images array (not standard OpenAI format).
    */
   function extractMediaFromResponse(
     response: OpenAI.Chat.Completions.ChatCompletion,
     modelModality: string,
   ): {
     type: "text" | "image";
     content: string;
     images?: Array<{ url: string }>;
   } {
     const message = response.choices[0]?.message;
     const textContent = message?.content || "";

     // Check for images in response (OpenRouter-specific field)
     const images = (message as any)?.images;

     if (images && Array.isArray(images) && images.length > 0) {
       return {
         type: "image",
         content: textContent,
         images: images
           .map((img: any) => ({
             url: img.image_url?.url || img.url || "",
           }))
           .filter((img: { url: string }) => img.url),
       };
     }

     return {
       type: "text",
       content: textContent,
     };
   }
   ```

3. **Update the success response handling in executeOpenRouterInstant:**
   After `const response = await client.chat.completions.create(...)`, replace the existing response extraction with:

   ```typescript
   // Extract media from response
   const mediaResult = extractMediaFromResponse(
     response,
     model.modality || "text",
   );

   const inputTokens = response.usage?.prompt_tokens;
   const outputTokens = response.usage?.completion_tokens;

   const executionTimeMs = Date.now() - startTime;

   // Log usage
   if (context.callerId) {
     await logPromptTemplateUsage({
       templateId: resource.id,
       callerId: context.callerId,
       status: "success",
       inputTokens,
       outputTokens,
       amountPaid: isOwnerTest ? 0 : context.amountPaid,
       paymentSignature: context.paymentSignature,
       network: context.network,
       executionTimeMs,
     });
   }

   // Build structured response
   const result: OpenRouterInstantResult = {
     response: mediaResult.content,
     modality: mediaResult.type,
     usage: {
       input_tokens: inputTokens,
       output_tokens: outputTokens,
     },
   };

   // Add images if present
   if (mediaResult.images && mediaResult.images.length > 0) {
     result.images = mediaResult.images;
   }

   return {
     json: true,
     response: result,
   };
   ```

4. **Handle unsupported modalities gracefully:**
   After the modality check for image models, add handling for video/audio:
   ```typescript
   // Warn for video/audio models (not widely supported on OpenRouter)
   if (model.modality === "video" || model.modality === "audio") {
     console.warn(
       `[Instant] Model ${modelId} has ${model.modality} modality - output may be text-only`,
     );
   }
   ```
     </action>
     <verify>
   TypeScript compiles without errors:

```bash
cd apps/x402-jobs-api && npx tsc --noEmit
```

  </verify>
  <done>

- OpenRouterInstantResult interface defined with modality and images fields
- extractMediaFromResponse helper extracts images from OpenRouter response
- Response includes modality field ("text" or "image")
- Images returned as array of {url} objects when present
- Video/audio modalities log warning but don't fail
  </done>
  </task>

</tasks>

<verification>
1. **TypeScript compilation:**
   ```bash
   cd apps/x402-jobs-api && npx tsc --noEmit
   ```
   Should complete without errors.

2. **Code verification (post-execution checks):**

   Verify extractMediaFromResponse function exists:

   ```bash
   grep -n "function extractMediaFromResponse" apps/x402-jobs-api/src/routes/instant.ts
   ```

   Verify OpenRouterInstantResult interface exists with required fields:

   ```bash
   grep -A 10 "interface OpenRouterInstantResult" apps/x402-jobs-api/src/routes/instant.ts
   ```

   Verify image extraction logic (checks for images array):

   ```bash
   grep -n "message as any.*images\|\.images" apps/x402-jobs-api/src/routes/instant.ts
   ```

   Verify modality field in response:

   ```bash
   grep -n "modality: mediaResult.type" apps/x402-jobs-api/src/routes/instant.ts
   ```

3. **Manual testing (if OpenRouter image model available):**
   - Create test resource with image model (e.g., "openai/dall-e-3" if available)
   - Execute via owner test mode
   - Verify response includes `images` array with base64 URLs
     </verification>

<success_criteria>

- MDIA-01 (text): Text model responses return `modality: "text"` with response content
- MDIA-02 (image): Image model responses return `modality: "image"` with images array containing base64 URLs
- MDIA-03 (video): Video models log warning and return text-only response (graceful degradation)
- MDIA-04 (audio): Audio models log warning and return text-only response (graceful degradation)
- No breaking changes to existing text model execution
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/17-rich-media-output/17-01-SUMMARY.md`
</output>
