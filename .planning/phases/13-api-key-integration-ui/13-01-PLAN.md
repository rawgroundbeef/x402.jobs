---
phase: 13-api-key-integration-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/x402-jobs-api/src/routes/integrations.ts
  - apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx
  - apps/x402-jobs/src/components/pages/AccountIntegrationsPage/AccountIntegrationsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see OpenRouter card in Settings -> Integrations"
    - "User can paste API key and save"
    - "User can update existing key"
    - "User can delete key with confirmation showing affected resource count"
    - "API key is encrypted before storage"
  artifacts:
    - path: "apps/x402-jobs-api/src/routes/integrations.ts"
      provides: "OpenRouter config GET/PUT/DELETE endpoints"
      exports: ["getCreatorOpenRouterApiKey"]
    - path: "apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx"
      provides: "OpenRouter integration card UI"
      min_lines: 150
  key_links:
    - from: "OpenRouterCard.tsx"
      to: "/integrations/openrouter/config"
      via: "useSWR and authenticatedFetch"
      pattern: "integrations/openrouter"
    - from: "OpenRouterCard.tsx handleDeleteClick"
      to: "/integrations/openrouter/affected-resources"
      via: "authenticatedFetch before showing dialog"
      pattern: "affected-resources"
    - from: "OpenRouterCard.tsx handleConfirmedDelete"
      to: "/integrations/openrouter/config DELETE"
      via: "authenticatedFetch then mutate SWR"
      pattern: "DELETE.*openrouter/config"
    - from: "integrations.ts PUT"
      to: "encryptSecret"
      via: "encryption before storage"
      pattern: "encryptSecret.*apiKey"
---

<objective>
Add OpenRouter API key integration card to Settings -> Integrations page.

Purpose: Users need to configure their OpenRouter API key before creating OpenRouter-powered resources. This follows the exact pattern established by ClaudeCard.

Output: Working OpenRouter integration card with full CRUD functionality (create/update/delete API key).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-api-key-integration-ui/13-CONTEXT.md
@.planning/phases/13-api-key-integration-ui/13-RESEARCH.md

Reference implementations:
@apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/ClaudeCard.tsx
@apps/x402-jobs-api/src/routes/integrations.ts (Claude routes lines 417-534)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenRouter backend routes to integrations.ts</name>
  <files>apps/x402-jobs-api/src/routes/integrations.ts</files>
  <action>
Add OpenRouter integration routes following the Claude pattern (lines 417-534 in integrations.ts):

1. **GET /integrations/openrouter/config** - Return config status (never the key)
   - Query `user_openrouter_integrations` table by user_id
   - Return `{ hasApiKey: boolean, isEnabled: boolean }`
   - Handle PGRST116 (no rows) as expected case

2. **PUT /integrations/openrouter/config** - Save/update encrypted API key
   - Accept `{ apiKey?: string, isEnabled?: boolean }`
   - If apiKey provided, encrypt with `encryptSecret(apiKey)` -> store as `encrypted_api_key`
   - If no apiKey and no existing key, return 400 error
   - Upsert to `user_openrouter_integrations` with `onConflict: "user_id"`
   - Return `{ success: true, hasApiKey: boolean, isEnabled: boolean }`

3. **DELETE /integrations/openrouter/config** - Delete integration
   - Delete from `user_openrouter_integrations` where user_id matches
   - Before delete, count affected resources: `x402_resources` where `user_id` matches AND `resource_type = 'openrouter_instant'`
   - Return `{ success: true, affectedResources: number }`

4. **GET /integrations/openrouter/affected-resources** - Get count of resources using this integration
   - Query `x402_resources` count where `user_id` matches AND `resource_type = 'openrouter_instant'`
   - Return `{ count: number }`

5. **Export function** `getCreatorOpenRouterApiKey(userId: string): Promise<string | null>`
   - Query `user_openrouter_integrations` for user_id
   - If no data, disabled, or no encrypted key, return null
   - Otherwise decrypt with `decryptSecret()` and return

Use existing imports: `encryptSecret`, `decryptSecret` from `../lib/instant/encrypt`
Use existing: `authMiddleware`, `getSupabase`
Table name: `user_openrouter_integrations` (NOT x402_user_openrouter_configs)
Column name: `encrypted_api_key` (NOT api_key_encrypted - see migration 005)
</action>
<verify>
Run TypeScript compilation:

```bash
cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api && npx tsc --noEmit
```

Verify no type errors in integrations.ts.

Verify all 4 endpoints exist in integrations.ts:

```bash
grep -E "\.get\(.*openrouter/config" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/integrations.ts
grep -E "\.put\(.*openrouter/config" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/integrations.ts
grep -E "\.delete\(.*openrouter/config" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/integrations.ts
grep -E "\.get\(.*openrouter/affected-resources" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/integrations.ts
```

All 4 grep commands should return matching lines.

Verify export function exists:

```bash
grep -q "export async function getCreatorOpenRouterApiKey" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/integrations.ts && echo "Export found"
```

</verify>
<done>
OpenRouter routes exported from integrations.ts. GET /config returns status, PUT /config encrypts and stores key, DELETE /config removes integration with affected count, GET /affected-resources returns count, getCreatorOpenRouterApiKey function exported for execution phase.
</done>
</task>

<task type="auto">
  <name>Task 2: Create OpenRouterCard component</name>
  <files>apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx</files>
  <action>
Create OpenRouterCard.tsx by cloning ClaudeCard.tsx structure with these changes:

1. **Interface**: `OpenRouterConfig` with `{ hasApiKey: boolean, isEnabled: boolean }`

2. **useSWR endpoint**: `/integrations/openrouter/config`

3. **Icon**: Use `Network` from lucide-react (represents routing/connectivity)
   - Color: `text-[#6366F1]` (indigo - distinct from Claude's coral)

4. **Card header**:
   - Title: "OpenRouter"
   - Description: "Access 200+ AI models with one API key"
   - Link: "openrouter.ai/keys" for API key retrieval

5. **Placeholder**: `sk-or-v1-...` (OpenRouter key format)

6. **Delete functionality** (new, not in ClaudeCard) - Explicit wiring sequence:
   - Add "Delete Integration" button (destructive variant) when hasApiKey and not editing
   - **handleDeleteClick function** (called when Delete button clicked):
     a) Set `isDeleting` state to `true`
     b) Fetch affected count: `authenticatedFetch('/integrations/openrouter/affected-resources')`
     c) Parse response and store count in `affectedCount` state
     d) Set `isDeleting` to `false`
     e) Open confirmation dialog: `setShowDeleteConfirm(true)`
   - **Confirmation Dialog content**:
     - Title: "Delete OpenRouter Integration?"
     - Description: If `affectedCount > 0`: "You have {affectedCount} resource(s) using this key. They will stop working."
     - Otherwise: "This will remove your OpenRouter API key."
     - Footer buttons: "Cancel" (ghost variant, calls `setShowDeleteConfirm(false)`) / "Delete Integration" (destructive variant, calls `handleConfirmedDelete`)
   - **handleConfirmedDelete function** (called when user confirms):
     a) Call `authenticatedFetch('/integrations/openrouter/config', { method: 'DELETE' })`
     b) On success: call `mutate()` to refresh SWR cache
     c) Close dialog: `setShowDeleteConfirm(false)`
     d) Reset `affectedCount` to 0
     e) Show success Alert

7. **State additions**:
   - `showDeleteConfirm: boolean` (default: false)
   - `affectedCount: number` (default: 0)
   - `isDeleting: boolean` (default: false)

8. **Imports needed**:
   - `Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter` from `@repo/ui/dialog`
   - `Network` from lucide-react

Keep all other patterns from ClaudeCard:

- Collapsed/expanded states
- Error/success Alert components
- Input clearing after save
- "Leave blank to keep existing key" helper text
- Cancel/Save button flow
  </action>
  <verify>
  Run: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npx tsc --noEmit`
  Verify component compiles without errors.

  Verify delete wiring exists:

  ```bash
  grep -E "affected-resources" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx
  grep -E "handleDeleteClick|handleConfirmedDelete" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx
  grep -E "showDeleteConfirm|affectedCount" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs/src/components/pages/AccountIntegrationsPage/components/OpenRouterCard.tsx
  ```

  All grep commands should return matches confirming the delete flow is wired.
  </verify>
  <done>
  OpenRouterCard.tsx created with full CRUD: view status, add/update key, delete with confirmation dialog showing affected resources. Delete flow explicitly wired: handleDeleteClick fetches count -> opens dialog -> handleConfirmedDelete calls DELETE -> mutates cache.
  </done>
  </task>

<task type="auto">
  <name>Task 3: Add OpenRouterCard to AccountIntegrationsPage</name>
  <files>apps/x402-jobs/src/components/pages/AccountIntegrationsPage/AccountIntegrationsPage.tsx</files>
  <action>
Update AccountIntegrationsPage.tsx:

1. Import OpenRouterCard: `import OpenRouterCard from "./components/OpenRouterCard";`

2. Add OpenRouterCard after ClaudeCard in the component JSX:
   ```tsx
   <ClaudeCard />
   <OpenRouterCard />
   <TelegramCard />
   <XCard />
   ```

Position after ClaudeCard since both are AI provider integrations (before social integrations Telegram/X).
</action>
<verify>
Run: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npm run build`
Build should succeed. Start dev server and navigate to Settings -> Integrations to see OpenRouter card.
</verify>
<done>
OpenRouterCard appears in Settings -> Integrations page between Claude and Telegram cards.
</done>
</task>

</tasks>

<verification>
1. Backend verification:
   - GET /integrations/openrouter/config returns `{ hasApiKey: false, isEnabled: false }` for new user
   - PUT /integrations/openrouter/config with `{ apiKey: "test-key" }` returns `{ success: true, hasApiKey: true }`
   - GET now returns `{ hasApiKey: true, isEnabled: true }`
   - PUT with empty apiKey preserves existing key
   - GET /integrations/openrouter/affected-resources returns `{ count: N }`
   - DELETE removes integration and returns affected count

2. Frontend verification:
   - OpenRouter card visible on Integrations page
   - Shows "Configure" button when no key
   - Paste key, save -> shows "Connected" badge
   - "Update" flow allows changing key
   - "Delete Integration" button visible when configured
   - Clicking Delete fetches affected count BEFORE showing dialog
   - Confirmation dialog shows count if > 0
   - Confirming delete calls DELETE endpoint, mutates cache, closes dialog
     </verification>

<success_criteria>

- [ ] GET /integrations/openrouter/config returns status without exposing key
- [ ] PUT /integrations/openrouter/config encrypts and stores key
- [ ] DELETE /integrations/openrouter/config removes integration with affected count
- [ ] GET /integrations/openrouter/affected-resources returns count of resources using key
- [ ] getCreatorOpenRouterApiKey() function exported for Phase 16 execution
- [ ] OpenRouterCard displays in Settings -> Integrations
- [ ] User can add, update, and delete OpenRouter API key
- [ ] Delete flow: click button -> fetch count -> show dialog -> confirm -> DELETE -> mutate
- [ ] All TypeScript compiles without errors
      </success_criteria>

<output>
After completion, create `.planning/phases/13-api-key-integration-ui/13-01-SUMMARY.md`
</output>
