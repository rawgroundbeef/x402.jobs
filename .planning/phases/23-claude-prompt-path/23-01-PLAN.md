---
phase: 23-claude-prompt-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/dashboard/resources/new/claude/page.tsx
  - apps/web/src/app/dashboard/resources/new/details/page.tsx
  - apps/web/src/app/dashboard/resources/new/review/page.tsx
autonomous: true

must_haves:
  truths:
    - "User without Claude API key sees a warning banner with a link to Integrations page"
    - "Continue button is disabled when Claude API key is not configured"
    - "User with Claude API key can write a system prompt in a monospace textarea"
    - "User can add parameters with name, description, default value, and required flag"
    - "User can remove individual parameters"
    - "User can configure max tokens (1-64,000, default 4096)"
    - "Continue button is disabled when system prompt is empty"
    - "Claude config persists through details and appears on review page"
    - "User can publish a Claude prompt resource end-to-end"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/claude/page.tsx"
      provides: "Claude prompt config wizard step with API key check, system prompt, parameters, max tokens"
      min_lines: 150
    - path: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      provides: "Details page that preserves claudeConfig on submit"
      contains: "claudeConfig"
    - path: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      provides: "Review page displaying system prompt preview, parameters, max tokens for Claude type"
      contains: "claudeConfig"
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/claude/page.tsx"
      to: "wizard-draft.ts"
      via: "saveDraft({ claudeConfig: { systemPrompt, parameters, maxTokens } })"
      pattern: "saveDraft.*claudeConfig"
    - from: "apps/web/src/app/dashboard/resources/new/claude/page.tsx"
      to: "/integrations/claude/config"
      via: "useSWR to check API key status"
      pattern: "useSWR.*integrations/claude/config"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "wizard-draft.ts"
      via: "preserves claudeConfig from draft on submit"
      pattern: "claudeConfig"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "wizard-draft.ts"
      via: "reads claudeConfig for display and passes through to publish"
      pattern: "claudeConfig"
---

<objective>
Implement the Claude Prompt Path wizard step -- replace the stub claude/page.tsx with a working form that lets users configure a system prompt, define parameters with `{param}{/param}` syntax, and set max tokens. Include API key checking with a warning banner when no key is configured, and gate the Continue button on both API key presence and form validity. Also wire details page to preserve claudeConfig and enhance review page to display the full Claude prompt configuration.

Purpose: This is the third of four resource type paths. Once complete, users can create Claude prompt template resources end-to-end through the new wizard.

Output: Working Claude config page, updated details page, enhanced review page -- full Claude prompt creation flow functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-claude-prompt-path/23-RESEARCH.md
@apps/web/src/app/dashboard/resources/new/claude/page.tsx
@apps/web/src/app/dashboard/resources/new/proxy/page.tsx
@apps/web/src/app/dashboard/resources/new/details/page.tsx
@apps/web/src/app/dashboard/resources/new/review/page.tsx
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/types/prompt-template.ts
@apps/web/src/components/pages/AccountIntegrationsPage/components/ClaudeCard.tsx
@packages/ui/src/alert.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Claude prompt config page</name>
  <files>apps/web/src/app/dashboard/resources/new/claude/page.tsx</files>
  <action>
Replace the entire stub claude/page.tsx with a working Claude prompt configuration form. Follow the proxy/page.tsx pattern for structure and conventions, but add useSWR API key checking, useFieldArray for parameters, and the warning banner.

**Zod schema (claudeSchema):**
- `systemPrompt`: z.string().min(1, "System prompt is required")
- `parameters`: z.array(promptTemplateParameterSchema).default([])
- `maxTokens`: z.number().int().min(1).max(64000).default(4096)

Import `promptTemplateParameterSchema` from `@/types/prompt-template`.

**API key check:**
- Use useSWR to fetch `/integrations/claude/config` with `authenticatedFetcher` from `@/lib/api`
- Define interface `ClaudeConfig { hasApiKey: boolean; isEnabled: boolean; }`
- Extract `hasApiKey` from response, default to false
- Track `isLoadingConfig` from useSWR

**Form setup:**
- react-hook-form with zodResolver(claudeSchema), mode: "onChange" (so isValid updates live for Continue button gating)
- useFieldArray with control and name "parameters"
- Default values: systemPrompt = "", parameters = [], maxTokens = 4096
- "use client" directive, double quotes, semicolons (Prettier formatting)

**Deep link protection:**
- Same pattern as proxy/page.tsx: check draft.type === "claude", redirect if not

**Draft restoration:**
- On load, if draft.claudeConfig exists, restore form values from it (systemPrompt, parameters, maxTokens)
- Use form.reset() with values from draft.claudeConfig after isLoaded is set

**Layout (inside WizardShell):**
- WizardShell with step={2}, totalSteps={4}, title="Configure Prompt Template", description="Create your AI prompt with parameters", backHref="/dashboard/resources/new"

**Warning Banner (when API key missing):**
- Only show when `!isLoadingConfig && !hasApiKey` (prevents flash on load)
- Use Alert component from `@x402jobs/ui/alert` with variant="warning"
- Use AlertCircle icon from lucide-react inside Alert
- Use AlertDescription for text content
- Text: "You need to configure your Claude API key before creating prompt templates."
- Include a Next.js Link to `/dashboard/integrations` (NOT /dashboard/settings/integrations) with text "Go to Integrations" styled with "font-medium underline underline-offset-4 hover:text-foreground"
- End with " to add your key."
- Add className="mb-6" to Alert

**System Prompt section:**
- Label: "System Prompt" with required asterisk (red star)
- Helper text below label: "Use {paramName}{/paramName} to mark parameter placeholders" in text-xs text-muted-foreground
- Textarea from `@x402jobs/ui/textarea` with register("systemPrompt"), className="font-mono text-sm min-h-[200px]", placeholder="You are a helpful assistant that..."
- Disabled when !hasApiKey
- Character counter below: `{systemPrompt?.length || 0} characters` using watch("systemPrompt"), aligned right with text-xs text-muted-foreground
- Error message below label area if validation error

**Parameters section:**
- Header row with "Parameters" label on left and "Add Parameter" button on right
- "Add Parameter" button: type="button", variant="outline", size="sm", disabled when !hasApiKey
- onClick appends: { name: "", description: "", required: true, default: "" }
- Plus icon from lucide-react before text

- Each parameter in a bordered card (p-3 border border-border rounded-lg space-y-3):
  - Row 1: Parameter name input (flex-1) + Remove button (Trash2 icon, variant="ghost", size="sm")
  - Row 2: Description input with placeholder "Description (shown to callers)"
  - Row 3: Default value input with placeholder "Default value (optional)"
  - Row 4: Required checkbox with label "Required parameter"
  - Use field.id as key (NOT array index)
  - Show parameter name validation errors inline

- Empty state when fields.length === 0: "No parameters defined. Add parameters to create customizable placeholders in your prompt." in text-sm text-muted-foreground

**Max Tokens section:**
- Label: "Max Tokens"
- Input type="number" with register("maxTokens", { valueAsNumber: true })
- min={1}, max={64000}, step={1}, className="w-32"
- Disabled when !hasApiKey
- Error message for validation
- Helper text: "Maximum output tokens (1-64,000). Default: 4,096" in text-xs text-muted-foreground

**Footer (Continue button):**
- Compute `canContinue = hasApiKey && isValid`
- Single Continue button, disabled when !canContinue
- On click/submit: get form values, saveDraft({ claudeConfig: { systemPrompt: data.systemPrompt, parameters: data.parameters, maxTokens: data.maxTokens } }), router.push to details
- Wire as: footer prop renders Button with type="submit" form="claude-form". The form's onSubmit calls handleContinue.

**Imports to use:**
- Input from "@x402jobs/ui/input"
- Textarea from "@x402jobs/ui/textarea"
- Button from "@x402jobs/ui/button"
- Alert, AlertDescription from "@x402jobs/ui/alert"
- WizardShell from "@/components/wizard/WizardShell"
- getDraft, saveDraft from "@/lib/wizard-draft"
- authenticatedFetcher from "@/lib/api"
- promptTemplateParameterSchema from "@/types/prompt-template"
- useForm, useFieldArray from "react-hook-form"
- zodResolver from "@hookform/resolvers/zod"
- z from "zod"
- useSWR from "swr"
- useRouter from "next/navigation"
- useEffect, useState from "react"
- AlertCircle, Plus, Trash2 from "lucide-react"
- Link from "next/link"

**What NOT to do:**
- Do NOT use /dashboard/settings/integrations as the link target -- the correct path is /dashboard/integrations
- Do NOT show the warning banner while isLoadingConfig is true (prevents flash)
- Do NOT use array index as key for parameter fields -- use field.id
- Do NOT add model selection UI -- hardcoded default for v1
- Do NOT add allows_user_message toggle -- not in Phase 23 requirements
- Do NOT validate parameter names match prompt content -- backend handles substitution
- Do NOT add name/slug/price/description fields -- those are in the shared details page
  </action>
  <verify>
Run `pnpm --filter @x402jobs/web exec tsc --noEmit` from the workspace root to confirm no TypeScript errors. Verify the file is no longer a stub (no "Coming in Phase 23" text). Check that all imports resolve. Grep for "authenticatedFetcher" and "useFieldArray" in the file to confirm key patterns are present.
  </verify>
  <done>
Claude config page renders with: warning banner when API key is missing (with link to /dashboard/integrations), system prompt textarea with character counter, dynamic parameter list with add/remove (useFieldArray), max tokens number input, and Continue button gated on both API key presence and form validity. Form restores values from draft.claudeConfig when returning to edit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire details preservation and review display</name>
  <files>
    apps/web/src/app/dashboard/resources/new/details/page.tsx
    apps/web/src/app/dashboard/resources/new/review/page.tsx
  </files>
  <action>
**details/page.tsx -- Preserve claudeConfig on submit:**

In the onSubmit function (around line 169), add claudeConfig preservation alongside the existing linkConfig and proxyConfig lines. Add this line right after the proxyConfig preservation line (around line 181):

```
...(draft?.claudeConfig && { claudeConfig: draft.claudeConfig }),
```

The full preservation block should now include all three type-specific configs:
```typescript
// Preserve type-specific fields from config step
...(draft?.resourceUrl && { resourceUrl: draft.resourceUrl }),
...(draft?.preFilled && { preFilled: draft.preFilled }),
...(draft?.linkConfig && { linkConfig: draft.linkConfig }),
...(draft?.proxyConfig && { proxyConfig: draft.proxyConfig }),
...(draft?.claudeConfig && { claudeConfig: draft.claudeConfig }),
```

**review/page.tsx -- Claude config display:**

Add a Claude config display block after the proxy config display block (after line 292, before the closing `</div>` of the Configuration section). Follow the same IIFE pattern used by link and proxy config:

```typescript
{draft.type === "claude" && draft.claudeConfig && (() => {
  const claudeConfig = draft.claudeConfig as {
    systemPrompt?: string;
    parameters?: Array<{
      name: string;
      description?: string;
      required?: boolean;
      default?: string;
    }>;
    maxTokens?: number;
  };
  return (
    <div className="mt-3 space-y-3">
      <div>
        <dt className="text-sm text-muted-foreground">System Prompt</dt>
        <dd className="text-sm font-mono text-foreground mt-1 p-2 bg-muted/30 rounded max-h-32 overflow-y-auto whitespace-pre-wrap">
          {claudeConfig.systemPrompt || ""}
        </dd>
      </div>
      {claudeConfig.parameters && claudeConfig.parameters.length > 0 && (
        <div>
          <dt className="text-sm text-muted-foreground">Parameters</dt>
          <dd className="space-y-2 mt-1">
            {claudeConfig.parameters.map((param, i) => (
              <div key={i} className="p-2 bg-muted/30 rounded text-sm">
                <div className="flex items-center gap-2">
                  <code className="font-mono text-primary">
                    {"{" + param.name + "}{/" + param.name + "}"}
                  </code>
                  {!param.required && (
                    <span className="text-xs text-muted-foreground">(optional)</span>
                  )}
                </div>
                {param.description && (
                  <p className="text-xs text-muted-foreground mt-1">
                    {param.description}
                  </p>
                )}
                {param.default && (
                  <p className="text-xs text-muted-foreground mt-1">
                    Default: {param.default}
                  </p>
                )}
              </div>
            ))}
          </dd>
        </div>
      )}
      <div>
        <dt className="text-sm text-muted-foreground">Max Tokens</dt>
        <dd className="text-sm font-mono text-foreground">
          {claudeConfig.maxTokens?.toLocaleString() || "4,096"}
        </dd>
      </div>
    </div>
  );
})()}
```

**review/page.tsx -- Verify publish mapping:**

Check lines 89-91 where the publish handler maps Claude config. The existing code does:
```typescript
if (draft.type === "claude" && draft.claudeConfig) {
  Object.assign(body, draft.claudeConfig);
}
```

This spreads `{ systemPrompt, parameters, maxTokens }` directly into the API body, which matches exactly what the backend expects for `prompt_template` type (see resources.ts lines 1795-1798: the backend destructures `systemPrompt`, `parameters`, `maxTokens`, `allowsUserMessage` from req.body, and maps them to `pt_system_prompt`, `pt_parameters`, `pt_max_tokens` at lines 2069-2073).

The existing Object.assign is correct -- NO changes needed to the publish handler.
  </action>
  <verify>
Run `pnpm --filter @x402jobs/web exec tsc --noEmit`. Grep details/page.tsx for "claudeConfig" to confirm preservation is present. Grep review/page.tsx for "claudeConfig" and "systemPrompt" to confirm both the display section and the publish mapping exist.
  </verify>
  <done>
Details page preserves claudeConfig when saving draft (so Claude config survives the details step). Review page shows system prompt preview (monospace, scrollable), parameter list with `{param}{/param}` syntax display and metadata, and max tokens value in the Configuration section. Publish handler correctly passes claudeConfig fields through to API body.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end build and flow</name>
  <files></files>
  <action>
Run the full build to ensure everything compiles:

1. Run `pnpm build` from the workspace root to confirm the Claude page, details page, and review page all compile without errors.

2. Verify no regressions by checking:
   - link/page.tsx still works (grep for "linkConfig" in details/page.tsx)
   - proxy/page.tsx still works (grep for "proxyConfig" in details/page.tsx)
   - No duplicate Claude display code in review/page.tsx
   - The old stub text "Coming in Phase 23" does not appear anywhere

3. If there are any build errors, fix them before marking complete.

4. Run `pnpm lint` from apps/web to catch any lint issues. Fix any errors.

5. Verify the claudeConfig draft keys match the backend API expectations:
   - Grep review/page.tsx for "Object.assign(body, draft.claudeConfig)" to confirm it exists
   - The keys systemPrompt, parameters, maxTokens in claudeConfig must match what the backend resources.ts route expects (systemPrompt, parameters, maxTokens at lines 1795-1798)
  </action>
  <verify>
`pnpm build` exits 0. No TypeScript errors. No lint errors. Grep for "Coming in Phase 23" returns zero results in the codebase (excluding plan files).
  </verify>
  <done>
Full project builds cleanly. All modified files compile without errors. No regressions to existing link or proxy paths. No stale stub content remains. Claude config draft keys align with backend API expectations.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @x402jobs/web exec tsc --noEmit` passes with zero errors
2. `pnpm build` completes successfully
3. claude/page.tsx contains: useSWR for API key check, Alert with variant="warning", system prompt textarea, useFieldArray for parameters, max tokens input, saveDraft with claudeConfig
4. claude/page.tsx: Continue button disabled when !hasApiKey OR form invalid
5. claude/page.tsx: Warning banner only shows when !isLoadingConfig && !hasApiKey
6. claude/page.tsx: Link to /dashboard/integrations (not /dashboard/settings/integrations)
7. details/page.tsx onSubmit preserves linkConfig AND proxyConfig AND claudeConfig
8. review/page.tsx displays system prompt preview, parameter list with {param}{/param} syntax, and max tokens
9. review/page.tsx publish handler passes claudeConfig through via Object.assign (existing code, verified correct)
10. No "Coming in Phase 23" text remains in codebase
</verification>

<success_criteria>
- CLPT-01: Warning banner shown when no Claude API key, with link to Integrations page
- CLPT-02: System prompt textarea with monospace font, character counter, {param}{/param} syntax helper text
- CLPT-03: Parameter definitions with add/remove, name, description, default value, required flag
- CLPT-04: Max tokens number input with 1-64,000 range validation, default 4096
- CLPT-05: Continue button blocked when API key not configured OR system prompt empty
- Full flow works: select Claude Prompt type -> configure prompt -> fill details -> review shows Claude config -> publish sends correct API body
</success_criteria>

<output>
After completion, create `.planning/phases/23-claude-prompt-path/23-01-SUMMARY.md`
</output>
