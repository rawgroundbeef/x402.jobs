---
phase: 11-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/x402-jobs/migrations/005_add_openrouter_integration.sql
autonomous: true

must_haves:
  truths:
    - "OpenRouter API keys can be stored encrypted per user (verify: INSERT into user_openrouter_integrations succeeds)"
    - "x402_resources can be created with resource_type = 'openrouter_instant' (verify: INSERT with new type succeeds)"
    - "OpenRouter resources can reference a model from ai_models table (verify: FK constraint allows valid ai_models.id)"
    - "Users can only access their own OpenRouter integration records (verify: RLS blocks cross-user SELECT)"
    - "Backend service_role can access all integrations for execution (verify: service_role policy exists)"
  artifacts:
    - path: "apps/x402-jobs/migrations/005_add_openrouter_integration.sql"
      provides: "Complete OpenRouter database schema migration"
      contains: "user_openrouter_integrations"
  key_links:
    - from: "user_openrouter_integrations.user_id"
      to: "auth.users(id)"
      via: "FOREIGN KEY with ON DELETE CASCADE"
      pattern: "REFERENCES auth.users\\(id\\) ON DELETE CASCADE"
    - from: "x402_resources.openrouter_model_id"
      to: "ai_models(id)"
      via: "FOREIGN KEY with ON DELETE SET NULL"
      pattern: "REFERENCES ai_models\\(id\\) ON DELETE SET NULL"
---

<objective>
Create database migration for OpenRouter integration infrastructure.

Purpose: Establish the data model foundation that all subsequent OpenRouter phases depend on - encrypted API key storage for users and extended x402_resources schema for the new resource type.

Output: Migration file `005_add_openrouter_integration.sql` ready to apply to Supabase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-database-foundation/11-CONTEXT.md
@.planning/phases/11-database-foundation/11-RESEARCH.md

# Existing patterns to follow

@migrations/002_add_claude_integration.sql
@migrations/001_add_prompt_template_fields.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OpenRouter integration migration</name>
  <files>apps/x402-jobs/migrations/005_add_openrouter_integration.sql</files>
  <action>
Create migration file `005_add_openrouter_integration.sql` with 5 logical sections:

**Section 1: user_openrouter_integrations table**

- Follow exact pattern from `002_add_claude_integration.sql` (x402_user_claude_configs)
- Columns: user_id (UUID PK, FK to auth.users with CASCADE), encrypted_api_key (TEXT NOT NULL), is_valid (BOOLEAN DEFAULT true), last_verified_at (TIMESTAMPTZ), is_enabled (BOOLEAN DEFAULT true), created_at, updated_at
- Use combined IV+ciphertext storage format in encrypted_api_key column

**Section 2: RLS policies for user_openrouter_integrations**

- Enable RLS on table
- Policy "Users can manage their own OpenRouter config" - FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id)
- Policy "Service role full access on OpenRouter" - FOR ALL TO service_role USING (true)

**Section 3: Updated_at trigger**

- Create function `update_openrouter_integration_updated_at()` following Claude pattern
- Create trigger `openrouter_integration_updated_at` BEFORE UPDATE

**Section 4: Extend x402_resources**

- Add column `openrouter_model_id UUID REFERENCES ai_models(id) ON DELETE SET NULL`
- Add column `openrouter_config JSONB` (for {modelId, systemPrompt, params: {temperature, maxTokens, ...}})
- Update resource_type check constraint: DROP existing, ADD with 'openrouter_instant' included
  Current valid types: 'external', 'proxy', 'prompt', 'static', 'prompt_template'
  New valid types: add 'openrouter_instant'
- Add index on openrouter_model_id WHERE openrouter_model_id IS NOT NULL

**Section 5: Comments**

- Document all new columns and table purpose

Include verification queries as comments at the end (not executed, for manual verification).
</action>
<verify>
File exists and contains required schema elements:

```bash
# Verify file exists
test -f apps/x402-jobs/migrations/005_add_openrouter_integration.sql

# Verify core table and security
grep -q "CREATE TABLE user_openrouter_integrations" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "ENABLE ROW LEVEL SECURITY" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "CREATE POLICY" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "CREATE TRIGGER openrouter_integration_updated_at" apps/x402-jobs/migrations/005_add_openrouter_integration.sql

# Verify x402_resources extensions
grep -q "ADD COLUMN openrouter_model_id" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "ADD COLUMN openrouter_config" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "openrouter_instant" apps/x402-jobs/migrations/005_add_openrouter_integration.sql

# Verify key_links foreign key patterns
grep -E "REFERENCES auth\.users\(id\) ON DELETE CASCADE" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -E "REFERENCES ai_models\(id\) ON DELETE SET NULL" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
```
  </verify>
  <done>
  Migration file exists with complete schema: user_openrouter_integrations table, RLS policies, updated_at trigger, x402_resources extensions, and resource_type constraint updated. Key foreign key relationships verified.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add rollback script and document manual steps</name>
  <files>apps/x402-jobs/migrations/005_add_openrouter_integration.sql</files>
  <action>
Append to migration file a clearly commented ROLLBACK section containing:

**Rollback Script (as SQL comments)**

- DROP TRIGGER IF EXISTS openrouter_integration_updated_at
- DROP FUNCTION IF EXISTS update_openrouter_integration_updated_at()
- DROP POLICY statements
- DROP INDEX IF EXISTS idx_openrouter_integrations_user_enabled
- DROP TABLE IF EXISTS user_openrouter_integrations
- DROP INDEX IF EXISTS idx_x402_resources_openrouter_model
- ALTER TABLE x402_resources DROP COLUMN openrouter_model_id
- ALTER TABLE x402_resources DROP COLUMN openrouter_config
- Restore resource_type constraint without 'openrouter_instant'

Add final comment noting this migration must be applied manually to Supabase:
"-- MANUAL STEP: Run this migration in Supabase SQL Editor"
</action>
<verify>
Verify rollback section exists with required statements:

```bash
# Check for ROLLBACK section marker and DROP statements
grep -E "-- ROLLBACK|DROP TRIGGER|DROP TABLE|DROP FUNCTION|DROP POLICY|DROP INDEX" apps/x402-jobs/migrations/005_add_openrouter_integration.sql

# Verify specific rollback elements
grep -q "DROP TRIGGER.*openrouter_integration_updated_at" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "DROP TABLE.*user_openrouter_integrations" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "DROP COLUMN openrouter_model_id" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
grep -q "MANUAL STEP" apps/x402-jobs/migrations/005_add_openrouter_integration.sql
```
</verify>
<done>
Migration includes rollback instructions and is documented as requiring manual application.
</done>
</task>

</tasks>

<verification>
1. Migration file syntax is valid SQL (no parse errors)
2. All 5 sections present: table, RLS, trigger, x402_resources extensions, comments
3. Follows exact patterns from existing migrations (002 for Claude, 001 for resource type extension)
4. Rollback section provides complete reverse of all changes
5. Key foreign key relationships verified via grep patterns
</verification>

<success_criteria>

- [ ] `005_add_openrouter_integration.sql` exists in migrations directory
- [ ] user_openrouter_integrations table schema matches Claude pattern
- [ ] RLS policies protect user data while allowing service_role access
- [ ] x402_resources extended with openrouter_model_id and openrouter_config columns
- [ ] resource_type constraint includes 'openrouter_instant'
- [ ] Foreign key to auth.users(id) with ON DELETE CASCADE verified
- [ ] Foreign key to ai_models(id) with ON DELETE SET NULL verified
- [ ] Rollback script included as comments
- [ ] STATE.md updated with manual migration step
      </success_criteria>

<output>
After completion, create `.planning/phases/11-database-foundation/11-01-SUMMARY.md`
</output>
