---
phase: 21-link-existing-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/lib/wizard-draft.ts
  - apps/web/src/app/dashboard/resources/new/link/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees URL input and HTTP method dropdown on the link validation step"
    - "User clicks Validate Endpoint and sees loading spinner, then validation results"
    - "Valid endpoint shows green verdict banner with warning/error counts and expandable sections"
    - "Invalid endpoint shows red verdict banner with errors displayed inline"
    - "Continue button is disabled until endpoint validates successfully"
    - "Changing URL after validation clears results and requires re-validation"
    - "Valid endpoint saves resourceUrl, network, price, and preFilled flags to session storage draft"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      provides: "Link Existing validation page (Step 2)"
      min_lines: 120
    - path: "apps/web/src/lib/wizard-draft.ts"
      provides: "WizardDraft type with resourceUrl and preFilled fields"
      contains: "preFilled"
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      to: "/api/v1/resources/verify"
      via: "fetch POST with URL in body"
      pattern: "resources/verify"
    - from: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      to: "apps/web/src/components/VerifyResultDetails.tsx"
      via: "import and render with verifyResponse prop"
      pattern: "VerifyResultDetails"
    - from: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      to: "apps/web/src/lib/x402-verify.ts"
      via: "processVerifyResponse to normalize backend response"
      pattern: "processVerifyResponse"
    - from: "apps/web/src/app/dashboard/resources/new/link/page.tsx"
      to: "apps/web/src/lib/wizard-draft.ts"
      via: "saveDraft with linkConfig, network, price, preFilled"
      pattern: "saveDraft"
---

<objective>
Build the Link Existing validation page that replaces the Phase 19 stub. Users enter an x402 endpoint URL with HTTP method, validate it via the backend verify API, see full x402check results (verdict banner, errors, warnings, parsed config, endpoint checks, response body), and proceed to details when valid. On Continue, the validated data (URL, method, network, price) is saved to the wizard draft with pre-fill flags.

Purpose: This is the core type-specific step for Link Existing resources -- the most common resource creation path. Without it, users cannot create resources from existing x402 endpoints through the wizard.

Output: Working link/page.tsx replacing the stub, updated WizardDraft type with resourceUrl and preFilled fields.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-link-existing-path/21-CONTEXT.md
@.planning/phases/21-link-existing-path/21-RESEARCH.md
@apps/web/src/app/dashboard/resources/new/link/page.tsx
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/lib/x402-verify.ts
@apps/web/src/lib/networks.ts
@apps/web/src/lib/api.ts
@apps/web/src/components/VerifyResultDetails.tsx
@apps/web/src/components/wizard/WizardShell.tsx
@apps/web/src/components/modals/RegisterResourceModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resourceUrl and preFilled fields to WizardDraft type</name>
  <files>apps/web/src/lib/wizard-draft.ts</files>
  <action>
Add two new fields to the WizardDraft interface:

1. `resourceUrl?: string` — the validated endpoint URL (used by link and proxy types)
2. `preFilled?: { network?: boolean; price?: boolean }` — flags indicating which details fields were auto-detected from validation and should be locked (read-only) on the details step

Add these after the existing `network` field. Do NOT change any existing fields or logic — only add these two new optional fields.

The `linkConfig` field already exists as `Record<string, unknown>` — that will be used to store the URL and method for the review page. No change needed there.
  </action>
  <verify>TypeScript compiles without errors: `cd /Users/rawgroundbeef/Projects/x402jobs && pnpm --filter web exec tsc --noEmit 2>&1 | head -20`</verify>
  <done>WizardDraft interface has resourceUrl and preFilled fields, existing code still compiles</done>
</task>

<task type="auto">
  <name>Task 2: Build Link Existing validation page</name>
  <files>apps/web/src/app/dashboard/resources/new/link/page.tsx</files>
  <action>
Replace the Phase 19 stub with the full Link Existing validation page. This page is Step 2 of the wizard for the "link" resource type.

**Form (shown before validation):**
- URL input field: `z.string().min(1, 'URL is required').url('Must be a valid URL starting with https://')` — placeholder "https://api.example.com/x402/..." — autoFocus
- HTTP method dropdown: native `<select>` with options GET, POST, PUT, DELETE — defaults to GET — registered with react-hook-form
- Use react-hook-form with zodResolver, same pattern as details/page.tsx

**Validate Endpoint button:**
- In the WizardShell footer area (passed via `footer` prop)
- Shows "Validate Endpoint" normally, shows Loader2 spinner + "Validating..." when loading
- Disabled during validation (`isValidating`)
- Triggers form submit which calls handleValidate

**handleValidate function:**
- Sets isValidating=true, clears error and verifyResponse
- Fetches `${API_URL}/api/v1/resources/verify` with POST, body: `{ url: data.url }` (note: verify endpoint is PUBLIC, no auth needed — use plain fetch, not authenticatedFetch)
- On non-ok response: check for `rawData.validationErrors` array (join with '. '), else use `rawData.error`, else 'Validation failed'
- Process response: `const processed = processVerifyResponse(rawData, data.url)`
- Set verifyResponse to processed
- On catch: set error string
- Finally: setIsValidating(false)
- Import processVerifyResponse and VerifyResponse type from '@/lib/x402-verify'
- Import API_URL from '@/lib/api'

**Results display (shown after validation):**
- When verifyResponse is set, hide the URL/method form inputs and show:
  1. A URL display line showing the validated URL in monospace with a "Change" button that clears verifyResponse (setting it back to null shows the form again)
  2. `<VerifyResultDetails verifyResponse={verifyResponse} url={url} />` — import from '@/components/VerifyResultDetails'
- When error is set (and no verifyResponse), show red error box

**Re-validation on URL change:**
- Use `watch('url')` and `watch('method')` from react-hook-form
- useEffect that clears verifyResponse and error when url or method values change
- This handles the case where user goes back to the form (via Change button) and edits the URL

**Footer button logic:**
- Before validation: show "Validate Endpoint" button (form submit)
- After successful validation (verifyResponse?.valid): show "Continue" button
- After failed validation (!verifyResponse?.valid): show "Validate Endpoint" again (to retry)
- Continue is disabled if `!canContinue` where canContinue = `verifyResponse?.valid && !isValidating`

**handleContinue function:**
- Guard: if !verifyResponse?.valid or !verifyResponse.checkResult, return
- Extract summary[0] from checkResult — if !summary, return
- Normalize network: `normalizeNetworkId(summary.network) || 'solana'` — import from '@/lib/networks'
- Convert price: `const decimals = summary.assetDecimals || 6; const amountNum = parseInt(summary.amount, 10); const price = (amountNum / 10 ** decimals).toString()`
- Save to draft via saveDraft():
  ```
  saveDraft({
    resourceUrl: verifyResponse.normalizedUrl || url,
    network: normalizedNetwork,
    price: price,
    preFilled: { network: true, price: true },
    linkConfig: { url: verifyResponse.normalizedUrl || url, method: method },
  })
  ```
- Navigate: `router.push('/dashboard/resources/new/details')`

**Deep link protection:**
- On mount, check getDraft() — if no draft or draft.type !== 'link', redirect to '/dashboard/resources/new'
- Use useEffect + useState pattern matching the existing stub

**WizardShell props:**
- step={2}, totalSteps={4}, title="Validate Endpoint", description="Check your x402 endpoint configuration"
- backHref="/dashboard/resources/new"
- footer: conditional button rendering as described above

**Important patterns to follow:**
- Import Input from '@x402jobs/ui/input', Button from '@x402jobs/ui/button' (matches details page imports)
- Use 'use client' directive at top
- Match the existing code style (double quotes, semicolons, Prettier formatting)
- The select element for HTTP method should use className="w-full px-3 py-2 border border-input rounded-md bg-background text-sm h-9" to match the app's input styling
  </action>
  <verify>
1. TypeScript compiles: `cd /Users/rawgroundbeef/Projects/x402jobs && pnpm --filter web exec tsc --noEmit 2>&1 | head -30`
2. Dev server starts without errors: `cd /Users/rawgroundbeef/Projects/x402jobs && pnpm --filter web dev &` — check for compilation errors in terminal
3. Manual check: Navigate to /dashboard/resources/new, select "Link Existing", confirm validation page renders with URL input and method dropdown
  </verify>
  <done>
Link validation page renders at /dashboard/resources/new/link with:
- URL input and HTTP method dropdown (LINK-01)
- Validate Endpoint button that calls /api/v1/resources/verify (LINK-02)
- VerifyResultDetails showing verdict banner, error/warning counts, expandable sections (LINK-03, LINK-04, LINK-05, LINK-08)
- Continue disabled until valid (LINK-06)
- On Continue, saves network, price, resourceUrl, and preFilled flags to draft (LINK-07 data writing)
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter web exec tsc --noEmit` passes with no errors
- link/page.tsx imports VerifyResultDetails (not rebuilding validation display) — LINK-08
- link/page.tsx calls /api/v1/resources/verify via fetch — LINK-02
- link/page.tsx has canContinue gated on verifyResponse?.valid — LINK-06
- link/page.tsx saves preFilled flags and network/price to draft on Continue — LINK-07
- WizardDraft type includes resourceUrl and preFilled fields
</verification>

<success_criteria>
1. Stub page replaced with functional validation page showing URL input + method dropdown (LINK-01)
2. Validate Endpoint triggers x402check via backend, results display via VerifyResultDetails (LINK-02, LINK-03, LINK-04, LINK-05)
3. Invalid endpoint disables Continue (LINK-06)
4. Valid endpoint saves network/price/preFilled to draft for details step (LINK-07)
5. Reuses existing VerifyResultDetails component from x402check (LINK-08)
6. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-link-existing-path/21-01-SUMMARY.md`
</output>
