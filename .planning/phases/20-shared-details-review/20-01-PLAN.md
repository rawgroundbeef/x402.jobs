---
phase: 20-shared-details-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/dashboard/resources/new/details/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a form with name, slug, description, image, category, price, and network fields on the details step"
    - "Slug auto-generates from name in real-time and stops syncing once user manually edits it"
    - "Slug field shows /@username/ as a non-editable prefix"
    - "Debounced slug uniqueness check shows available/taken status"
    - "Price field enforces minimum $0.01 with USDC label"
    - "Continue button is disabled until required fields (name, slug, category, price, network) are valid"
    - "Form values persist to session storage on submit and pre-fill from existing draft on mount"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      provides: "Step 3: Shared details form with all fields, validation, and slug auto-generation"
      min_lines: 150
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "apps/web/src/lib/wizard-draft.ts"
      via: "getDraft to load defaults, saveDraft to persist on Continue"
      pattern: "import.*getDraft.*saveDraft.*wizard-draft"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "apps/web/src/constants/categories.ts"
      via: "RESOURCE_CATEGORIES for category dropdown options"
      pattern: "import.*RESOURCE_CATEGORIES.*categories"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "apps/web/src/lib/networks.ts"
      via: "getAllNetworks for network dropdown options"
      pattern: "import.*getAllNetworks.*networks"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "authenticatedFetch for slug uniqueness check API call"
      pattern: "import.*authenticatedFetch.*api"
---

<objective>
Build the shared details form page (Step 3) that collects resource metadata: name, URL slug (with auto-generation from name), description, image, category, price, and network.

Purpose: This is the shared form every resource type flows through. It replaces the scattered form fields in CreateResourceModal with a dedicated full-page step. Covers requirements DETL-01 through DETL-08.

Output: A fully functional details form page at `/dashboard/resources/new/details` that validates input, persists to session storage, and navigates to the review step.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-shared-details-review/20-CONTEXT.md
@.planning/phases/20-shared-details-review/20-RESEARCH.md
@.planning/phases/19-wizard-shell-type-selection/19-01-SUMMARY.md
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/components/wizard/WizardShell.tsx
@apps/web/src/app/dashboard/resources/new/details/page.tsx
@apps/web/src/components/modals/CreateResourceModal.tsx (first 180 lines - for generateSlug, slugRegex, proxyFormSchema patterns)
@apps/web/src/constants/categories.ts
@apps/web/src/lib/networks.ts
@apps/web/src/components/inputs/ImageUrlOrUpload.tsx
@apps/web/src/lib/api.ts
@packages/ui/src/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build the shared details form page</name>
  <files>apps/web/src/app/dashboard/resources/new/details/page.tsx</files>
  <action>
Replace the stub content in `apps/web/src/app/dashboard/resources/new/details/page.tsx` with the full details form. This is a "use client" component.

**Imports:**
- `useForm` from `react-hook-form`
- `zodResolver` from `@hookform/resolvers/zod`
- `z` from `zod`
- `useRouter` from `next/navigation`
- `useEffect`, `useRef`, `useCallback`, `useState` from `react`
- `Input` from `@x402jobs/ui/input`
- `Textarea` from `@x402jobs/ui/textarea`
- `Select` from `@x402jobs/ui/select`
- `Button` from `@x402jobs/ui/button`
- `WizardShell` from `@/components/wizard/WizardShell`
- `getDraft`, `saveDraft`, `WizardDraft` from `@/lib/wizard-draft`
- `RESOURCE_CATEGORIES` from `@/constants/categories`
- `getAllNetworks` from `@/lib/networks`
- `authenticatedFetch` from `@/lib/api`
- `ImageUrlOrUpload` from `@/components/inputs/ImageUrlOrUpload`

**Slug generation function (inline, reuse from CreateResourceModal.tsx):**
```typescript
function generateSlug(text: string): string {
  let slug = text
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, "-")
    .replace(/\s+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-|-$/g, "");
  if (slug.length > 60) {
    slug = slug.substring(0, 60).replace(/-$/, "");
  }
  return slug;
}

const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
```

**Zod schema:**
```typescript
const detailsSchema = z.object({
  name: z.string().min(1, "Name is required"),
  slug: z
    .string()
    .min(1, "Slug is required")
    .regex(slugRegex, "Use lowercase letters, numbers, and hyphens only"),
  description: z.string().optional(),
  imageUrl: z.string().optional(),
  category: z.string().min(1, "Category is required"),
  price: z
    .string()
    .min(1, "Price is required")
    .refine(
      (val) => {
        const num = parseFloat(val);
        return !isNaN(num) && num >= 0.01;
      },
      "Minimum price is $0.01"
    ),
  network: z.enum(["base", "solana"]),
});

type DetailsFormData = z.infer<typeof detailsSchema>;
```

**Component structure:**

1. **State and setup:**
   - `isLoaded` + `draft` state pattern (same as current stub) for deep link protection
   - On mount via useEffect: load draft with `getDraft()`, redirect to `/dashboard/resources/new` if `!draft?.type`
   - `slugManuallyEdited` useRef(false) for tracking manual slug edits
   - `slugStatus` state: `{ available: boolean; reason?: string } | null`
   - `isCheckingSlug` boolean state
   - `username` state loaded via SWR or fetched from `/user/profile` endpoint. Use the same pattern as UserMenu.tsx: `useSWR<{ profile: { username: string } | null }>("/user/profile", authenticatedFetcher)` and extract `profileData?.profile?.username || "username"`. Import `useSWR` from `swr` and `authenticatedFetcher` from `@/lib/api`.

2. **React Hook Form setup:**
   ```typescript
   const { register, handleSubmit, watch, setValue, formState: { errors, isValid } } = useForm<DetailsFormData>({
     resolver: zodResolver(detailsSchema),
     mode: "onBlur",
     reValidateMode: "onChange",
     defaultValues: {
       name: draft.name || "",
       slug: draft.slug || "",
       description: draft.description || "",
       imageUrl: draft.imageUrl || "",
       category: draft.category || "",
       price: draft.price || "",
       network: (draft.network as "base" | "solana") || "base",
     },
   });
   ```

3. **Slug auto-generation:**
   - `handleNameChange` callback: when name input changes, if `!slugManuallyEdited.current`, generate slug from name via `generateSlug()` and `setValue("slug", newSlug, { shouldValidate: true })`
   - Attach to name input: spread `register("name")` but wrap onChange to also call `handleNameChange`
   - `handleSlugChange` callback: sets `slugManuallyEdited.current = true`
   - Attach to slug input: spread `register("slug")` but wrap onChange to also call `handleSlugChange`

4. **Debounced slug uniqueness check:**
   - Watch `slug` and `network` values
   - useEffect with 400ms setTimeout: if slug is valid (matches slugRegex) and network exists, call `authenticatedFetch(\`/resources/check-slug?slug=\${encodeURIComponent(slug)}&network=\${network}\`)`, parse JSON response, set `slugStatus` from response (response shape: `{ available: boolean, reason?: string }`)
   - Set `isCheckingSlug` true before call, false after
   - Return cleanup function that clears timeout
   - Reset slugStatus to null if slug is empty or invalid

5. **Form submit handler:**
   ```typescript
   const onSubmit = (data: DetailsFormData) => {
     if (slugStatus && !slugStatus.available) return;
     saveDraft({
       name: data.name.trim(),
       slug: data.slug.trim(),
       description: data.description?.trim() || undefined,
       imageUrl: data.imageUrl || undefined,
       category: data.category,
       price: data.price,
       network: data.network,
     });
     router.push("/dashboard/resources/new/review");
   };
   ```

6. **Render inside WizardShell:**
   - `step={3}`, `totalSteps={4}` (details is step 3, review is step 4 -- update from the 3-step model since this phase adds a distinct review step)
   - `title="Resource Details"`
   - `description="Add information about your resource"`
   - `backHref={\`/dashboard/resources/new/\${draft.type}\`}`
   - `footer`: a `<Button type="submit" form="details-form" disabled={!isValid || (slugStatus !== null && !slugStatus.available)}>Continue</Button>`

7. **Form fields layout (inside WizardShell children):**
   Render a `<form id="details-form" onSubmit={handleSubmit(onSubmit)} className="space-y-6">` containing:

   **a) Name field (DETL-01):**
   - Label: "Name" with asterisk indicator (use `<label className="block text-sm font-medium text-foreground mb-1.5">Name <span className="text-destructive">*</span></label>`)
   - `<Input {...register("name")} onChange={(e) => { register("name").onChange(e); handleNameChange(e); }} placeholder="My API Resource" />`
   - Error: `{errors.name && <p className="text-sm text-destructive mt-1">{errors.name.message}</p>}`

   **b) URL Slug field (DETL-02):**
   - Label: "URL Slug" with asterisk
   - Prefix display: `<div className="flex items-center">` with `<span className="text-sm text-muted-foreground px-3 py-2 bg-muted rounded-l-md border border-r-0 border-input flex items-center h-9">/@{username}/</span>` followed by `<Input {...register("slug")} onChange={(e) => { register("slug").onChange(e); handleSlugChange(); }} className="rounded-l-none" placeholder="my-api-resource" />`
   - Below the input, show slug status indicators:
     - If `isCheckingSlug`: `<p className="text-sm text-muted-foreground mt-1">Checking availability...</p>`
     - If `slugStatus?.available`: `<p className="text-sm text-green-500 mt-1">Available</p>`
     - If `slugStatus && !slugStatus.available`: `<p className="text-sm text-destructive mt-1">{slugStatus.reason || "Already taken"}</p>`
   - Error: show `errors.slug` message

   **c) Description textarea (DETL-03):**
   - Label: "Description" (no asterisk - optional)
   - `<Textarea {...register("description")} placeholder="Describe what your resource does..." rows={3} />`

   **d) Image field (DETL-04):**
   - Label: "Image" (no asterisk - optional)
   - Use the existing `<ImageUrlOrUpload value={watch("imageUrl") || ""} onChange={(url) => setValue("imageUrl", url)} />` component. This handles URL input + file upload, preview, and Supabase storage. Do NOT rebuild -- reuse the component.

   **e) Category dropdown (DETL-05):**
   - Label: "Category" with asterisk
   - `<Select value={watch("category")} onChange={(val) => setValue("category", val, { shouldValidate: true })} options={RESOURCE_CATEGORIES.map(c => ({ value: c.value, label: c.label }))} placeholder="Select a category" />`
   - Error: show `errors.category` message

   **f) Price field (DETL-06):**
   - Label: "Price (USDC)" with asterisk
   - Wrap in relative div for $ prefix: `<div className="relative"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-sm">$</span><Input {...register("price")} type="text" inputMode="decimal" placeholder="0.01" className="pl-7" /></div>`
   - Error: show `errors.price` message

   **g) Network selector (DETL-07):**
   - Label: "Network" with asterisk
   - `<Select value={watch("network")} onChange={(val) => setValue("network", val as "base" | "solana", { shouldValidate: true })} options={getAllNetworks().map(n => ({ value: n.id, label: n.name }))} />`
   - Error: show `errors.network` message

**Important implementation notes:**
- The Select component from `@x402jobs/ui/select` uses a controlled `value` + `onChange` pattern (not `register()`). You must use `watch("field")` for value and `setValue("field", val, { shouldValidate: true })` for onChange. Do NOT spread `register()` on Select components -- it won't work because the Select component's onChange signature is `(value: string) => void`, not a native event handler.
- For the name and slug Input components, DO spread `register()` but intercept onChange as shown above to add the slug auto-generation and manual edit detection.
- The `h-9` class on the slug prefix span matches the default Input height in the UI library for visual alignment.
- Category should be required (per research recommendation) -- the schema enforces this.
- Note the step/totalSteps: Use `step={3}` and `totalSteps={4}`. Phase 19 stubs used `totalSteps={3}` but now that details and review are separate visible steps, update to 4 total. The review page (Plan 02) will use `step={4}`, `totalSteps={4}`.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402jobs && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify TypeScript compilation. Check that no type errors exist in the details page. If there are issues with imports (e.g., `swr` not found), verify `swr` is in `apps/web/package.json` dependencies.
  </verify>
  <done>
Details page renders a form with all 7 fields (name, slug with prefix and auto-generation, description, image via ImageUrlOrUpload, category dropdown, price with $ prefix, network dropdown). Form validates with Zod (onBlur then onChange). Slug auto-generates from name until manually edited, with debounced uniqueness check. Continue button disabled until form is valid. On submit, data saves to session storage via saveDraft and navigates to /dashboard/resources/new/review.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit --project apps/web/tsconfig.json`
2. Details page loads at `/dashboard/resources/new/details` (after selecting a type)
3. Name field auto-generates slug in real-time
4. Manually editing slug stops auto-generation
5. Slug shows /@username/ prefix and checks availability via API
6. Price validates minimum $0.01
7. Continue button disabled when required fields empty, enabled when valid
8. Image field shows URL/Upload toggle (reuses ImageUrlOrUpload component)
9. Category and Network dropdowns render correct options
10. On Continue, data persists to session storage
</verification>

<success_criteria>
- All 7 form fields render correctly with proper labels and validation
- Slug auto-generates from name, stops on manual edit, shows availability status
- Continue button correctly reflects form validity
- Form data saves to session storage via saveDraft on submit
- Navigation to review page works after successful submit
- Deep link protection redirects to Step 1 if no draft exists
</success_criteria>

<output>
After completion, create `.planning/phases/20-shared-details-review/20-01-SUMMARY.md`
</output>
