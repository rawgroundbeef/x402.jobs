---
phase: 20-shared-details-review
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - apps/web/src/app/dashboard/resources/new/review/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a summary card displaying all resource details (name, slug with username prefix, description, image, category, price, network)"
    - "Each section has an Edit link that navigates back to the correct wizard step"
    - "Type-specific configuration section shows with Edit link back to the type's Step 2 page"
    - "Publish Resource button submits the resource to the backend API"
    - "After successful publish, user is redirected to the new resource's detail page"
    - "Error state shows a message if publish fails"
    - "Publish button shows loading state during submission"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      provides: "Step 4: Review summary with edit links and publish functionality"
      min_lines: 120
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "apps/web/src/lib/wizard-draft.ts"
      via: "getDraft to load all resource data, clearDraft on successful publish"
      pattern: "import.*getDraft.*clearDraft.*wizard-draft"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "apps/web/src/lib/api.ts"
      via: "authenticatedFetch POST to /resources/instant for resource creation"
      pattern: "authenticatedFetch.*resources/instant.*POST"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "apps/web/src/constants/categories.ts"
      via: "RESOURCE_CATEGORIES to display human-readable category label"
      pattern: "import.*RESOURCE_CATEGORIES.*categories"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "apps/web/src/lib/networks.ts"
      via: "getNetwork to display human-readable network name"
      pattern: "import.*getNetwork.*networks"
---

<objective>
Build the review and publish page (Step 4) that displays a summary of all resource configuration with edit links back to relevant steps, and a Publish Resource button that creates the resource via API and redirects to its detail page.

Purpose: This completes the wizard flow. Users can verify everything before committing. Edit links let them fix anything without losing progress. The publish action creates the resource via the same API the existing CreateResourceModal uses. Covers requirements REVW-01 through REVW-05.

Output: A fully functional review page at `/dashboard/resources/new/review` with summary display, edit navigation, publish action, and success redirect.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-shared-details-review/20-CONTEXT.md
@.planning/phases/20-shared-details-review/20-RESEARCH.md
@.planning/phases/20-shared-details-review/20-01-SUMMARY.md
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/components/wizard/WizardShell.tsx
@apps/web/src/app/dashboard/resources/new/review/page.tsx
@apps/web/src/components/modals/CreateResourceModal.tsx (lines 716-770 - handleCreateProxy for API call pattern)
@apps/web/src/constants/categories.ts
@apps/web/src/lib/networks.ts
@apps/web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build the review summary and publish page</name>
  <files>apps/web/src/app/dashboard/resources/new/review/page.tsx</files>
  <action>
Replace the stub content in `apps/web/src/app/dashboard/resources/new/review/page.tsx` with the full review and publish page. This is a "use client" component.

**Imports:**
- `useRouter` from `next/navigation`
- `useEffect`, `useState` from `react`
- `useSWR` from `swr`
- `Button` from `@x402jobs/ui/button`
- `WizardShell` from `@/components/wizard/WizardShell`
- `getDraft`, `clearDraft`, `WizardDraft` from `@/lib/wizard-draft`
- `RESOURCE_CATEGORIES` from `@/constants/categories`
- `getNetwork` from `@/lib/networks`
- `authenticatedFetch`, `authenticatedFetcher` from `@/lib/api`
- `Loader2` from `lucide-react`

**Type mapping (wizard draft type -> API resourceType):**
```typescript
const TYPE_TO_API: Record<string, string> = {
  link: "external",
  proxy: "proxy",
  claude: "prompt_template",
  openrouter: "openrouter_instant",
};

const TYPE_DISPLAY: Record<string, string> = {
  link: "Link Existing",
  proxy: "Proxy",
  claude: "Claude Prompt",
  openrouter: "OpenRouter",
};
```

**Component structure:**

1. **State and setup:**
   - `isLoaded` + `draft` state pattern for deep link protection
   - On mount via useEffect: load draft with `getDraft()`, redirect to `/dashboard/resources/new` if `!draft?.type || !draft?.name` (review requires at minimum a type and name to be meaningful)
   - `isPublishing` boolean state
   - `publishError` string state
   - Fetch username via SWR: `useSWR<{ profile: { username: string } | null }>("/user/profile", authenticatedFetcher)` -- extract `profileData?.profile?.username || "username"`

2. **Publish handler:**
   ```typescript
   const handlePublish = async () => {
     if (!draft) return;
     setIsPublishing(true);
     setPublishError("");

     try {
       // Build the API body based on resource type
       // For now, all types share the same base fields
       // Type-specific config fields will be added by later phases (21-24)
       const body: Record<string, unknown> = {
         resourceType: TYPE_TO_API[draft.type!] || draft.type,
         name: draft.name!.trim(),
         slug: draft.slug!.trim(),
         description: draft.description?.trim() || null,
         priceUsdc: parseFloat(draft.price!),
         network: draft.network,
         category: draft.category,
         avatarUrl: draft.imageUrl?.trim() || null,
       };

       // Add type-specific fields from draft config objects
       // Link Existing: linkConfig has url, method, verification results
       if (draft.type === "link" && draft.linkConfig) {
         Object.assign(body, {
           resourceUrl: draft.linkConfig.url,
           httpMethod: draft.linkConfig.method,
         });
       }
       // Proxy: proxyConfig has origin URL, method, headers
       if (draft.type === "proxy" && draft.proxyConfig) {
         Object.assign(body, {
           proxyOriginUrl: draft.proxyConfig.originUrl,
           proxyMethod: draft.proxyConfig.method,
           proxyAuthHeader: draft.proxyConfig.authHeader || null,
         });
       }
       // Claude & OpenRouter: config objects passed through
       // (will be wired in Phases 23-24)
       if (draft.type === "claude" && draft.claudeConfig) {
         Object.assign(body, draft.claudeConfig);
       }
       if (draft.type === "openrouter" && draft.openrouterConfig) {
         Object.assign(body, draft.openrouterConfig);
       }

       const res = await authenticatedFetch("/resources/instant", {
         method: "POST",
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(body),
       });

       if (!res.ok) {
         const errorData = await res.json();
         throw new Error(errorData.error || "Failed to create resource");
       }

       // Success - clear draft and redirect to the new resource's detail page
       clearDraft();
       router.push(`/${username}/${draft.slug}`);
     } catch (err) {
       setPublishError(
         err instanceof Error ? err.message : "Failed to publish resource"
       );
     } finally {
       setIsPublishing(false);
     }
   };
   ```

3. **Render inside WizardShell:**
   - `step={4}`, `totalSteps={4}`
   - `title="Review & Publish"`
   - `description="Review your resource before publishing"`
   - `backHref="/dashboard/resources/new/details"`
   - `footer`: `<Button onClick={handlePublish} disabled={isPublishing}>{isPublishing ? <><Loader2 className="w-4 h-4 animate-spin mr-2" />Publishing...</> : "Publish Resource"}</Button>`

4. **Summary card layout (inside WizardShell children):**
   Render a `<div className="space-y-6">` containing:

   **a) Error banner (if publishError):**
   - `<div className="p-4 rounded-lg border border-destructive/50 bg-destructive/10 text-destructive text-sm">{publishError}</div>`

   **b) Basic Information section (REVW-01):**
   - Card: `<div className="rounded-lg border border-border p-6">`
   - Header row: `<div className="flex items-center justify-between mb-4">` with `<h2 className="text-base font-semibold text-foreground">Basic Information</h2>` and Edit link: `<button type="button" onClick={() => router.push("/dashboard/resources/new/details")} className="text-sm text-primary hover:underline">Edit</button>`
   - Content as definition list `<dl className="space-y-4">`:
     - **Name:** `<dt className="text-sm text-muted-foreground">Name</dt><dd className="text-base font-medium text-foreground">{draft.name}</dd>`
     - **URL:** `<dt className="text-sm text-muted-foreground">URL</dt><dd className="text-sm font-mono text-primary">/@{username}/{draft.slug}</dd>`
     - **Description** (only if draft.description exists): `<dt>Description</dt><dd className="text-sm text-foreground">{draft.description}</dd>`
     - **Image** (only if draft.imageUrl exists): `<dt>Image</dt><dd><img src={draft.imageUrl} alt={draft.name || "Resource image"} className="max-w-[200px] rounded-lg border border-border" /></dd>`
     - **Grid row for category, price, network:** `<div className="grid grid-cols-2 sm:grid-cols-3 gap-4">`
       - **Category:** `<dt>Category</dt><dd>{RESOURCE_CATEGORIES.find(c => c.value === draft.category)?.label || draft.category}</dd>`
       - **Price:** `<dt>Price</dt><dd className="font-semibold">${draft.price} USDC</dd>`
       - **Network:** `<dt>Network</dt><dd>{getNetwork(draft.network).name}</dd>`

   **c) Type Configuration section (REVW-02, REVW-03 placeholder):**
   - Card: same border/padding pattern
   - Header: `<h2>Configuration</h2>` with Edit link navigating to `\`/dashboard/resources/new/${draft.type}\`` (back to Step 2)
   - Content: Show the resource type display name. For now (before type-specific phases), show: `<p className="text-sm text-muted-foreground">Type: {TYPE_DISPLAY[draft.type!] || draft.type}</p>`
   - If `draft.linkConfig?.url` exists, show the URL: `<p className="text-sm font-mono text-foreground mt-2">{draft.linkConfig.url}</p>`
   - If `draft.proxyConfig?.originUrl` exists, show: `<p className="text-sm font-mono text-foreground mt-2">{draft.proxyConfig.originUrl}</p>`
   - Add a comment: `{/* Type-specific config display will be expanded by Phases 21-24 */}`
   - REVW-03 (validation summary for Link Existing): Add a placeholder comment. The actual x402check validation display will be wired when Phase 21 (Link Existing path) is built. For now, if `draft.type === "link"`, show a subtle note: `<p className="text-xs text-muted-foreground mt-2">Validation details will display here for Link Existing resources</p>`

   **d) Resource Type badge** (at the top of the page, before the cards):
   - A small badge showing the type: `<div className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-muted text-muted-foreground mb-4">{TYPE_DISPLAY[draft.type!] || draft.type}</div>`

**Important implementation notes:**
- The API endpoint is `/resources/instant` (NOT `/api/resources`). The `authenticatedFetch` helper prepends the API_URL base automatically. This matches the existing CreateResourceModal pattern (see `handleCreateProxy` which calls `authenticatedFetch("/resources/instant", { method: "POST", ... })`).
- The API response includes `{ resource: { url, slug, ... } }`. We only need the slug for redirect.
- After successful publish: `clearDraft()` to remove session storage, then `router.push(\`/\${username}/\${draft.slug}\`)` to go to the resource's public page at `/(public)/[username]/[slug]`.
- The username for the slug prefix display and redirect URL comes from the `/user/profile` API (same pattern as UserMenu.tsx). Fallback to `"username"` if not loaded.
- REVW-05 success redirect goes to the resource detail page, not `/dashboard/resources`. The existing modal goes to the dashboard, but the requirements say "redirects to new resource's detail page".
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/x402jobs && npx tsc --noEmit --project apps/web/tsconfig.json 2>&1 | head -30` to verify TypeScript compilation. Check that no type errors exist in the review page.
  </verify>
  <done>
Review page displays a complete summary of the resource with all details (name, slug with username, description, image preview, category, price, network) and type configuration. Edit links navigate to details page and type-specific Step 2 page. Publish button calls the API with the correct body shape, shows loading state, handles errors, and redirects to the resource detail page on success.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Details form (Step 3) and Review & Publish (Step 4) pages for the resource creation wizard.
  </what-built>
  <how-to-verify>
1. Start the dev server: `pnpm dev`
2. Navigate to `/dashboard/resources/new` and select any resource type (e.g., "Proxy")
3. You should land on the type's Step 2 stub page. Click Continue (or navigate manually to `/dashboard/resources/new/details`)
4. **Details page checks:**
   a. Verify you see a form with fields: Name, URL Slug (with /@username/ prefix), Description, Image (URL/Upload toggle), Category dropdown, Price ($ prefix), Network dropdown
   b. Type a name like "Weather API" -- verify the slug field auto-updates to "weather-api"
   c. Manually edit the slug field -- verify it stops syncing with name changes
   d. Clear the name and re-type -- slug should NOT update (manual edit flag)
   e. Verify Continue button is disabled when required fields are empty
   f. Fill in: Name, Category, Price (e.g., 0.05), Network -- verify Continue enables
   g. Try price "0" or "0.001" -- verify error shows (minimum $0.01)
   h. Verify slug availability check shows "Checking..." then "Available" or "Already taken"
5. Click Continue with valid data -- verify you land on the Review page
6. **Review page checks:**
   a. Verify summary card shows: Name, URL (/@username/slug), Description (if entered), Category label, Price with USDC, Network name
   b. Verify type badge shows at top (e.g., "Proxy")
   c. Click "Edit" on Basic Information -- verify it navigates back to details with form pre-filled
   d. Click Continue again on details -- verify review shows updated data
   e. Click "Edit" on Configuration -- verify it navigates to the type's Step 2 page
7. **Publish check:** Click "Publish Resource" -- it will likely fail (no type-specific config yet), but verify:
   a. Button shows loading state ("Publishing...")
   b. Error message displays (expected for incomplete resource)
   c. Button re-enables after error
8. Check mobile: resize browser -- verify form stacks properly
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors for both pages
2. Details form renders all 7 fields with correct validation
3. Slug auto-generation works and stops on manual edit
4. Slug uniqueness check debounces correctly
5. Continue button reflects form validity
6. Session storage round-trip works (details -> review -> edit -> review)
7. Review page shows all resource information with correct formatting
8. Edit links navigate to correct wizard steps
9. Publish button calls API with correct body shape
10. Error states display properly
11. Both pages have deep link protection
</verification>

<success_criteria>
- User can fill in all resource details (name, slug, description, image, category, price, network) on the details step with proper validation and slug auto-generation (DETL-01 through DETL-08)
- Review page displays complete summary with Edit links that navigate back to correct steps (REVW-01, REVW-02)
- Validation summary placeholder exists for Link Existing type (REVW-03 placeholder)
- Publish button submits to backend API with correct body shape (REVW-04)
- Success redirect goes to resource detail page (REVW-05)
- Pre-fill from session storage works for return visits
</success_criteria>

<output>
After completion, create `.planning/phases/20-shared-details-review/20-02-SUMMARY.md`
</output>
