---
phase: 09-output-config-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/output-config.ts
  - src/components/panels/OutputConfigPanel.tsx
  - src/components/pages/JobCanvas/lib/useJobPrice.ts
  - src/components/workflow/nodes/OutputNode.tsx
autonomous: true

must_haves:
  truths:
    - "x402.storage checkbox appears in OutputConfigPanel alongside In-app, Telegram, X"
    - "Checkbox shows '+$0.01 . Permanent link' sublabel"
    - "Enabling x402.storage updates total price in Run button"
    - "Checkbox is disabled when wallet balance is under $0.01"
    - "Config persists when workflow is saved"
  artifacts:
    - path: "src/types/output-config.ts"
      provides: "Extended OutputDestination type"
      contains: "x402storage"
    - path: "src/components/panels/OutputConfigPanel.tsx"
      provides: "x402.storage checkbox UI with balance check"
      contains: "x402storage"
    - path: "src/components/pages/JobCanvas/lib/useJobPrice.ts"
      provides: "Storage fee in price calculation"
      contains: "storageFee"
    - path: "src/components/workflow/nodes/OutputNode.tsx"
      provides: "x402.storage badge display"
      contains: "hasStorage"
  key_links:
    - from: "src/components/panels/OutputConfigPanel.tsx"
      to: "src/types/output-config.ts"
      via: "OutputDestination type import"
      pattern: "x402storage"
    - from: "src/components/pages/JobCanvas/lib/useJobPrice.ts"
      to: "output node config"
      via: "check for x402storage destination"
      pattern: "x402storage.*enabled"
---

<objective>
Add x402.storage as a fourth output destination in OutputConfigPanel with pricing integration.

Purpose: Enable users to opt-in to permanent IPFS storage for job outputs at $0.01 per job.

Output: Working checkbox UI that updates job price calculation when enabled.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-output-config-ui/09-RESEARCH.md

# Source files

@src/types/output-config.ts
@src/components/panels/OutputConfigPanel.tsx
@src/components/pages/JobCanvas/lib/useJobPrice.ts
@src/components/workflow/nodes/OutputNode.tsx
@src/hooks/useWallet.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add x402storage type and OutputConfigPanel checkbox</name>
  <files>
    src/types/output-config.ts
    src/components/panels/OutputConfigPanel.tsx
  </files>
  <action>
**1. Update src/types/output-config.ts:**
Add "x402storage" to the OutputDestination type union:
```typescript
export interface OutputDestination {
  type: "app" | "telegram" | "x" | "x402storage";  // Add x402storage
  // ... rest unchanged
}
```

**2. Update src/components/panels/OutputConfigPanel.tsx:**

a) Update the LOCAL OutputDestination interface (line ~29) to include "x402storage":

```typescript
export interface OutputDestination {
  type: "app" | "telegram" | "x" | "x402storage";
  // ... rest unchanged
}
```

b) Add useWallet import at top:

```typescript
import { useWallet } from "@/hooks/useWallet";
import { Globe } from "lucide-react";
```

c) Inside the component, add wallet balance check:

```typescript
const { wallet } = useWallet();
const hasStorageBalance = (wallet?.totalBalanceUsdc || 0) >= 0.01;
```

d) Add x402.storage checkbox block AFTER the X destination block (after line ~390, before closing `</div>`). Follow exact pattern of Telegram/X blocks:

```tsx
{
  /* x402.storage */
}
<div
  className={`w-full p-4 rounded-lg border-2 transition-all text-left flex items-start gap-3 ${
    !hasStorageBalance
      ? "border-border/50 opacity-60"
      : isDestinationEnabled("x402storage")
        ? "border-output bg-output/5"
        : "border-border hover:border-output/50"
  }`}
>
  <button
    onClick={() => hasStorageBalance && toggleDestination("x402storage")}
    disabled={!hasStorageBalance}
    className="flex items-start gap-3 flex-1 cursor-pointer disabled:cursor-not-allowed"
  >
    {isDestinationEnabled("x402storage") && hasStorageBalance ? (
      <CheckSquare className="h-5 w-5 text-output shrink-0 mt-0.5" />
    ) : (
      <Square className="h-5 w-5 text-muted-foreground shrink-0 mt-0.5" />
    )}
    <div className="flex-1 text-left">
      <div className="flex items-center gap-2 mb-1">
        <Globe className="h-4 w-4 text-emerald-500" />
        <span className="font-medium">x402.storage</span>
        {!hasStorageBalance && (
          <span className="text-xs bg-muted px-1.5 py-0.5 rounded text-muted-foreground">
            Low balance
          </span>
        )}
      </div>
      <p className="text-xs text-muted-foreground">+$0.01 Â· Permanent link</p>
    </div>
  </button>
</div>;
```

Note: x402storage requires no settings panel (unlike Telegram/X) - it's a simple on/off toggle.
</action>
<verify>

- TypeScript compiles: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npx tsc --noEmit`
- Grep confirms type added: `grep -r "x402storage" src/types/output-config.ts`
- Grep confirms checkbox added: `grep -r "x402storage" src/components/panels/OutputConfigPanel.tsx`
  </verify>
  <done>
- OutputDestination type accepts "x402storage" in both files
- x402.storage checkbox appears in OutputConfigPanel
- Checkbox shows "+$0.01 . Permanent link" sublabel
- Checkbox disabled when wallet balance under $0.01
- Checkbox behavior matches existing destinations (toggles enabled state)
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add storage fee to price calculation and OutputNode badge</name>
  <files>
    src/components/pages/JobCanvas/lib/useJobPrice.ts
    src/components/workflow/nodes/OutputNode.tsx
  </files>
  <action>
**1. Update src/components/pages/JobCanvas/lib/useJobPrice.ts:**

a) Add STORAGE_FEE constant after PLATFORM_FEE:

```typescript
const PLATFORM_FEE = 0.05;
const STORAGE_FEE = 0.01;
```

b) Update JobPriceResult interface to include storageFee:

```typescript
interface JobPriceResult {
  total: number;
  resourcesPrice: number;
  platformFee: number;
  storageFee: number; // Add this
}
```

c) Inside useMemo, after computing resourcesPrice, add storage detection:

```typescript
// Check if any output node has x402storage enabled
const hasStorageEnabled = nodes
  .filter((n) => n.type === "output")
  .some((n) => {
    const config = (
      n.data as {
        outputConfig?: {
          destinations?: Array<{ type: string; enabled: boolean }>;
        };
      }
    )?.outputConfig;
    return config?.destinations?.some(
      (d) => d.type === "x402storage" && d.enabled,
    );
  });

const storageFee = hasStorageEnabled ? STORAGE_FEE : 0;
```

d) Update return statement:

```typescript
return {
  total: resourcesPrice + PLATFORM_FEE + storageFee,
  resourcesPrice,
  platformFee: PLATFORM_FEE,
  storageFee,
};
```

**2. Update src/components/workflow/nodes/OutputNode.tsx:**

a) Add Globe import:

```typescript
import { Globe } from "lucide-react";
```

b) After the hasX variable (around line 177), add:

```typescript
const hasStorage = enabledDestinations?.some((d) => d.type === "x402storage");
```

c) Update the badge display condition (line ~268) to include hasStorage:

```tsx
{!hasResult && (hasTelegram || hasX || hasStorage) && (
```

d) Add x402storage badge after the X badge (before closing div):

```tsx
{
  hasStorage && (
    <div
      className="w-5 h-5 rounded bg-emerald-500/20 flex items-center justify-center"
      title="x402.storage enabled"
    >
      <Globe className="w-3 h-3 text-emerald-500" />
    </div>
  );
}
```

  </action>
  <verify>
- TypeScript compiles: `cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npx tsc --noEmit`
- Grep confirms storageFee: `grep -r "storageFee" src/components/pages/JobCanvas/lib/useJobPrice.ts`
- Grep confirms hasStorage badge: `grep -r "hasStorage" src/components/workflow/nodes/OutputNode.tsx`
  </verify>
  <done>
- useJobPrice returns storageFee in result object
- Total price includes storage fee when x402storage enabled
- OutputNode shows emerald Globe badge when x402storage destination is enabled
- Badge consistent with Telegram/X badge styling pattern
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Type check passes:**

   ```bash
   cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npx tsc --noEmit
   ```

2. **Lint passes:**

   ```bash
   cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npm run lint
   ```

3. **Dev server runs:**

   ```bash
   cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs && npm run dev
   ```

   Visit http://localhost:3000/jobs, create/edit a workflow, click on Output node to open OutputConfigPanel.

4. **Manual verification (user):**
   - x402.storage checkbox appears below X option
   - Shows "+$0.01 . Permanent link" sublabel
   - Toggling updates the Run button price (+$0.01)
   - Output node shows emerald globe badge when enabled
     </verification>

<success_criteria>

- [x] DATA-01: OutputDestination type extended with "x402storage" option
- [x] CFGUI-01: OutputConfigPanel displays x402.storage as fourth destination
- [x] CFGUI-02: x402.storage option shows "+$0.01 . Permanent link" sublabel
- [x] CFGUI-03: x402.storage checkbox behavior matches existing destinations
- [x] CFGUI-04: x402.storage option disabled when wallet insufficient
- [x] PRCE-01: Job config shows "+$0.01 storage" when enabled (via updated total)
- [x] PRCE-02: Total price calculation includes storage fee estimate
- [x] Config persists when workflow is saved (uses existing save mechanism)
      </success_criteria>

<output>
After completion, create `.planning/phases/09-output-config-ui/09-01-SUMMARY.md`
</output>
