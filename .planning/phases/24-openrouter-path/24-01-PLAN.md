---
phase: 24-openrouter-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/app/dashboard/resources/new/openrouter/page.tsx
  - apps/web/src/app/dashboard/resources/new/details/page.tsx
  - apps/web/src/app/dashboard/resources/new/review/page.tsx
autonomous: true

must_haves:
  truths:
    - "User without OpenRouter API key sees a warning banner with a link to Integrations page"
    - "Continue button is disabled when OpenRouter API key is not configured"
    - "Continue button is disabled when no model is selected"
    - "User can browse curated popular models by default and search/filter the full catalog"
    - "After selecting a model, it collapses to a summary with a Change button"
    - "User can write a system prompt in a monospace textarea with {param}{/param} syntax"
    - "User can add parameters with name, description, default value, and required flag"
    - "User can remove individual parameters"
    - "User can configure temperature (0-2, default 1.0) and max tokens (1-128,000, default 4096)"
    - "OpenRouter config persists through details and appears on review page with model name"
    - "User can publish an OpenRouter resource end-to-end"
  artifacts:
    - path: "apps/web/src/app/dashboard/resources/new/openrouter/page.tsx"
      provides: "OpenRouter config wizard step with API key check, model browser, system prompt, parameters, temperature, max tokens"
      min_lines: 200
    - path: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      provides: "Details page that preserves openrouterConfig on submit"
      contains: "openrouterConfig"
    - path: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      provides: "Review page displaying model name, system prompt, parameters, temperature, max tokens for OpenRouter type"
      contains: "openrouterConfig"
  key_links:
    - from: "apps/web/src/app/dashboard/resources/new/openrouter/page.tsx"
      to: "wizard-draft.ts"
      via: "saveDraft({ openrouterConfig: { modelId, modelName, provider, systemPrompt, parameters, temperature, maxTokens } })"
      pattern: "saveDraft.*openrouterConfig"
    - from: "apps/web/src/app/dashboard/resources/new/openrouter/page.tsx"
      to: "/integrations/openrouter/config"
      via: "useSWR to check API key status"
      pattern: "useSWR.*integrations/openrouter/config"
    - from: "apps/web/src/app/dashboard/resources/new/openrouter/page.tsx"
      to: "ModelBrowser component"
      via: "onSelect callback sets selectedModel state"
      pattern: "ModelBrowser.*onSelect"
    - from: "apps/web/src/app/dashboard/resources/new/details/page.tsx"
      to: "wizard-draft.ts"
      via: "preserves openrouterConfig from draft on submit"
      pattern: "openrouterConfig"
    - from: "apps/web/src/app/dashboard/resources/new/review/page.tsx"
      to: "wizard-draft.ts"
      via: "reads openrouterConfig for display and passes through to publish"
      pattern: "openrouterConfig"
---

<objective>
Implement the OpenRouter Path wizard step -- replace the stub openrouter/page.tsx with a working form that lets users browse and select an AI model via the existing ModelBrowser component, configure a system prompt with `{param}{/param}` parameter syntax, define parameters, and set temperature and max tokens. Include API key checking with a warning banner when no key is configured, and gate the Continue button on API key presence, model selection, and form validity. Also wire details page to preserve openrouterConfig and enhance review page to display the full OpenRouter configuration including model name.

Purpose: This is the fourth and final resource type path. Once complete, users can create OpenRouter-powered AI resources end-to-end through the new wizard, completing the v2.0 resource registration redesign (except cleanup).

Output: Working OpenRouter config page with model browser integration, updated details page, enhanced review page -- full OpenRouter resource creation flow functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-openrouter-path/24-RESEARCH.md
@.planning/phases/23-claude-prompt-path/23-01-SUMMARY.md
@apps/web/src/app/dashboard/resources/new/openrouter/page.tsx
@apps/web/src/app/dashboard/resources/new/claude/page.tsx
@apps/web/src/app/dashboard/resources/new/details/page.tsx
@apps/web/src/app/dashboard/resources/new/review/page.tsx
@apps/web/src/lib/wizard-draft.ts
@apps/web/src/types/openrouter-resource.ts
@apps/web/src/components/ModelBrowser/ModelBrowser.tsx
@apps/web/src/hooks/useAIModelsQuery.ts
@apps/web/src/components/icons/ProviderIcons.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build OpenRouter config page with model browser</name>
  <files>apps/web/src/app/dashboard/resources/new/openrouter/page.tsx</files>
  <action>
Replace the entire stub openrouter/page.tsx with a working OpenRouter configuration form. This follows the claude/page.tsx pattern closely but adds model selection via ModelBrowser and temperature config.

**Zod schema (openrouterSchema):**
- `systemPrompt`: z.string().min(1, "System prompt is required")
- `parameters`: z.array(openRouterParameterSchema).default([])
- `temperature`: z.number().min(0).max(2).default(1.0)
- `maxTokens`: z.number().int().min(1).max(128000).default(4096)

Import `openRouterParameterSchema` from `@/types/openrouter-resource`.

**API key check (identical pattern to Claude):**
- Use useSWR to fetch `/integrations/openrouter/config` with `authenticatedFetcher` from `@/lib/api`
- Define interface `OpenRouterIntegrationConfig { hasApiKey: boolean; isEnabled: boolean; }`
- Extract `hasApiKey` from response, default to false
- Track `isLoadingConfig` from useSWR

**Model selection state:**
- `const [selectedModel, setSelectedModel] = useState<AIModel | null>(null)`
- Import `AIModel` from `@/hooks/useAIModelsQuery`
- Import `ModelBrowser` from `@/components/ModelBrowser`
- Import `ProviderIcon` from `@/components/icons/ProviderIcons`
- Also import `useAIModelsQuery` for draft restoration (finding model by ID)

**Form setup:**
- react-hook-form with zodResolver(openrouterSchema), mode: "onChange"
- useFieldArray with control and name "parameters"
- Default values: systemPrompt = "", parameters = [], temperature = 1.0, maxTokens = 4096
- "use client" directive, double quotes, semicolons (Prettier formatting)

**Deep link protection:**
- Same pattern as claude/page.tsx: check `draft.type === "openrouter"`, redirect if not

**Draft restoration (useEffect):**
- On load, if `draft.openrouterConfig` exists, restore form values using `reset()`:
  - systemPrompt, parameters, temperature, maxTokens from openrouterConfig
- For model restoration: if `draft.openrouterConfig.modelId` exists, use `useAIModelsQuery` hook result to find the model by ID (`models.find(m => m.id === modelId)`) and call `setSelectedModel()`. The `useAIModelsQuery` hook caches via SWR so this is efficient. Do this in a second useEffect that depends on `models` from the hook being loaded.

**Layout (inside WizardShell):**
- WizardShell with step={2}, totalSteps={4}, title="Configure OpenRouter Resource", description="Select a model and configure your AI prompt", backHref="/dashboard/resources/new"

**Warning Banner (when API key missing) -- identical to Claude except text says "OpenRouter":**
- Only show when `!isLoadingConfig && !hasApiKey`
- Use Alert component from `@x402jobs/ui/alert` with variant="warning"
- Use AlertCircle icon from lucide-react inside Alert
- Use AlertDescription for text content
- Text: "You need to configure your OpenRouter API key before creating resources."
- Include a Next.js Link to `/dashboard/integrations` with text "Go to Integrations" styled with "font-medium underline underline-offset-4 hover:text-foreground"
- End with " to add your key."
- Add className="mb-6" to Alert

**Model Selection section:**
- Label: "Select Model" with required asterisk (red star)
- When `!selectedModel`: render `<ModelBrowser onSelect={(model) => setSelectedModel(model)} selectedModelId={selectedModel?.id} />`
- When `selectedModel`: render a compact summary card:
  - p-4 border border-border rounded-lg bg-card
  - Top row: ProviderIcon (w-5 h-5) + display_name (font-medium) on left, "Change" Button (variant="ghost", size="sm", type="button") on right that sets selectedModel to null
  - Below: model.description in text-sm text-muted-foreground with line-clamp-2 (only if description exists)

**System Prompt section (shown only when selectedModel is truthy):**
- Identical to claude/page.tsx: label "System Prompt" with required asterisk, helper text about `{paramName}{/paramName}` syntax, monospace Textarea min-h-[200px], disabled when !hasApiKey, character counter, error display

**Parameters section (shown only when selectedModel is truthy):**
- Identical to claude/page.tsx: "Parameters" label + "Add Parameter" button, useFieldArray with field.id keys
- Each parameter card: name input, description input, default value input, required checkbox
- Empty state message when no parameters
- Disabled when !hasApiKey

**Model Configuration section (shown only when selectedModel is truthy):**
- Use a grid: `grid grid-cols-2 gap-4`
- Temperature: label "Temperature", Input type="number" with register("temperature", { valueAsNumber: true }), min={0}, max={2}, step={0.1}, className="w-full", disabled when !hasApiKey. Error message. Helper text: "Randomness (0-2). Lower = more focused. Default: 1.0"
- Max Tokens: label "Max Tokens", Input type="number" with register("maxTokens", { valueAsNumber: true }), min={1}, max={128000}, step={1}, className="w-full", disabled when !hasApiKey. Error message. Helper text: "Maximum output tokens (1-128,000). Default: 4,096"

**Footer (Continue button):**
- Compute `canContinue = hasApiKey && selectedModel !== null && isValid`
- Single Continue button, disabled when !canContinue
- Wire as: footer prop renders Button with type="submit" form="openrouter-form". The form's onSubmit calls handleContinue.

**handleContinue function:**
- Called via handleSubmit(handleContinue) on form submit
- Save to draft: `saveDraft({ openrouterConfig: { modelId: selectedModel.id, modelName: selectedModel.display_name, provider: selectedModel.provider, systemPrompt: data.systemPrompt, parameters: data.parameters, temperature: data.temperature, maxTokens: data.maxTokens } })`
- IMPORTANT: Store modelName and provider in the draft so the review page can display the model info WITHOUT fetching. The backend only needs modelId, systemPrompt, parameters, temperature, maxTokens -- the review display uses modelName/provider for UI only.
- Then router.push("/dashboard/resources/new/details")

**Imports to use:**
- Input from "@x402jobs/ui/input"
- Textarea from "@x402jobs/ui/textarea"
- Button from "@x402jobs/ui/button"
- Alert, AlertDescription from "@x402jobs/ui/alert"
- WizardShell from "@/components/wizard/WizardShell"
- ModelBrowser from "@/components/ModelBrowser" (note: barrel import, check if index.ts exists; if not, import from "@/components/ModelBrowser/ModelBrowser")
- ProviderIcon from "@/components/icons/ProviderIcons"
- getDraft, saveDraft from "@/lib/wizard-draft"
- authenticatedFetcher from "@/lib/api"
- openRouterParameterSchema from "@/types/openrouter-resource"
- AIModel from "@/hooks/useAIModelsQuery" (type import)
- useAIModelsQuery from "@/hooks/useAIModelsQuery"
- useForm, useFieldArray from "react-hook-form"
- zodResolver from "@hookform/resolvers/zod"
- z from "zod"
- useSWR from "swr"
- useRouter from "next/navigation"
- useEffect, useState from "react"
- AlertCircle, Plus, Trash2 from "lucide-react"
- Link from "next/link"

**What NOT to do:**
- Do NOT use /dashboard/settings/integrations as the link target -- the correct path is /dashboard/integrations
- Do NOT show the warning banner while isLoadingConfig is true (prevents flash)
- Do NOT use array index as key for parameter fields -- use field.id
- Do NOT add a type field to parameters -- openRouterParameterSchema has name, description, required, default (same as Claude)
- Do NOT use different parameter syntax from Claude -- user explicitly said SAME {param}{/param} syntax
- Do NOT add allows_user_message toggle -- not in Phase 24 requirements
- Do NOT rebuild or customize ModelBrowser -- use it as-is with onSelect and selectedModelId props
- Do NOT show the prompt/parameter/config sections until a model is selected
- Do NOT add name/slug/price/description fields -- those are in the shared details page
  </action>
  <verify>
Run `pnpm --filter @x402jobs/web exec tsc --noEmit` from the workspace root to confirm no TypeScript errors. Verify the file is no longer a stub (no "Coming in Phase 24" text). Check that all imports resolve. Grep for "authenticatedFetcher", "useFieldArray", "ModelBrowser", "ProviderIcon", and "temperature" in the file to confirm key patterns are present.
  </verify>
  <done>
OpenRouter config page renders with: warning banner when API key is missing (with link to /dashboard/integrations), ModelBrowser for model selection that collapses to summary after selection, system prompt textarea with character counter, dynamic parameter list with add/remove (useFieldArray), temperature and max tokens number inputs in a 2-column grid, and Continue button gated on API key presence + model selection + form validity. Form restores values and model selection from draft.openrouterConfig when returning to edit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire details preservation and review display</name>
  <files>
    apps/web/src/app/dashboard/resources/new/details/page.tsx
    apps/web/src/app/dashboard/resources/new/review/page.tsx
  </files>
  <action>
**details/page.tsx -- Preserve openrouterConfig on submit:**

In the onSubmit function (around line 167), add openrouterConfig preservation after the existing claudeConfig preservation line (around line 182). Add this line:

```
...(draft?.openrouterConfig && { openrouterConfig: draft.openrouterConfig }),
```

The full preservation block should now include all four type-specific configs:
```typescript
// Preserve type-specific fields from config step
...(draft?.resourceUrl && { resourceUrl: draft.resourceUrl }),
...(draft?.preFilled && { preFilled: draft.preFilled }),
...(draft?.linkConfig && { linkConfig: draft.linkConfig }),
...(draft?.proxyConfig && { proxyConfig: draft.proxyConfig }),
...(draft?.claudeConfig && { claudeConfig: draft.claudeConfig }),
...(draft?.openrouterConfig && { openrouterConfig: draft.openrouterConfig }),
```

**review/page.tsx -- OpenRouter config display:**

Add an OpenRouter config display block after the Claude config display block (after the closing `})()}` of the claude block, around line 350, BEFORE the closing `</div>` tags). Follow the same IIFE pattern used by Claude config:

```typescript
{draft.type === "openrouter" && draft.openrouterConfig && (() => {
  const orConfig = draft.openrouterConfig as {
    modelId?: string;
    modelName?: string;
    provider?: string;
    systemPrompt?: string;
    parameters?: Array<{
      name: string;
      description?: string;
      required?: boolean;
      default?: string;
    }>;
    temperature?: number;
    maxTokens?: number;
  };
  return (
    <div className="mt-3 space-y-3">
      <div>
        <dt className="text-sm text-muted-foreground">Model</dt>
        <dd className="text-sm font-medium text-foreground mt-1">
          {orConfig.modelName || orConfig.modelId || "Unknown model"}
          {orConfig.provider && (
            <span className="text-muted-foreground font-normal ml-2">
              by {orConfig.provider}
            </span>
          )}
        </dd>
      </div>
      <div>
        <dt className="text-sm text-muted-foreground">System Prompt</dt>
        <dd className="text-sm font-mono text-foreground mt-1 p-2 bg-muted/30 rounded max-h-32 overflow-y-auto whitespace-pre-wrap">
          {orConfig.systemPrompt || ""}
        </dd>
      </div>
      {orConfig.parameters && orConfig.parameters.length > 0 && (
        <div>
          <dt className="text-sm text-muted-foreground">Parameters</dt>
          <dd className="space-y-2 mt-1">
            {orConfig.parameters.map((param, i) => (
              <div key={i} className="p-2 bg-muted/30 rounded text-sm">
                <div className="flex items-center gap-2">
                  <code className="font-mono text-primary">
                    {"{" + param.name + "}{/" + param.name + "}"}
                  </code>
                  {!param.required && (
                    <span className="text-xs text-muted-foreground">(optional)</span>
                  )}
                </div>
                {param.description && (
                  <p className="text-xs text-muted-foreground mt-1">
                    {param.description}
                  </p>
                )}
                {param.default && (
                  <p className="text-xs text-muted-foreground mt-1">
                    Default: {param.default}
                  </p>
                )}
              </div>
            ))}
          </dd>
        </div>
      )}
      <div className="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span className="text-muted-foreground">Temperature:</span>
          <span className="font-mono ml-2">{orConfig.temperature ?? 1.0}</span>
        </div>
        <div>
          <span className="text-muted-foreground">Max Tokens:</span>
          <span className="font-mono ml-2">{orConfig.maxTokens?.toLocaleString() || "4,096"}</span>
        </div>
      </div>
    </div>
  );
})()}
```

**review/page.tsx -- Verify publish mapping:**

Check around line 92-94 where the publish handler maps OpenRouter config. The existing code does:
```typescript
if (draft.type === "openrouter" && draft.openrouterConfig) {
  Object.assign(body, draft.openrouterConfig);
}
```

This spreads ALL openrouterConfig fields into the API body. The backend (resources.ts lines 2076-2089) reads `req.body.modelId`, `req.body.systemPrompt`, `req.body.temperature`, `req.body.maxTokens`, and `req.body.parameters` (via the pt_parameters field). The draft also includes `modelName` and `provider` which the backend will ignore (they're display-only metadata). This is fine -- extra fields are harmless.

The existing Object.assign is correct -- NO changes needed to the publish handler.
  </action>
  <verify>
Run `pnpm --filter @x402jobs/web exec tsc --noEmit`. Grep details/page.tsx for "openrouterConfig" to confirm preservation is present. Grep review/page.tsx for "openrouterConfig" and "modelName" and "temperature" to confirm both the display section and the existing publish mapping work together.
  </verify>
  <done>
Details page preserves openrouterConfig when saving draft (so OpenRouter config survives the details step). Review page shows model name with provider, system prompt preview (monospace, scrollable), parameter list with `{param}{/param}` syntax display and metadata, and temperature/max tokens values in a 2-column grid. Publish handler correctly passes openrouterConfig fields through via Object.assign (existing code, verified correct).
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end build and flow</name>
  <files></files>
  <action>
Run the full build to ensure everything compiles:

1. Run `pnpm build` from the workspace root to confirm the OpenRouter page, details page, and review page all compile without errors.

2. Verify no regressions by checking:
   - link/page.tsx still works (grep for "linkConfig" in details/page.tsx)
   - proxy/page.tsx still works (grep for "proxyConfig" in details/page.tsx)
   - claude/page.tsx still works (grep for "claudeConfig" in details/page.tsx)
   - No duplicate OpenRouter display code in review/page.tsx
   - The old stub text "Coming in Phase 24" does not appear anywhere

3. If there are any build errors, fix them before marking complete.

4. Run `pnpm lint` from apps/web to catch any lint issues. Fix any errors.

5. Verify the openrouterConfig draft keys match the backend API expectations:
   - Grep review/page.tsx for "Object.assign(body, draft.openrouterConfig)" to confirm it exists
   - The keys modelId, systemPrompt, parameters, temperature, maxTokens in openrouterConfig must match what the backend resources.ts route expects (modelId at line 2077, systemPrompt at line 2079, temperature at line 2080, maxTokens at line 2081)

6. Verify ModelBrowser import resolves correctly -- check if there's a barrel export (index.ts in ModelBrowser/) or if the import needs to be from the direct file path.
  </action>
  <verify>
`pnpm build` exits 0. No TypeScript errors. No lint errors. Grep for "Coming in Phase 24" returns zero results in the codebase (excluding plan files).
  </verify>
  <done>
Full project builds cleanly. All modified files compile without errors. No regressions to existing link, proxy, or claude paths. No stale stub content remains. OpenRouter config draft keys align with backend API expectations. ModelBrowser integration compiles and resolves correctly.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter @x402jobs/web exec tsc --noEmit` passes with zero errors
2. `pnpm build` completes successfully
3. openrouter/page.tsx contains: useSWR for API key check, Alert with variant="warning", ModelBrowser integration, system prompt textarea, useFieldArray for parameters, temperature and max tokens inputs, saveDraft with openrouterConfig
4. openrouter/page.tsx: Continue button disabled when !hasApiKey OR !selectedModel OR form invalid
5. openrouter/page.tsx: Warning banner only shows when !isLoadingConfig && !hasApiKey
6. openrouter/page.tsx: Link to /dashboard/integrations (not /dashboard/settings/integrations)
7. openrouter/page.tsx: ModelBrowser collapses to summary card with ProviderIcon after selection
8. openrouter/page.tsx: Model restoration from draft works (useAIModelsQuery find by ID)
9. openrouter/page.tsx: Draft saves modelName and provider alongside modelId for review display
10. details/page.tsx onSubmit preserves linkConfig AND proxyConfig AND claudeConfig AND openrouterConfig
11. review/page.tsx displays model name with provider, system prompt preview, parameter list with {param}{/param} syntax, temperature, and max tokens
12. review/page.tsx publish handler passes openrouterConfig through via Object.assign (existing code, verified correct)
13. No "Coming in Phase 24" text remains in codebase
</verification>

<success_criteria>
- ORTR-01: Warning banner shown when no OpenRouter API key, with link to Integrations page
- ORTR-02: Model browser with search and filters (modality, provider, price) via existing ModelBrowser component
- ORTR-03: Curated popular models shown by default (ModelBrowser "Popular" tab is default)
- ORTR-04: Prompt template editor with `{param}{/param}` syntax support and helper text
- ORTR-05: Parameter definitions with add/remove, name, description, default value, required flag
- ORTR-06: Model config: temperature (0-2, default 1.0) and max_tokens (1-128,000, default 4,096)
- ORTR-07: Continue button blocked until API key configured AND model selected AND form valid
- Full flow works: select OpenRouter type -> browse/select model -> configure prompt -> fill details -> review shows OpenRouter config with model name -> publish sends correct API body
</success_criteria>

<output>
After completion, create `.planning/phases/24-openrouter-path/24-01-SUMMARY.md`
</output>
