---
phase: 18-resource-display
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/x402-jobs-api/src/routes/resources.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "OpenRouter resource detail page shows model name and provider"
    - "Caller can fill parameter form on OpenRouter resource"
  artifacts:
    - path: "apps/x402-jobs-api/src/routes/resources.ts"
      provides: "OpenRouter model join and parameter mapping"
      contains: "openrouter_model:ai_models"
  key_links:
    - from: "GET /:serverSlug/:resourceSlug"
      to: "ai_models table"
      via: "Supabase foreign key join"
      pattern: "openrouter_model:ai_models"
    - from: "promptTemplateFields mapping"
      to: "frontend parameters field"
      via: "conditional resource_type check"
      pattern: "openrouter_instant.*parameters"
---

<objective>
Close verification gaps in Phase 18 by fixing the API endpoint to return model info and parameters for OpenRouter resources.

Purpose: The frontend already renders model_name/model_provider and expects a parameters field, but the API endpoint does not provide these fields for openrouter_instant resources.

Output: API endpoint returns complete resource data enabling OpenRouter detail page display and parameter form rendering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-resource-display/18-VERIFICATION.md
@.planning/phases/18-resource-display/18-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API endpoint for OpenRouter resource display</name>
  <files>apps/x402-jobs-api/src/routes/resources.ts</files>
  <action>
Fix two issues in the GET /:serverSlug/:resourceSlug endpoint (lines 1259-1348):

**Gap 1: Add ai_models join for model info**

Change the query at line 1293-1299 from:

```typescript
const { data: resource, error } = await getSupabase()
  .from("x402_resources")
  .select("*")
  .eq("server_id", server.id)
  .eq("slug", resourceSlug)
  .eq("is_active", true)
  .single();
```

To include a join to ai_models via the openrouter_model_id foreign key:

```typescript
const { data: resource, error } = await getSupabase()
  .from("x402_resources")
  .select("*, openrouter_model:ai_models(display_name, provider)")
  .eq("server_id", server.id)
  .eq("slug", resourceSlug)
  .eq("is_active", true)
  .single();
```

Then add the model fields to flatResource (after promptTemplateFields spread, around line 1326-1341):

```typescript
// Extract OpenRouter model info from joined table
const openrouterModelInfo = resource.openrouter_model as {
  display_name: string;
  provider: string;
} | null;

const flatResource = {
  ...resource,
  ...promptTemplateFields,
  // Add OpenRouter model fields for frontend display
  model_name: openrouterModelInfo?.display_name || null,
  model_provider: openrouterModelInfo?.provider || null,
  server_id: server.id,
  // ... rest of server fields
};
```

**Gap 2: Extend parameters mapping to openrouter_instant**

Change the condition at line 1316-1324 from:

```typescript
const promptTemplateFields =
  resource.resource_type === "prompt_template"
    ? {
        parameters: resource.pt_parameters || [],
        model: resource.pt_model,
        max_tokens: resource.pt_max_tokens,
        allows_user_message: resource.pt_allows_user_message,
      }
    : {};
```

To include openrouter_instant:

```typescript
const promptTemplateFields =
  resource.resource_type === "prompt_template" ||
  resource.resource_type === "openrouter_instant"
    ? {
        parameters: resource.pt_parameters || [],
        model: resource.pt_model,
        max_tokens: resource.pt_max_tokens,
        allows_user_message: resource.pt_allows_user_message,
      }
    : {};
```

The frontend already expects `resource.parameters` and conditionally renders model_name/model_provider. These changes wire the API to provide those fields.
</action>
<verify>
Run TypeScript check:

```bash
cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api && npx tsc --noEmit
```

Verify code changes:

```bash
grep -n "openrouter_model:ai_models" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/resources.ts
grep -n "openrouter_instant.*parameters\|resource_type.*openrouter_instant" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/resources.ts
```

  </verify>
  <done>
- API endpoint joins ai_models table and returns model_name/model_provider for OpenRouter resources
- Parameters field mapped for openrouter_instant resources (same as prompt_template)
- Frontend can now display model info and render parameter form for OpenRouter resources
  </done>
</task>

</tasks>

<verification>
After task completes:

1. **TypeScript verification:**

   ```bash
   cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api && npx tsc --noEmit
   ```

   Must complete without errors.

2. **Code verification:**

   ```bash
   grep -A5 "openrouter_model:ai_models" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/resources.ts
   grep -B2 -A5 "openrouter_instant.*parameters\|resource_type.*prompt_template.*openrouter" /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/resources.ts
   ```

3. **Pattern verification:**
   - `openrouter_model:ai_models(display_name, provider)` appears in select query
   - `model_name` and `model_provider` are added to flatResource
   - Condition includes `openrouter_instant` for parameters mapping
     </verification>

<success_criteria>

1. API endpoint GET /:serverSlug/:resourceSlug joins ai_models table for OpenRouter resources
2. Response includes model_name and model_provider fields for openrouter_instant resources
3. Response includes parameters field (from pt_parameters) for openrouter_instant resources
4. TypeScript compiles without errors
5. Verification gaps from 18-VERIFICATION.md are resolved
   </success_criteria>

<output>
After completion, create `.planning/phases/18-resource-display/18-02-SUMMARY.md` using the summary template.
</output>
