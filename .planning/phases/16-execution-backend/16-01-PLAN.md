---
phase: 16-execution-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/x402-jobs-api/package.json
  - apps/x402-jobs-api/src/routes/instant.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Caller can execute openrouter_instant resource and receive response"
    - "Creator's encrypted OpenRouter API key is decrypted and used"
    - "Parameters are substituted into prompt template correctly"
    - "Usage is logged to x402_prompt_template_usage_logs"
    - "OpenRouter errors return generic 'Resource unavailable' message"
    - "Job completes even if OpenRouter call fails (graceful degradation)"
  artifacts:
    - path: "apps/x402-jobs-api/src/routes/instant.ts"
      provides: "openrouter_instant executor"
      contains: 'case "openrouter_instant"'
    - path: "apps/x402-jobs-api/package.json"
      provides: "openai dependency"
      contains: '"openai"'
  key_links:
    - from: "instant.ts executeOpenRouterInstant"
      to: "getCreatorOpenRouterApiKey"
      via: "import from integrations.ts"
      pattern: "getCreatorOpenRouterApiKey"
    - from: "instant.ts openrouter_instant case"
      to: "logPromptTemplateUsage"
      via: "function call after execution"
      pattern: "logPromptTemplateUsage"
    - from: "instant.ts openrouter_instant case"
      to: "updateResourceStats"
      via: "function call on success"
      pattern: "updateResourceStats"
---

<objective>
Add server-side execution of OpenRouter instant resources following the existing prompt_template pattern.

Purpose: Enable callers to execute openrouter_instant resources with payment via x402, where the server decrypts creator's API key, substitutes parameters, calls OpenRouter API, logs usage, and returns the response.

Output: Modified instant.ts with openrouter_instant executor and openai npm package installed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-execution-backend/16-CONTEXT.md
@.planning/phases/16-execution-backend/16-RESEARCH.md
@apps/x402-jobs-api/src/routes/instant.ts
@apps/x402-jobs-api/src/routes/integrations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install openai package and add OpenRouter executor function</name>
  <files>
    apps/x402-jobs-api/package.json
    apps/x402-jobs-api/src/routes/instant.ts
  </files>
  <action>
    1. Install openai package in x402-jobs-api:
       ```bash
       cd apps/x402-jobs-api && pnpm add openai
       ```

    2. In instant.ts, add imports at top:
       ```typescript
       import OpenAI from "openai";
       import { getCreatorOpenRouterApiKey } from "./integrations";
       ```
       Note: getCreatorClaudeApiKey is already imported; add getCreatorOpenRouterApiKey to that import.

    3. Update InstantResource interface to add OpenRouter fields:
       ```typescript
       // OpenRouter instant fields
       openrouter_model_id: string | null;
       openrouter_config: {
         systemPrompt: string;
         temperature?: number;
         maxTokens?: number;
         topP?: number;
         frequencyPenalty?: number;
         presencePenalty?: number;
       } | null;
       ```

    4. Update loadResource query to include OpenRouter fields:
       Add `openrouter_model_id, openrouter_config` to the select query.

    5. Add executeOpenRouterInstant function (after executePromptTemplate function):
       ```typescript
       /**
        * Execute an openrouter_instant resource using OpenAI SDK with OpenRouter baseURL.
        * No streaming per CONTEXT.md - waits for full response (LRO pattern).
        */
       async function executeOpenRouterInstant(
         resource: InstantResource,
         body: Record<string, unknown>,
         isOwnerTest: boolean,
         context: ExecutePromptTemplateContext = {},
       ): Promise<
         | { json: true; response: unknown }
         | { error: string; status: number }
       > {
         const startTime = Date.now();

         // Validate parameters (reuse existing validation)
         const validationError = validatePromptTemplateRequest(
           {
             pt_parameters: resource.pt_parameters,
             pt_allows_user_message: resource.pt_allows_user_message,
           },
           body,
         );
         if (validationError) {
           return { error: validationError, status: 400 };
         }

         // Get creator's OpenRouter API key
         const creatorId = resource.server?.registered_by;
         if (!creatorId) {
           return { error: "Resource configuration error", status: 500 };
         }

         const apiKey = await getCreatorOpenRouterApiKey(creatorId);
         if (!apiKey) {
           return {
             error: "Resource unavailable",
             status: 500,
           };
         }

         // Get model ID from openrouter_config or ai_models FK
         const config = resource.openrouter_config;
         if (!config?.systemPrompt) {
           return { error: "Resource configuration error", status: 500 };
         }

         // Substitute parameters into system prompt
         const substitutedPrompt = substituteParameters(
           config.systemPrompt,
           resource.pt_parameters || [],
           body as Record<string, string>,
         );

         // Get model ID - need to look up from ai_models table
         let modelId: string;
         if (resource.openrouter_model_id) {
           // Look up the actual model name from ai_models table
           const { data: model } = await getSupabase()
             .from("ai_models")
             .select("name")
             .eq("id", resource.openrouter_model_id)
             .single();

           if (!model?.name) {
             return { error: "Resource unavailable", status: 500 };
           }
           modelId = model.name; // OpenRouter uses name like "openai/gpt-4o"
         } else {
           return { error: "Resource configuration error", status: 500 };
         }

         // Create OpenAI client with OpenRouter baseURL
         const client = new OpenAI({
           baseURL: "https://openrouter.ai/api/v1",
           apiKey,
           defaultHeaders: {
             "HTTP-Referer": "https://x402.jobs",
             "X-Title": "x402.jobs",
           },
         });

         try {
           // Build messages array
           const messages: Array<{ role: "system" | "user"; content: string }> = [];

           if (substitutedPrompt) {
             messages.push({ role: "system", content: substitutedPrompt });
           }

           const userMessage = body.user_message as string | undefined;
           messages.push({
             role: "user",
             content: userMessage || "Please respond based on the system instructions.",
           });

           // Call OpenRouter API (no streaming per CONTEXT.md)
           const response = await client.chat.completions.create({
             model: modelId,
             messages,
             temperature: config.temperature ?? 1.0,
             max_tokens: config.maxTokens ?? 4096,
             top_p: config.topP ?? 1.0,
             frequency_penalty: config.frequencyPenalty,
             presence_penalty: config.presencePenalty,
             stream: false,
           });

           const content = response.choices[0]?.message?.content || "";
           const inputTokens = response.usage?.prompt_tokens;
           const outputTokens = response.usage?.completion_tokens;

           const executionTimeMs = Date.now() - startTime;

           // Log usage
           if (context.callerId) {
             await logPromptTemplateUsage({
               templateId: resource.id,
               callerId: context.callerId,
               status: "success",
               inputTokens,
               outputTokens,
               amountPaid: isOwnerTest ? 0 : context.amountPaid,
               paymentSignature: context.paymentSignature,
               network: context.network,
               executionTimeMs,
             });
           }

           return {
             json: true,
             response: {
               response: content,
               usage: {
                 input_tokens: inputTokens,
                 output_tokens: outputTokens,
               },
             },
           };
         } catch (error) {
           const executionTimeMs = Date.now() - startTime;
           const errorMessage = error instanceof Error ? error.message : "Execution failed";

           console.error(`[Instant] OpenRouter execution error:`, error);

           // Log failed usage
           if (context.callerId) {
             await logPromptTemplateUsage({
               templateId: resource.id,
               callerId: context.callerId,
               status: "failed",
               errorMessage,
               amountPaid: isOwnerTest ? 0 : context.amountPaid,
               paymentSignature: context.paymentSignature,
               network: context.network,
               executionTimeMs,
             });
           }

           // Return generic error per CONTEXT.md - don't expose 401/402/etc details
           return {
             error: "Resource unavailable",
             status: 500,
           };
         }
       }
       ```

    Key patterns to follow:
    - No streaming (stream: false) per CONTEXT.md decision
    - Generic "Resource unavailable" error for all failures per CONTEXT.md
    - Reuse substituteParameters() and validatePromptTemplateRequest()
    - Reuse logPromptTemplateUsage() for usage logging
    - Look up model name from ai_models table (OpenRouter uses names like "openai/gpt-4o")

  </action>
  <verify>
    - `pnpm list openai` in x402-jobs-api shows openai package installed
    - `pnpm run typecheck` in x402-jobs-api passes
  </verify>
  <done>
    openai package installed, InstantResource interface extended, executeOpenRouterInstant function added with parameter substitution, OpenRouter API call, and usage logging
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire openrouter_instant into route handler</name>
  <files>apps/x402-jobs-api/src/routes/instant.ts</files>
  <action>
    1. Update InstantResource.resource_type union to include openrouter_instant:
       ```typescript
       resource_type: "proxy" | "prompt" | "static" | "prompt_template" | "openrouter_instant";
       ```

    2. Update build402Response to handle openrouter_instant parameters.
       Add case for openrouter_instant alongside prompt_template:
       ```typescript
       // OpenRouter instant parameters (follows same pattern as prompt_template)
       if (resource.resource_type === "openrouter_instant" && resource.pt_parameters) {
         for (const param of resource.pt_parameters as Array<{
           name: string;
           description?: string;
           required: boolean;
           default?: string;
         }>) {
           bodyFields[param.name] = {
             type: "string",
             required: param.required,
             description: param.description || `Parameter: ${param.name}`,
             ...(param.default !== undefined ? { default: param.default } : {}),
           };
         }
       }
       ```

    3. Add owner test mode handling for openrouter_instant (after the prompt_template owner test block around line 472):
       ```typescript
       // Handle openrouter_instant with owner test mode - bypass payment
       if (resource.resource_type === "openrouter_instant" && isOwnerTest) {
         console.log(
           `[Instant] Owner test mode for openrouter_instant: ${resource.slug}`,
         );
         const orResult = await executeOpenRouterInstant(
           resource,
           req.body,
           true,
           {
             callerId: req.user?.id,
             amountPaid: 0,
             network,
           },
         );
         if ("error" in orResult) {
           return res.status(orResult.status).json({ error: orResult.error });
         }
         return res.json(orResult.response);
       }
       ```

    4. Add openrouter_instant case to the switch statement (after prompt_template case, around line 537):
       ```typescript
       case "openrouter_instant": {
         const orResult = await executeOpenRouterInstant(
           resource,
           req.body,
           isOwnerTest,
           {
             callerId: req.user?.id,
             amountPaid: priceUsdc,
             paymentSignature: paymentResult.txHash,
             network,
           },
         );
         if ("error" in orResult) {
           return res.status(orResult.status).json({ error: orResult.error });
         }
         // Update stats
         await updateResourceStats(resource.id, priceUsdc, platformFeePercent);
         return res.json({
           ...orResult.response,
           receipt: {
             transaction: paymentResult.txHash,
             paidUsdc: priceUsdc,
           },
         });
       }
       ```

    Key differences from prompt_template:
    - No streaming mode (no noStream parameter)
    - Always returns JSON response (no SSE)
    - Same receipt format as other resource types

  </action>
  <verify>
    - `pnpm run typecheck` passes
    - `pnpm run build` succeeds
    - Search for "openrouter_instant" in instant.ts shows: resource_type union, build402Response case, owner test handler, switch case
  </verify>
  <done>
    openrouter_instant fully wired into instant.ts route handler with payment flow, owner test mode, stats tracking, and receipt generation
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/x402-jobs-api && pnpm run typecheck`
2. Build succeeds: `cd apps/x402-jobs-api && pnpm run build`
3. Code inspection: openrouter_instant appears in:
   - InstantResource.resource_type union
   - loadResource query (openrouter_model_id, openrouter_config)
   - build402Response (parameter schema)
   - Owner test mode handler
   - Switch statement case
   - executeOpenRouterInstant function
</verification>

<success_criteria>

1. openai package installed in x402-jobs-api
2. executeOpenRouterInstant function exists with:
   - Parameter substitution via substituteParameters()
   - OpenRouter API call via openai package with baseURL override
   - Usage logging via logPromptTemplateUsage()
   - Generic error handling ("Resource unavailable")
3. openrouter_instant case in route handler with:
   - Payment verification via x402
   - Owner test mode bypass
   - Stats tracking
   - Receipt in response
4. All TypeScript compiles without errors
   </success_criteria>

<output>
After completion, create `.planning/phases/16-execution-backend/16-01-SUMMARY.md`
</output>
