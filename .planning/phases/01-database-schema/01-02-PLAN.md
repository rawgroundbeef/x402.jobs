---
phase: 01-database-schema
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - migrations/001_add_prompt_template_fields.sql
  - migrations/README.md
autonomous: false

must_haves:
  truths:
    - "SQL migration adds pt_system_prompt, pt_parameters, pt_model, pt_max_tokens, pt_allows_user_message columns to resources table"
    - "RLS policy prevents non-owners from reading pt_system_prompt"
    - "User can run migration manually against Supabase"
  artifacts:
    - path: "migrations/001_add_prompt_template_fields.sql"
      provides: "Database schema changes for prompt templates"
      contains: "ALTER TABLE resources"
      min_lines: 30
    - path: "migrations/README.md"
      provides: "Instructions for running migrations"
      contains: "supabase"
      min_lines: 15
  key_links:
    - from: "migrations/001_add_prompt_template_fields.sql"
      to: "resources table"
      via: "ALTER TABLE resources ADD COLUMN"
      pattern: "ALTER TABLE.*resources.*ADD COLUMN"
---

<objective>
Create SQL migration script for prompt template database fields.

Purpose: Add database columns needed to store prompt template data. Following the existing pattern of type-specific fields in the resources table (like proxy_origin_url, prompt_system_prompt, etc.).

Output: SQL migration file and instructions for user to run manually against Supabase.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-database-schema/01-RESEARCH.md

Key architecture decisions:
- User runs migrations manually (from STATE.md)
- Use pt_ prefix for prompt_template fields (from RESEARCH.md)
- RLS must prevent non-owners from reading system_prompt (security requirement)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrations directory and SQL file</name>
  <files>migrations/001_add_prompt_template_fields.sql</files>
  <action>
Create `migrations/001_add_prompt_template_fields.sql` with:

```sql
-- Migration: Add prompt_template resource type fields
-- Created: [current date]
-- Description: Adds columns for prompt_template resources to the resources table
--              following the existing pattern of type-specific fields (pt_ prefix)

-- ============================================================================
-- STEP 1: Add prompt_template columns to resources table
-- ============================================================================

-- System prompt (the creator's IP - protected content)
ALTER TABLE resources ADD COLUMN IF NOT EXISTS pt_system_prompt TEXT;

-- Parameters array (JSONB for flexibility)
-- Each parameter: { name: string, description: string, required: boolean, default?: string }
ALTER TABLE resources ADD COLUMN IF NOT EXISTS pt_parameters JSONB DEFAULT '[]';

-- Model (hardcoded to claude-sonnet-4-20250514 for v1)
ALTER TABLE resources ADD COLUMN IF NOT EXISTS pt_model VARCHAR(100) DEFAULT 'claude-sonnet-4-20250514';

-- Max tokens for Claude response
ALTER TABLE resources ADD COLUMN IF NOT EXISTS pt_max_tokens INTEGER DEFAULT 4096;

-- Whether user can provide additional message (system+user mode)
ALTER TABLE resources ADD COLUMN IF NOT EXISTS pt_allows_user_message BOOLEAN DEFAULT false;

-- ============================================================================
-- STEP 2: Add check constraint for max_tokens
-- ============================================================================

ALTER TABLE resources ADD CONSTRAINT pt_max_tokens_range
  CHECK (pt_max_tokens IS NULL OR (pt_max_tokens >= 1 AND pt_max_tokens <= 8192));

-- ============================================================================
-- STEP 3: Create index for prompt_template queries
-- ============================================================================

-- Index for filtering by resource_type (if not exists)
CREATE INDEX IF NOT EXISTS idx_resources_type ON resources(resource_type);

-- ============================================================================
-- STEP 4: RLS Policy for system_prompt protection
-- ============================================================================

-- Note: This assumes RLS is already enabled on the resources table.
-- The policy prevents non-owners from reading pt_system_prompt.
--
-- IMPORTANT: You may need to adjust this based on your existing RLS setup.
-- The key principle: pt_system_prompt should ONLY be readable by the owner.

-- Create a view that excludes pt_system_prompt for public access
CREATE OR REPLACE VIEW public_resources AS
SELECT
  id,
  slug,
  name,
  description,
  resource_url,
  network,
  price_usdc,
  resource_type,
  avatar_url,
  category,
  created_at,
  is_active,
  call_count,
  total_earned_usdc,
  -- Include pt_ fields EXCEPT pt_system_prompt
  pt_parameters,
  pt_model,
  pt_max_tokens,
  pt_allows_user_message
FROM resources
WHERE is_active = true;

-- Grant access to the view (adjust role as needed)
GRANT SELECT ON public_resources TO authenticated;
GRANT SELECT ON public_resources TO anon;

-- ============================================================================
-- STEP 5: Add comment for documentation
-- ============================================================================

COMMENT ON COLUMN resources.pt_system_prompt IS 'System prompt for prompt_template resources. Protected content - only visible to owner.';
COMMENT ON COLUMN resources.pt_parameters IS 'JSON array of parameters: [{name, description, required, default}]';
COMMENT ON COLUMN resources.pt_model IS 'Claude model ID (default: claude-sonnet-4-20250514)';
COMMENT ON COLUMN resources.pt_max_tokens IS 'Max tokens for Claude response (1-8192, default: 4096)';
COMMENT ON COLUMN resources.pt_allows_user_message IS 'Whether caller can provide user message (system+user mode)';

-- ============================================================================
-- VERIFICATION QUERIES (run after migration)
-- ============================================================================

-- Verify columns exist:
-- SELECT column_name, data_type, column_default
-- FROM information_schema.columns
-- WHERE table_name = 'resources' AND column_name LIKE 'pt_%';

-- Verify constraint:
-- SELECT constraint_name, check_clause
-- FROM information_schema.check_constraints
-- WHERE constraint_name = 'pt_max_tokens_range';
```
  </action>
  <verify>
1. File exists: `ls -la migrations/001_add_prompt_template_fields.sql`
2. Contains required columns: `grep -E "pt_system_prompt|pt_parameters|pt_model|pt_max_tokens|pt_allows_user_message" migrations/001_add_prompt_template_fields.sql | wc -l` (should be >= 5)
3. Has RLS consideration: `grep -i "system_prompt" migrations/001_add_prompt_template_fields.sql | head -5`
  </verify>
  <done>
SQL migration file exists with:
- pt_system_prompt column (DATA-02)
- pt_parameters column as JSONB (DATA-03)
- pt_model column with default (DATA-04)
- pt_max_tokens column with constraint (DATA-05)
- pt_allows_user_message column (DATA-06)
- RLS consideration via public_resources view
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration README with instructions</name>
  <files>migrations/README.md</files>
  <action>
Create `migrations/README.md` with:

```markdown
# Database Migrations

This directory contains SQL migrations for the x402-jobs database.

## Running Migrations

Migrations are run manually against your Supabase database.

### Prerequisites

1. Access to your Supabase project dashboard
2. Database admin permissions

### Option 1: Supabase Dashboard (Recommended)

1. Go to your Supabase project dashboard
2. Navigate to **SQL Editor**
3. Open the migration file (e.g., `001_add_prompt_template_fields.sql`)
4. Copy the contents
5. Paste into the SQL Editor
6. Click **Run** to execute

### Option 2: Supabase CLI

```bash
# If you have supabase CLI configured:
supabase db push
```

### Option 3: Direct psql

```bash
# Connect to your database
psql "postgresql://postgres:[password]@[host]:5432/postgres"

# Run migration
\i migrations/001_add_prompt_template_fields.sql
```

## Migration Files

| File | Description | Date |
|------|-------------|------|
| `001_add_prompt_template_fields.sql` | Adds prompt_template resource type columns | TBD |

## Verification

After running a migration, verify it succeeded:

```sql
-- Check pt_ columns exist
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'resources' AND column_name LIKE 'pt_%';

-- Check constraint exists
SELECT constraint_name
FROM information_schema.check_constraints
WHERE constraint_name = 'pt_max_tokens_range';
```

## Rollback

To rollback the prompt_template migration:

```sql
-- Remove constraint
ALTER TABLE resources DROP CONSTRAINT IF EXISTS pt_max_tokens_range;

-- Remove columns
ALTER TABLE resources DROP COLUMN IF EXISTS pt_system_prompt;
ALTER TABLE resources DROP COLUMN IF EXISTS pt_parameters;
ALTER TABLE resources DROP COLUMN IF EXISTS pt_model;
ALTER TABLE resources DROP COLUMN IF EXISTS pt_max_tokens;
ALTER TABLE resources DROP COLUMN IF EXISTS pt_allows_user_message;

-- Remove view
DROP VIEW IF EXISTS public_resources;
```

## Notes

- Migrations are idempotent (safe to run multiple times)
- Always backup before running migrations in production
- RLS policies may need adjustment based on your specific setup
```
  </action>
  <verify>
1. File exists: `ls -la migrations/README.md`
2. Contains instructions: `grep -i "supabase" migrations/README.md | head -3`
3. Contains verification steps: `grep -i "verify" migrations/README.md | head -3`
  </verify>
  <done>
README provides clear instructions for:
- Running migrations via Supabase dashboard
- Alternative methods (CLI, psql)
- Verification queries
- Rollback procedure
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>SQL migration script for prompt template database columns</what-built>
  <how-to-verify>
1. Review `migrations/001_add_prompt_template_fields.sql` for correctness
2. Confirm the migration covers all DATA requirements:
   - DATA-01: prompt_template as resource type (enabled by columns)
   - DATA-02: pt_system_prompt for creator's IP
   - DATA-03: pt_parameters for parameter array
   - DATA-04: pt_model for model (default: claude-sonnet-4-20250514)
   - DATA-05: pt_max_tokens for max tokens
   - DATA-06: pt_allows_user_message for system+user mode
3. Verify RLS approach is acceptable for your Supabase setup
4. Run the migration against your Supabase database when ready

**Note:** The migration creates a `public_resources` view that excludes pt_system_prompt. Adjust if your RLS setup differs.
  </how-to-verify>
  <resume-signal>Type "approved" after running the migration, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `migrations/` directory exists with SQL file and README
2. SQL file contains all required ALTER TABLE statements
3. README provides clear instructions for manual migration
4. User has reviewed and run the migration
</verification>

<success_criteria>
- [ ] `migrations/001_add_prompt_template_fields.sql` exists with all pt_ columns
- [ ] `migrations/README.md` exists with clear instructions
- [ ] SQL is syntactically correct
- [ ] User has run the migration against Supabase
- [ ] Verification queries confirm columns exist
</success_criteria>

<output>
After completion, create `.planning/phases/01-database-schema/01-02-SUMMARY.md`
</output>
