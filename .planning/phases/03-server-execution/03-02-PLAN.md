---
phase: 03-server-execution
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - x402-jobs-api/src/routes/instant.ts
  - x402-jobs-api/package.json
autonomous: true

must_haves:
  truths:
    - "Caller can execute a prompt_template resource and receive streamed response"
    - "Parameters are substituted into system prompt before Claude call"
    - "Missing required parameters are rejected before execution"
    - "Creator can test their own template without payment"
    - "Errors return user-friendly messages"
  artifacts:
    - path: "x402-jobs-api/src/routes/instant.ts"
      provides: "prompt_template executor with streaming"
      contains: "prompt_template"
    - path: "x402-jobs-api/package.json"
      provides: "Anthropic SDK dependency"
      contains: "@anthropic-ai/sdk"
  key_links:
    - from: "instant.ts"
      to: "@anthropic-ai/sdk"
      via: "Anthropic client"
      pattern: "new Anthropic"
    - from: "instant.ts"
      to: "integrations.ts"
      via: "getCreatorClaudeApiKey"
      pattern: "getCreatorClaudeApiKey"
    - from: "instant.ts"
      to: "x402_resources"
      via: "Supabase query"
      pattern: "pt_system_prompt|pt_parameters"
---

<objective>
Build the server-side execution engine for prompt_template resources with Claude SDK streaming.

Purpose: When a caller hits `api.x402.jobs/@{username}/{slug}` for a prompt_template resource, the server substitutes parameters, calls Claude with the creator's API key, and streams the response back to the caller.

Output: Working prompt_template executor integrated into instant.ts with parameter substitution, streaming via SSE, validation, and error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-server-execution/03-RESEARCH.md

# From prior plan

@.planning/phases/03-server-execution/03-01-SUMMARY.md (getCreatorClaudeApiKey helper)

# Types from Phase 1

@src/types/prompt-template.ts
@src/lib/prompt-template-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK in x402-jobs-api</name>
  <files>x402-jobs-api/package.json</files>
  <action>
Install the Anthropic SDK in the x402-jobs-api backend:

```bash
cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api
npm install @anthropic-ai/sdk
```

This provides:

- TypeScript types for Claude API
- Streaming support via `client.messages.stream()`
- Proper error types and handling
  </action>
  <verify>
- `@anthropic-ai/sdk` appears in package.json dependencies
- `npm install` completes without errors
  </verify>
  <done>
  Anthropic SDK available for import in instant.ts.
  </done>
  </task>

<task type="auto">
  <name>Task 2: Add prompt_template executor to instant.ts</name>
  <files>x402-jobs-api/src/routes/instant.ts</files>
  <action>
Add prompt_template execution logic to the existing instant.ts route handler.

**IMPORTANT:** This is in x402-jobs-api, path:
`/Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api/src/routes/instant.ts`

Read the existing file to understand the structure, then add:

**1. Import Anthropic SDK at the top:**

```typescript
import Anthropic from "@anthropic-ai/sdk";
```

**2. Import the helper from integrations:**

```typescript
import { getCreatorClaudeApiKey } from "./integrations";
```

**3. Add parameter substitution function:**

```typescript
/**
 * Substitute {param}{/param} tags with provided values.
 * Does NOT substitute tags without matching values (leaves them as-is for validation).
 */
function substituteParameters(
  systemPrompt: string,
  parameters: Array<{ name: string; required: boolean; default?: string }>,
  providedValues: Record<string, string>,
): string {
  let result = systemPrompt;

  for (const param of parameters) {
    const value = providedValues[param.name] ?? param.default;
    if (value !== undefined) {
      // Replace {name}{/name} with the value
      const regex = new RegExp(`\\{${param.name}\\}\\{/${param.name}\\}`, "g");
      result = result.replace(regex, value);
    }
  }

  return result;
}
```

**4. Add validation function:**

```typescript
/**
 * Validate request parameters before execution (and payment).
 * Returns error message if invalid, null if valid.
 */
function validatePromptTemplateRequest(
  resource: {
    pt_parameters?: Array<{
      name: string;
      required: boolean;
      default?: string;
    }>;
    pt_allows_user_message?: boolean;
  },
  body: Record<string, unknown>,
): string | null {
  if (resource.pt_parameters) {
    for (const param of resource.pt_parameters) {
      const value = body[param.name];
      if (
        param.required &&
        (value === undefined || value === null || value === "")
      ) {
        if (!param.default) {
          return `Missing required parameter: ${param.name}`;
        }
      }
      // Validate type is string if provided
      if (value !== undefined && typeof value !== "string") {
        return `Parameter '${param.name}' must be a string`;
      }
    }
  }

  // Validate user_message if provided
  if (body.user_message !== undefined) {
    if (!resource.pt_allows_user_message) {
      return "This template does not accept user messages";
    }
    if (typeof body.user_message !== "string") {
      return "user_message must be a string";
    }
  }

  return null;
}
```

**5. Add streaming execution function:**

```typescript
/**
 * Execute prompt_template with streaming response via SSE.
 */
async function executePromptTemplateStreaming(
  res: Response,
  apiKey: string,
  systemPrompt: string,
  userMessage: string | undefined,
  maxTokens: number,
  model: string,
): Promise<void> {
  const client = new Anthropic({ apiKey });

  // Set SSE headers
  res.setHeader("Content-Type", "text/event-stream");
  res.setHeader("Cache-Control", "no-cache");
  res.setHeader("Connection", "keep-alive");
  res.flushHeaders();

  // Build messages array - Claude requires at least one user message
  const messages: Anthropic.MessageParam[] = userMessage
    ? [{ role: "user", content: userMessage }]
    : [
        {
          role: "user",
          content: "Please respond based on the system instructions.",
        },
      ];

  try {
    const stream = client.messages.stream({
      model,
      max_tokens: maxTokens,
      system: systemPrompt,
      messages,
    });

    // Stream text deltas to client
    for await (const event of stream) {
      if (event.type === "content_block_delta") {
        const delta = event.delta as { type: string; text?: string };
        if (delta.type === "text_delta" && delta.text) {
          res.write(
            `data: ${JSON.stringify({ type: "text", content: delta.text })}\n\n`,
          );
        }
      }
    }

    // Send final message with token usage
    const finalMessage = await stream.finalMessage();
    res.write(
      `data: ${JSON.stringify({
        type: "done",
        usage: finalMessage.usage,
      })}\n\n`,
    );
  } catch (error) {
    // Send error event via SSE
    const message = error instanceof Error ? error.message : "Execution failed";
    res.write(
      `data: ${JSON.stringify({ type: "error", message: mapClaudeError(message) })}\n\n`,
    );
  }

  res.end();
}
```

**6. Add error mapping function:**

```typescript
/**
 * Map Claude API errors to user-friendly messages.
 */
function mapClaudeError(errorMessage: string): string {
  if (
    errorMessage.includes("invalid_api_key") ||
    errorMessage.includes("401")
  ) {
    return "The creator's API key is invalid. Please contact the template creator.";
  }
  if (errorMessage.includes("rate_limit") || errorMessage.includes("429")) {
    return "Rate limit exceeded. Please try again in a moment.";
  }
  if (errorMessage.includes("overloaded") || errorMessage.includes("529")) {
    return "Claude is currently overloaded. Please try again shortly.";
  }
  if (
    errorMessage.includes("context_length") ||
    errorMessage.includes("too long")
  ) {
    return "Input too long for this template. Please reduce your input size.";
  }
  // Generic error - don't expose internal details
  return "Execution failed. Please try again.";
}
```

**7. Integrate into the main route handler:**
Find the switch/if-else that handles different resource_type values. Add a case for "prompt_template":

```typescript
// Inside the main route handler, after resource is loaded and validated
if (resource.resource_type === "prompt_template") {
  // Validate parameters BEFORE payment
  const validationError = validatePromptTemplateRequest(resource, req.body);
  if (validationError) {
    return res.status(400).json({ error: validationError });
  }

  // Check for owner test mode (bypass payment)
  const isOwnerTest =
    req.headers["x-owner-test"] === "true" &&
    req.user?.id === resource.server?.registered_by;

  // If not owner test, payment would be verified here (existing x402 flow)
  // For now, continue to execution

  // Get creator's Claude API key
  const creatorId = resource.server?.registered_by;
  if (!creatorId) {
    return res.status(500).json({ error: "Resource configuration error" });
  }

  const apiKey = await getCreatorClaudeApiKey(creatorId);
  if (!apiKey) {
    return res
      .status(500)
      .json({
        error: "Template creator has not configured their Claude API key",
      });
  }

  // Substitute parameters
  const substitutedPrompt = substituteParameters(
    resource.pt_system_prompt,
    resource.pt_parameters || [],
    req.body as Record<string, string>,
  );

  // Execute with streaming
  await executePromptTemplateStreaming(
    res,
    apiKey,
    substitutedPrompt,
    req.body.user_message as string | undefined,
    resource.pt_max_tokens || 4096,
    resource.pt_model || "claude-sonnet-4-20250514",
  );

  return; // Response already sent via streaming
}
```

**8. Ensure pt\_ fields are selected in resource query:**
Find the resource SELECT query and ensure it includes all pt\_ fields:

```sql
pt_system_prompt, pt_parameters, pt_model, pt_max_tokens, pt_allows_user_message
```

  </action>
  <verify>
- Anthropic SDK is imported
- substituteParameters function exists and handles {param}{/param} syntax
- validatePromptTemplateRequest function validates before execution
- executePromptTemplateStreaming function streams via SSE
- mapClaudeError function converts errors to user-friendly messages
- prompt_template case integrated into main route handler
- Owner test mode supported via X-OWNER-TEST header
- TypeScript compiles without errors
  </verify>
  <done>
Prompt template execution engine complete:
- Parameter substitution working
- Validation before payment
- Streaming via SSE
- Error mapping
- Owner test mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build and test execution flow</name>
  <files>x402-jobs-api/</files>
  <action>
Build the x402-jobs-api to verify everything compiles:

```bash
cd /Users/rawgroundbeef/Projects/memeputer/apps/x402-jobs-api
npm run build
```

If there are type errors, fix them. Common issues:

- Missing type imports
- Incorrect Response type (use Express.Response not global Response)
- Stream event typing

Verify the flow conceptually:

1. Request comes to /@{username}/{slug}
2. Resource loaded, type is "prompt_template"
3. Parameters validated (EXEC-02)
4. Owner test check (CRTR-09)
5. Creator's API key fetched and decrypted (EXEC-03)
6. Parameters substituted (EXEC-01)
7. Claude API called with streaming (EXEC-04)
8. Response streamed to caller (EXEC-05)
9. Errors mapped to friendly messages (EXEC-06)
   </action>
   <verify>

- `npm run build` succeeds
- No TypeScript errors
- All EXEC-\* requirements addressed in code
  </verify>
  <done>
  Build passes and execution flow implements all Phase 3 requirements:
- EXEC-01: Parameter substitution
- EXEC-02: Validation before payment
- EXEC-03: API key decryption
- EXEC-04: Claude SDK call
- EXEC-05: Streaming response
- EXEC-06: Error mapping
- CRTR-09: Owner test mode
  </done>
  </task>

</tasks>

<verification>
1. `@anthropic-ai/sdk` in package.json
2. `npm run build` passes in x402-jobs-api
3. prompt_template case in instant.ts route handler
4. substituteParameters handles {param}{/param} syntax
5. validatePromptTemplateRequest rejects missing required params
6. executePromptTemplateStreaming sends SSE events
7. mapClaudeError returns user-friendly messages
8. Owner can test with X-OWNER-TEST header
</verification>

<success_criteria>

- Anthropic SDK installed
- TypeScript compiles without errors
- All EXEC-\* requirements implemented
- CRTR-09 (creator testing) implemented
- Ready for integration testing once migration applied
  </success_criteria>

<output>
After completion, create `.planning/phases/03-server-execution/03-02-SUMMARY.md`
</output>
